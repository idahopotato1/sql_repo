
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://pgv0117ab.safeway.com/users/wzhu004/site/index.html/translating_sql/">
      
      
        <link rel="prev" href="../decision_making_algorithm/">
      
      
      <link rel="icon" href="../assets/logo.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.9">
    
    
      
        <title>SQL Intepretation - Snowflake EDM SQL Repository</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0d440cfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-do-we-translate-user-inputs-into-sql" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Snowflake EDM SQL Repository" class="md-header__button md-logo" aria-label="Snowflake EDM SQL Repository" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Snowflake EDM SQL Repository
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SQL Intepretation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Snowflake EDM SQL Repository" class="md-nav__button md-logo" aria-label="Snowflake EDM SQL Repository" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    Snowflake EDM SQL Repository
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../merch_sql/" class="md-nav__link">
        Merch SQL Repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../supplychain_sql/" class="md-nav__link">
        Supply Chain SQL Repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../operation_sql/" class="md-nav__link">
        Operation SQL Repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pricing_execution/" class="md-nav__link">
        Pricing Execution
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../db2/" class="md-nav__link">
        DB2 Repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        Azure
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../python_code/" class="md-nav__link">
        Python
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../decision_making_algorithm/" class="md-nav__link">
        Decision Making
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          SQL Intepretation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        SQL Intepretation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-do-we-translate-user-inputs-into-sql" class="md-nav__link">
    how do we translate user inputs into sql.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#translate-nlp-to-sql" class="md-nav__link">
    translate NLP to sql
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-complex-example-of-nlp-to-sql" class="md-nav__link">
    more complex example of NLP to SQL
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-do-we-translate-user-inputs-into-sql" class="md-nav__link">
    how do we translate user inputs into sql.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#translate-nlp-to-sql" class="md-nav__link">
    translate NLP to sql
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-complex-example-of-nlp-to-sql" class="md-nav__link">
    more complex example of NLP to SQL
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>SQL Intepretation</h1>

<h4 id="how-do-we-translate-user-inputs-into-sql">how do we translate user inputs into sql.<a class="headerlink" href="#how-do-we-translate-user-inputs-into-sql" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">Float</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="c1"># create a SQLAlchemy engine</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///example.db&#39;</span><span class="p">)</span>

<span class="c1"># create a session factory</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># create a base class for our models</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="c1"># define the model classes</span>
<span class="k">class</span> <span class="nc">Sales</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;sales&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">upc_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">txn_dte</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span>
    <span class="n">sales</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">store_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Store</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;stores&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">store_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">division_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Calendar</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;calendar&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">txn_dte</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span>
    <span class="n">week_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

<span class="c1"># create the tables in the database</span>
<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># get user input</span>
<span class="n">select_columns</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter columns to SELECT separated by commas (e.g. &#39;sales, stores.division_id, calendar.week_id&#39;): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="n">group_by_columns</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter columns to GROUP BY separated by commas (e.g. &#39;stores.division_id, calendar.week_id&#39;): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter start date (YYYY-MM-DD): &quot;</span><span class="p">)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter end date (YYYY-MM-DD): &quot;</span><span class="p">)</span>
<span class="n">division_id</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter division ID (leave blank for all): &quot;</span><span class="p">)</span>
<span class="n">store_id</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter store ID (leave blank for all): &quot;</span><span class="p">)</span>
<span class="n">upc_id</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter UPC ID (leave blank for all): &quot;</span><span class="p">)</span>

<span class="c1"># create a session</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

<span class="c1"># build the query based on user input</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">Sales</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">select_columns</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Store</span><span class="p">,</span> <span class="n">Calendar</span><span class="p">]</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">)])</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Store</span><span class="p">,</span> <span class="n">Sales</span><span class="o">.</span><span class="n">store_id</span> <span class="o">==</span> <span class="n">Store</span><span class="o">.</span><span class="n">store_id</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Calendar</span><span class="p">,</span> <span class="n">Sales</span><span class="o">.</span><span class="n">txn_dte</span> <span class="o">==</span> <span class="n">Calendar</span><span class="o">.</span><span class="n">txn_dte</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">group_by_columns</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Sales</span><span class="p">,</span> <span class="n">Store</span><span class="p">,</span> <span class="n">Calendar</span><span class="p">]</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">)])</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Sales</span><span class="o">.</span><span class="n">txn_dte</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">))</span>
<span class="k">if</span> <span class="n">division_id</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Store</span><span class="o">.</span><span class="n">division_id</span> <span class="o">==</span> <span class="n">division_id</span><span class="p">)</span>
<span class="k">if</span> <span class="n">store_id</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Sales</span><span class="o">.</span><span class="n">store_id</span> <span class="o">==</span> <span class="n">store_id</span><span class="p">)</span>
<span class="k">if</span> <span class="n">upc_id</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Sales</span><span class="o">.</span><span class="n">upc_id</span> <span class="o">==</span> <span class="n">upc_id</span><span class="p">)</span>

<span class="c1"># execute the query</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># print the results</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<h4 id="translate-nlp-to-sql">translate NLP to sql<a class="headerlink" href="#translate-nlp-to-sql" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">spacy</span>

<span class="c1"># load the spaCy English model</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>

<span class="c1"># define a dictionary to map natural language keywords to column names</span>
<span class="n">column_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sales&#39;</span><span class="p">:</span> <span class="s1">&#39;sales&#39;</span><span class="p">,</span>
    <span class="s1">&#39;division&#39;</span><span class="p">:</span> <span class="s1">&#39;stores.division_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;store&#39;</span><span class="p">:</span> <span class="s1">&#39;sales.store_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;upc&#39;</span><span class="p">:</span> <span class="s1">&#39;sales.upc_id&#39;</span>
<span class="p">}</span>

<span class="c1"># get user input</span>
<span class="n">input_text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter a natural language query (e.g. &#39;sales by division in January 2022&#39;): &quot;</span><span class="p">)</span>

<span class="c1"># parse the input using spaCy</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>

<span class="c1"># extract relevant keywords</span>
<span class="n">select_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">group_by_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="ow">in</span> <span class="n">column_map</span><span class="p">:</span>
        <span class="n">select_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_map</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">text</span><span class="p">])</span>
        <span class="n">group_by_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_map</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">text</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;by&#39;</span><span class="p">:</span>
        <span class="c1"># ignore &quot;by&quot; in the input</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">ent_type_</span> <span class="o">==</span> <span class="s1">&#39;DATE&#39;</span><span class="p">:</span>
        <span class="c1"># assume any entity of type DATE is a date range</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; to &#39;</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">date_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;txn_dte&#39;</span><span class="p">,</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">]))</span>

<span class="c1"># create a session</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

<span class="c1"># build the query based on the extracted keywords</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">Sales</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">select_columns</span><span class="p">])</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Store</span><span class="p">,</span> <span class="n">Sales</span><span class="o">.</span><span class="n">store_id</span> <span class="o">==</span> <span class="n">Store</span><span class="o">.</span><span class="n">store_id</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">Sales</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">group_by_columns</span><span class="p">])</span>
<span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">Sales</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">operator</span><span class="p">)(</span><span class="o">*</span><span class="n">values</span><span class="p">))</span>

<span class="c1"># execute the query</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># print the results</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<h3 id="more-complex-example-of-nlp-to-sql">more complex example of NLP to SQL<a class="headerlink" href="#more-complex-example-of-nlp-to-sql" title="Permanent link">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">from</span> <span class="nn">spacy.symbols</span> <span class="kn">import</span> <span class="n">nsubj</span><span class="p">,</span> <span class="n">pobj</span><span class="p">,</span> <span class="n">dobj</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">Float</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="c1"># create a SQLAlchemy engine</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///example.db&#39;</span><span class="p">)</span>

<span class="c1"># create a session factory</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># create a base class for our models</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="c1"># define the model classes</span>
<span class="k">class</span> <span class="nc">Sales</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;sales&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">upc_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">txn_dte</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span>
    <span class="n">sales</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">store_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Store</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;stores&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">store_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">division_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Calendar</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;calendar&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">txn_dte</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span>
    <span class="n">week_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

<span class="c1"># create the tables in the database</span>
<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># load the spaCy English model</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>

<span class="c1"># define the named entity labels</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DIVISION&#39;</span><span class="p">,</span> <span class="s1">&#39;STORE&#39;</span><span class="p">,</span> <span class="s1">&#39;DATE_RANGE&#39;</span><span class="p">}</span>

<span class="c1"># define a dictionary to map named entities to column names</span>
<span class="n">column_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DIVISION&#39;</span><span class="p">:</span> <span class="s1">&#39;stores.division_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;STORE&#39;</span><span class="p">:</span> <span class="s1">&#39;sales.store_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DATE_RANGE&#39;</span><span class="p">:</span> <span class="s1">&#39;sales.txn_dte&#39;</span>
<span class="p">}</span>

<span class="c1"># define the expected query components and their corresponding dependency tags</span>
<span class="n">query_components</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;SELECT&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nsubj&#39;</span><span class="p">,</span> <span class="s1">&#39;dobj&#39;</span><span class="p">},</span>
    <span class="s1">&#39;FROM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pobj&#39;</span><span class="p">},</span>
    <span class="s1">&#39;WHERE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nsubj&#39;</span><span class="p">,</span> <span class="s1">&#39;dobj&#39;</span><span class="p">,</span> <span class="s1">&#39;pobj&#39;</span><span class="p">},</span>
    <span class="s1">&#39;GROUP BY&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pobj&#39;</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># get user input</span>
<span class="n">input_text</span> <span class="o">=</span> <span class="s2">&quot;get total sales in division 19 and store 101 from 202001 to 202004&quot;</span>

<span class="c1"># parse the input using spaCy</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>

<span class="c1"># extract the named entities and their labels</span>
<span class="n">named_entities</span> <span class="o">=</span> <span class="p">{</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span> <span class="k">if</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>

<span class="c1"># extract the query components and their dependencies</span>
<span class="n">query_dependencies</span> <span class="o">=</span> <span class="p">{</span><span class="n">chunk</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">chunk</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dep_</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">noun_chunks</span> <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">in</span> <span class="n">query_components</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>

<span class="c1"># map the named entities to the appropriate SQL columns</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_map</span><span class="p">[</span><span class="n">named_entities</span><span class="p">[</span><span class="n">text</span><span class="p">]]</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">named_entities</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

<span class="c1"># construct the SQL query based on the extracted components and named entities</span>
<span class="n">select</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<span class="n">from_table</span> <span class="o">=</span> <span class="s1">&#39;sales JOIN stores ON sales.store_id = stores.store_id&#39;</span>
<span class="n">where_conditions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">group_by_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">query_dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">dep</span> <span class="o">==</span> <span class="s1">&#39;nsubj&#39;</span><span class="p">:</span>
        <span class="n">where_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column_map</span><span class="p">[</span><span class="n">named_entities</span><span class="p">[</span><span class="n">text</span><span class="p">]]</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dep</span> <span class="o">==</span> <span class="s1">&#39;dobj&#39;</span><span class="p">:</span>
        <span class="n">where_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column_map</span><span class="p">[</span><span class="n">named_entities</span><span class="p">[</span><span class="n">text</span><span class="p">]]</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">group_by_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_map</span><span class="p">[</span><span class="n">named_entities</span><span class="p">[</span><span class="n">text</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="n">dep</span> <span class="o">==</span> <span class="s1">&#39;pobj&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;from&#39;</span><span class="p">:</span>
            <span class="n">from_table</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lemma_</span> <span class="o">+</span> <span class="s1">&#39;_table&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column_map</span><span class="p">[</span><span class="n">named_entities</span><span class="p">[</span><span class="n">text</span><span class="p">]]</span><span class="si">}</span><span class="s2"> BETWEEN </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> AND </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">group_by_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_map</span><span class="p">[</span><span class="n">named_entities</span><span class="p">[</span><span class="n">text</span><span class="p">]])</span>
<span class="n">where_clause</span> <span class="o">=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_conditions</span><span class="p">)</span>
<span class="n">group_by</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_by_columns</span><span class="p">)</span>

<span class="n">sql_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">select</span><span class="si">}</span><span class="s2"> FROM </span><span class="si">{</span><span class="n">from_table</span><span class="si">}</span><span class="s2"> WHERE </span><span class="si">{</span><span class="n">where_clause</span><span class="si">}</span><span class="s2"> GROUP BY </span><span class="si">{</span><span class="n">group_by</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)</span>

<span class="c1"># create a session</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

<span class="c1"># execute the SQL query</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)</span>

<span class="c1"># calculate the total sales</span>
<span class="n">total_sales</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>

<span class="c1"># print the total sales</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total sales in division 19 and store 101 from 202001 to 202004: </span><span class="si">{</span><span class="n">total_sales</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>To structure the NLP model to handle a user input like &quot;get total sales in division 19 and store 101 from 202001 to 202004&quot;, you can use a combination of named entity recognition (NER) and dependency parsing to extract the relevant information from the input and map it to the appropriate SQL query.

Here&#39;s a high-level overview of the steps you could take:

Define a set of labels for the named entities you want to extract, such as DIVISION, STORE, and DATE_RANGE.

Use a NER model to extract the named entities from the input text and classify them with the appropriate label.

Use dependency parsing to extract the relationships between the named entities and the query components they correspond to, such as SELECT, FROM, WHERE, and GROUP BY.

Use the named entities and dependency parsing results to construct the SQL query, including the appropriate columns to select, tables to join, and filter conditions to apply.

In this continuation, we use the named entities and dependency parsing results to construct the SQL query. We first map the named entities to the appropriate SQL columns using a column_map dictionary.

We then extract the query components and their dependencies, and construct the SELECT, FROM, WHERE, and GROUP BY clauses of the SQL query based on the corresponding dependencies. We also extract the date range filter and add it to the WHERE clause.

Finally, we execute the SQL query and calculate the total sales using a list comprehension and the built-in sum function. We then print the total sales to the console.

Note that in this example, we assume that the Sales and Store tables have the necessary columns. You may need to modify the query to join additional tables or filter on other columns as necessary.
</code></pre></div></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.a00a7c5e.min.js"></script>
      
    
  </body>
</html>