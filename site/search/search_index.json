{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Snowflake LDW to EDM Transition","text":""},{"location":"#this-is-the-place-where-we-share-learn-and-collaborate-with-each-other","title":"This is the place where we share, learn and collaborate with each other","text":""},{"location":"azure/","title":"Azure","text":""},{"location":"azure/#azure-sql","title":"AZURE SQL","text":""},{"location":"azure/#presentation-stock-change","title":"Presentation Stock Change","text":"<pre><code>SELECT mpi.division_id, mpi.district_cd, mpi.store, mpi.upc, mpi.item_desc, mpi.user_id, mpi.business_date, spi.start_pi, epi.end_pi, mpi.pi_change\nFROM (\nSELECT DISTINCT str.division_id, str.district_cd, store, upc, item_desc, user_id, business_date, SUM(pi_change) AS pi_change\nFROM scmrep.store_manual_pi mpi\nINNER JOIN scmrep.lu_store_finance_om str ON str.store_id = mpi.store\nINNER JOIN scmrep.lu_day_merge dy ON dy.d_date = mpi.business_date\nWHERE dy.week_id between 202201 and 202253\n--AND mpi.upc IN ${hivevar:upc}\nAND str.store_id = 177\nGROUP BY str.division_id, str.district_cd, store, upc, item_desc, user_id, business_date) mpi\nINNER JOIN (\nSELECT store, upc, user_id, business_date, start_pi, adjustment_timestamp,\nROW_NUMBER() OVER (PARTITION BY store, upc, user_id, business_date ORDER BY adjustment_timestamp ASC) AS rn\nFROM scmrep.store_manual_pi mpi\nINNER JOIN scmrep.lu_store_finance_om str ON str.store_id = mpi.store\nINNER JOIN scmrep.lu_day_merge dy ON dy.d_date = mpi.business_date\nWHERE dy.week_id between 202201 and 202253\n-- AND mpi.upc IN ${hivevar:upc}\nAND str.store_id = 177\n) spi ON mpi.store = spi.store AND mpi.upc = spi.upc AND mpi.user_id = spi.user_id AND mpi.business_date = spi.business_date AND spi.rn = 1\nINNER JOIN (\nSELECT store, upc, user_id, business_date, end_pi, adjustment_timestamp,\nROW_NUMBER() OVER (PARTITION BY store, upc, user_id, business_date ORDER BY adjustment_timestamp DESC) AS rn\nFROM scmrep.store_manual_pi mpi\nINNER JOIN scmrep.lu_store_finance_om str ON str.store_id = mpi.store\nINNER JOIN scmrep.lu_day_merge dy ON dy.d_date = mpi.business_date\nWHERE dy.week_id between 202201 and 202253\n--  AND mpi.upc IN ${hivevar:upc}\nAND str.store_id = 177\n) epi ON mpi.store = epi.store AND mpi.upc = epi.upc AND mpi.user_id = epi.user_id AND mpi.business_date = epi.business_date AND epi.rn = 1\n</code></pre>"},{"location":"azure/#warehouse-to-store-order-history","title":"Warehouse to Store Order History","text":"<pre><code>SELECT store.division_id, dept_section_id, store.district_cd, store.store_id, dtl.orig_cic_id, cic.internet_item_dsc, chrono.week_id,\nSUM(CASE WHEN hdr.order_type_cd = 'FAR' THEN 1 ELSE 0 END) AS far_order_count,\nSUM(CASE WHEN hdr.order_type_cd = 'FAR' THEN COALESCE(dtl.order_qty, COALESCE(dtl.exe_demand_qty, 0)) ELSE 0 END) AS far_cases_ordered,\nSUM(CASE WHEN hdr.order_type_cd = 'FAR' THEN COALESCE(dtl.exe_ship_qty, COALESCE(dtl.modify_qty, 0)) ELSE 0 END) AS far_cases_shipped,\nSUM(CASE WHEN NOT hdr.order_type_cd = 'FAR' THEN 1 ELSE 0 END) AS store_add_count,\nSUM(CASE WHEN NOT hdr.order_type_cd = 'FAR' THEN COALESCE(dtl.order_qty, COALESCE(dtl.exe_demand_qty, 0)) ELSE 0 END) AS store_add_cases_ordered,\nSUM(CASE WHEN NOT hdr.order_type_cd = 'FAR' THEN COALESCE(dtl.exe_ship_qty, COALESCE(dtl.modify_qty, 0)) ELSE 0 END) AS store_add_cases_shipped,\nSUM(COALESCE(dtl.firm_order_qty, 0)) AS firm_qty\nFROM scmrep.ov_order_hdr_hist hdr\nINNER JOIN scmrep.lu_day_merge chrono ON chrono.d_date = hdr.schedule_delivery_dt\nINNER JOIN scmrep.lu_store_finance_om store ON store.store_id = hdr.dest_facility_id\nINNER JOIN scmrep.ov_order_dtl_hist dtl ON dtl.order_hdr_sk = hdr.order_hdr_sk AND dtl.order_dt = hdr.order_dt\nINNER JOIN (SELECT DISTINCT dept_section_id, CAST(corp_item_cd AS BIGINT) AS corp_item_cd, internet_item_dsc FROM scmrep.lu_cic) cic ON cic.corp_item_cd = dtl.orig_cic_id\nWHERE store.division_id = 30\nAND store.store_id = 177\nAND chrono.week_id IN (select week_id from scmrep.lu_day_merge where d_date = current_date group by 1)\nAND cic.dept_section_id IN (301, 302, 313, 318, 327, 335, 338, 314, 323, 324, 325, 317)\nGROUP BY store.division_id, dept_section_id, store.district_cd, store.store_id, dtl.orig_cic_id, cic.internet_item_dsc, chrono.week_id\nORDER BY store.division_id, dept_section_id, store.district_cd, store.store_id, dtl.orig_cic_id, cic.internet_item_dsc, chrono.week_id\n</code></pre>"},{"location":"azure/#store-order-and-polltime","title":"Store Order and polltime","text":"<pre><code>select distinct\nstr.loadid,\nstr.ordertype,\nstr.divisionid,\nstr.districtid,\nstr.storeid,\ncic.u_section,\nstr.polltimestamp,\nstr.corporationitemcode,\nstr.upc,\nstr.corporationitemcode,\ncic.descr,\nstr.itemorderqtyeaches,\nstr.itemorderqtywhseunits\nfrom scmrep.inbound_from_jda_storeorder str\n--join scmrep.corporate_item itm\n--on itm.corporate_item_cd = str.corporationitemcode\njoin scmrep.jda_cic cic\non cic.u_cic_code =  str.corporationitemcode\njoin scmrep.jda_assortment ast\non ast.u_cic_code = str.corporationitemcode\nwhere cast(str.POLLTIMESTAMP as date) = '2022-08-15'\nand str.STOREID in ('0177')\nand u_data_batch_cd in ('0117','0170','0119','0101','0168','0123','0133','0135')\n</code></pre>"},{"location":"azure/#tag-subscription","title":"Tag Subscription","text":"<pre><code>SELECT DISTINCT\nTAG.DEPT_SECTION_ID\n, TAG.CORP_ITEM_CD\n, UPC_ID, CIC.INTERNET_ITEM_DSC\n, CIC.PACK_WHSE_QTY\n, CIC. NUMERIC_SIZE_QTY\n, CIC.SIZE_UOM_CD\n, TAG.LOC_ID\n, TAG.AISLE_NBR\n, TAG.SECT_NBR\n, TAG.SHELF_CD\n, max(source_last_updt_ts)\nFROM SCMREP.TAG_SUBSCRIPTION TAG\nJOIN SCMREP.LU_CIC CIC\nON CIC.CORP_ITEM_CD = TAG.CORP_ITEM_CD\nWHERE TAG.STORE_ID = 177\n--and source_last_updt_ts = max(source_last_updt_ts)\n--and corp_item_cd in (9900038,9014962,2011658,2020403,9152218,2900013,9151571,2020809,9014972,9150355,2020043,9050236,2010741,2011796,9101008,9012301,2011525,9014255,9011118,9010943,9050117,9100566,2020253,9150899,9050313,9150693,9015920,9014968,9018498,30031468,30010042,30040061,30030416,30010902,74401173,30030578,30030130,30010051,30010903,30030470,30031225,74400906,30040094,30030955,88660894,88661232,88290110,88661616,86930414,84740054,38450027,39500369,38250451,38250151,39550022,38250149,38250095,74450602,74500019,74450190,1050525,1014390,1050088,1050721,1052303,1050659,1050173,1050163,1050089,1054026,1056324,1052400,1050253,1050707,1051599,1060873,1054601,1059634,1051089,1051172,1052352,1052678,1058988,1055451,1050258,1011222,1056317,1059564,1011272,1050015,1059025,1061149,1055443,1056322,1061151,1053679,1051102,1052062,1050643,42050710,42050332,42011366,48050110,42200044,47050674,42011754,42100034,48200224,48100252,42200070,48020113,45010196,48010184,42200067,47050173,48050107,42050640,48011217,42011102,42011717,42050970,42052001,42011141,42050022,42050360,48040124,48020437,45010315,47010663,48050157,48050030,48013414,42051549,48100302,42050018,42051591,42011032,42051601,42052064,48050082,42012037,42050334,42050476,42051022,36150034,36450227,36304174,36300150,36301337,36100051,36302913,36050352,36100369,36050095,36050275,36050359,3300349,8051060,3300403,8050980,3200792,3200255,3300398,8050230,3250537,3200781,8010404,3200137,3200217,3200086,3200662,3100363,3250239,8100081,8200213,3300570,8250009,3200136,3300346,3300338,3100295,3100116,3300327,3350154,8100086,8150129,8100052,8010933,3200804,8200035,3200471,3100294,74100627,75800302,75800274,28350414,13100090,7150016,28202443,25100014,15200001,22400027,25100225,13450001,15100351,13010071,4050054,25100155,25100129,23010838,6041112,22500021,13050220,22010059,28350494,22200016,5850056,22100290,4100012,7050005,7150017,13150320,15150070,25050142,23010217,25100051,24010025,25100028,23010629,22400013,5250237,14151944,6041109,4100133,5850133,6040263,4100063,28200382,13500347,14150407,17200143,4050192,4050297,28350231,14201304,7200109,25300068,21300226,13050184,5300152,13050173,14200364,14200398,15200117,7050018,15200002,5201193,5400690,28350026,14200565,13500345,14150405,28200289,22150044,7010372,14250040,25150014,6060157,11011247,20020071,19010837,27050488,27050300,20020953,20070078,26330194,11010589,20070186,20080005,11010416,20030006,20020555,11010941,19020024,11100311,19090116,11014456,11101807,26321114,20070546,20070535,20030051,26250271,11010990,26250168,20060257,20070305,20060274,20030258,10050779,19150399,26320364,11101906,20060101,19030930,20020277,19031680,20070138,20070070,11100057,26150184,20010028,19050746,27101512,19030452,20050417,20070059,20060420,20020028,29011108,26400505\n\n--)\nand TAG.DEPT_SECTION_ID in (301,302,313,318,327,335,338,314,323,324,325,317,311,312,322)\ngroup by\nTAG.DEPT_SECTION_ID\n, TAG.CORP_ITEM_CD\n, UPC_ID, CIC.INTERNET_ITEM_DSC\n, CIC.PACK_WHSE_QTY\n, CIC. NUMERIC_SIZE_QTY\n, CIC.SIZE_UOM_CD\n, TAG.LOC_ID\n, TAG.AISLE_NBR\n, TAG.SECT_NBR\n, TAG.SHELF_CD\n</code></pre>"},{"location":"azure/#order-closed-in-route-to-stores","title":"Order Closed in Route to Stores","text":"<pre><code>select\nhdr.order_dt\n, hdr.com_received_ts\n, hdr.com_extract_ts\n, hdr.schedule_cutoff_ts\n, hdr.bomb_dt\n, hdr.schedule_pick_dt\n, hdr.com_schedule_delivery_dt\n, hdr.schedule_delivery_dt\n, hdr.inv_billing_dt\n, hdr.inv_dt\n, hdr.order_hdr_sk\n, hdr.dest_div_nbr\n, hdr.rog_cd\n, hdr.dest_facility_id  -- 4-character store number\n, hdr.ship_div_nbr\n, hdr.ship_facility_id  -- warehouse code\n, hdr.order_nbr\n, hdr.inv_nbr\n, hdr.register_id\n, hdr.com_order_nbr\n, hdr.exe_order_nbr\n, hdr.order_type_cd\n, hdr.order_sts_cd\n, dtl.orig_cic_id\n, dtl.upc_cntry_id\n, dtl.upc_sys_id\n, dtl.upc_manuf_id\n, dtl.upc_sales_id\n, dtl.item_dsc\n, dtl.order_qty\n, dtl.exe_ship_qty\nfrom scmrep.ov_order_hdr_hist hdr\njoin scmrep.ov_order_dtl_hist dtl\non dtl.order_dt = hdr.order_dt\nand dtl.order_hdr_sk = hdr.order_hdr_sk\nwhere\nhdr.dest_facility_id = '0161'   -- 4-character store number\nand hdr.delivery_dt = current_date\nand dtl.orig_cic_id = 36300065\n</code></pre>"},{"location":"azure/#store-current-pi","title":"Store Current PI","text":"<pre><code>SELECT DISTINCT\nU_STORE,\nUPC.DEPT_SECTION_ID,\nPI.AVAILDATE,\nPI.U_CIC_CODE,\nUPC.UPC_ID,\nUPC.INTERNET_ITEM_DSC,\nPI.QTY,\nPI.U_PS_QTY,\nlast_updt_ts\nFROM HIVE_METASTORE.SCMREP.JDA_INVENTORY_STORE PI\nJOIN HIVE_METASTORE.SCMREP.LU_UPC UPC\nON UPC.CORP_ITEM_CD = PI.U_CIC_CODE\njoin hive_metastore.scmrep.lu_store_finance_om str\non str.store_id = pi.u_store\nwhere AVAILDATE  =  CURRENT_DATE() -2\nand str.store_id = 3441\n</code></pre>"},{"location":"azure/#future-store-orders","title":"Future Store Orders","text":"<pre><code>select distinct\nstr.loadid,\nstr.ordertype,\nstr.divisionid,\nstr.districtid,\nstr.storeid,\ncic.u_section,\nstr.polltimestamp,\nstr.corporationitemcode,\nstr.upc,\nstr.corporationitemcode,\ncic.descr,\nstr.itemorderqtyeaches,\nstr.itemorderqtywhseunits\nfrom scmrep.inbound_from_jda_storeorder str\n--join scmrep.corporate_item itm\n--on itm.corporate_item_cd = str.corporationitemcode\njoin scmrep.jda_cic cic\non cic.u_cic_code =  str.corporationitemcode\njoin scmrep.jda_assortment ast\non ast.u_cic_code = str.corporationitemcode\nwhere cast(str.POLLTIMESTAMP as date) = '2022-08-15'\nand str.STOREID in ('0177')\nand u_data_batch_cd in ('0117','0170','0119','0101','0168','0123','0133','0135')\n--and u_data_batch_cd in ('0101')\n--select distinct u_data_batch_cd\n</code></pre>"},{"location":"db2/","title":"DB2 SQL","text":""},{"location":"db2/#all-items-with-vendor-contact","title":"All Items With Vendor Contact","text":"<pre><code>SELECT DISTINCT\nPG.PROMO_GRP_SK AS PG_ID,\nPG.PROMO_GRP_NM,\nPG.UNIT_TYP_CD AS UT,\nPG.PROMO_TYP_GRP_CD AS PGT,\nPG.DIV_ID AS DIV,\nwds.vend_num,\nCOALESCE(PDI.CORP_ITEM_CD, ITM.CORP_ITEM_CD) AS CIC_EXPECTED,\nCOALESCE(DLV.DEAL_VEND_NM,'') AS VENDOR,\nCOALESCE(PCG.DIV_PROMO_GRP_CD, 0) AS CIG,\nIRX.CORP_ITEM_CD AS CIC_FOUND,\nCASE\nWHEN PRI.BRKR_NM IS NULL THEN 'VC1'\nWHEN VC1.CONT_NM IS NULL THEN 'BR1'\nEND AS CONT1,\nCOALESCE(PRI.BRKR_NM,VC1.CONT_NM) AS PRIMARY_NM,\nCOALESCE\n(PRI.BRKR_EMAIL_TXT, VC1.CONT_EMAIL_TXT) AS PRIMARY_EMAIL,\nCOALESCE\n(SEC.BRKR_NM,VC2.CONT_NM, '') AS SECOND_NM,\nCOALESCE\n(SEC.BRKR_EMAIL_TXT,VC2.CONT_EMAIL_TXT, '') AS SECOND_EMAIL,\nCOALESCE\n(THD.BRKR_NM,VC3.CONT_NM, '') AS THIRD_NAME,\nCOALESCE\n(THD.BRKR_EMAIL_TXT,VC3.CONT_EMAIL_TXT, '') AS THIRD_EMAIL,\nPG.PROMO_GRP_SK AS PG_ID,\nPG.PROMO_GRP_NM\nFROM SQLDATA.PPAPPRGP_TABLE PG\n\nLEFT JOIN SQLDATA.PPAPPGC_TABLE JP\nON JP.PROMO_GRP_SK = PG.PROMO_GRP_SK\nAND JP.CONT_ROLE_NM = 'PRIMARY'\nLEFT JOIN SQLDATA.PPAPPBC_TABLE PRI\nON PRI.BRKR_CONT_SK = JP.BRKR_CONT_SK\nAND PRI.DIV_ID = PG.DIV_ID\nAND JP.VEND_CONT_SK = 0\nLEFT JOIN SQLDATA.PPAPDLVC_TABLE VC1\nON VC1.VEND_CONT_SK = JP.VEND_CONT_SK\nAND VC1.DIV_ID = PG.DIV_ID\nAND JP.BRKR_CONT_SK = 0\nLEFT JOIN SQLDATA.PPAPPGI_TABLE ITM\nON ITM.PROMO_GRP_SK = PG.PROMO_GRP_SK\nLEFT JOIN SQLDATA.PPAPPGCG_TABLE PCG\nON PCG.PROMO_GRP_SK = PG.PROMO_GRP_SK\nLEFT JOIN SQLDATA.PPAPPGC_TABLE JP2\nON JP2.PROMO_GRP_SK = PG.PROMO_GRP_SK\nAND JP2.CONT_ROLE_NM = 'SECONDARY'\nLEFT JOIN SQLDATA.PPAPPBC_TABLE SEC\nON SEC.BRKR_CONT_SK = JP2.BRKR_CONT_SK\nAND SEC.DIV_ID = PG.DIV_ID\nAND JP2.VEND_CONT_SK = 0\nLEFT JOIN SQLDATA.PPAPDLVC_TABLE VC2\nON VC2.VEND_CONT_SK = JP2.VEND_CONT_SK\nAND VC2.DIV_ID = PG.DIV_ID\nAND JP2.BRKR_CONT_SK = 0\nLEFT JOIN SQLDATA.PPAPPGC_TABLE JP3\nON JP3.PROMO_GRP_SK = PG.PROMO_GRP_SK\nAND JP3.CONT_ROLE_NM = 'TEAM LEAD'\nLEFT JOIN SQLDATA.PPAPPBC_TABLE THD\nON THD.BRKR_CONT_SK = JP3.BRKR_CONT_SK\nAND THD.DIV_ID = PG.DIV_ID\nAND JP3.VEND_CONT_SK = 0\nLEFT JOIN SQLDATA.PPAPDLVC_TABLE VC3\nON VC3.VEND_CONT_SK = JP3.VEND_CONT_SK\nAND VC3.DIV_ID = PG.DIV_ID\nAND JP3.BRKR_CONT_SK = 0\nLEFT JOIN SQLDATA.PPAPPDI_TABLE PDI\nON PDI.DIV_PROMO_GRP_CD = PCG.DIV_PROMO_GRP_CD\nAND PDI.DIVISION_ID = PCG.DIV_ID\nLEFT JOIN SQLDATA.PPAPDLV_TABLE DLV\nON DLV.DEAL_VEND_SK = PG.DEAL_VEND_SK\nLEFT JOIN SQLDAT3.SSITMCDS_TABLE ICD\nON ICD.CORP_ITEM_CD = PDI.CORP_ITEM_CD\nOR ICD.CORP_ITEM_CD = ITM.CORP_ITEM_CD\nLEFT JOIN SQLDATA.SSITMROG_TABLE IRG\nON IRG.CORP = '001'\n--AND (IRG.DIVISION = PG.DIV_ID OR IRG.DIVISION in ('32','99'))\nAND IRG.CORP_ITEM_CD = ICD.CORP_ITEM_CD\nLEFT JOIN SQLDATA.SSITMURX_TABLE IRX\nON IRX.CORP = IRG.CORP\nAND IRX.ROG = IRG.ROG\nAND IRX.CORP_ITEM_CD = IRG.CORP_ITEM_CD\nAND IRX.UNIT_TYPE = PG.UNIT_TYP_CD\nLEFT JOIN SQLDAT3.SSITMWDS WDS\nON wds.corp_item_cd = icd.corp_item_cd\nAND wds.division = pg.div_id\n--WHERE PG.DIV_ID in ('32','99')\n--And PG.PROMO_GRP_SK = '32'\nORDER BY 1, 7, 8\n</code></pre>"},{"location":"merch_sql/","title":"Merch SQL","text":""},{"location":"merch_sql/#hourly-sales","title":"Hourly Sales","text":"<pre><code>SELECT\nTRY_TO_NUMBER(LUS.DISTRICT_CD)::INTEGER AS DISTRICT_ID\n,HDR.STORE_ID\n,REF.RTL_DEPT_ID\n,LDAY.DAY_OF_FISCAL_WEEK_NBR AS WEEKDAY_NBR\n,HDR.TXN_DTE\n,EXTRACT(HOUR FROM HDR.TXN_TM) AS TXN_HOUR\n,SUM(ITM.NET_AMT) AS SALES\n,COUNT(DISTINCT HDR.TXN_ID) AS BASKETS\n\nFROM EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_HDR HDR\nINNER JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_ITEM ITM\nON HDR.TXN_DTE = ITM.TXN_DT\nAND HDR.TXN_ID = ITM.TXN_ID\nAND ITM.DTL_SUBTYPE_ID NOT IN (4)\nAND HDR.TXN_DTE BETWEEN '06/20/2021' AND '09/11/2021'\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE LUS\nON TRY_TO_NUMBER(LUS.RETAIL_STORE_FACILITY_NBR)::INTEGER = HDR.STORE_ID\nAND LUS.DIVISION_ID = '19'\nAND LUS.RETAIL_STORE_FACILITY_NBR NOT IN ('1542','4904')\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D0_FISCAL_DAY LDAY\nON LDAY.CALENDAR_DT = HDR.TXN_DTE\nINNER JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.DEPT_XREF REF\nON REF.TLOG_DEPT_ID = ITM.STORE_DEPT_ID\nAND HDR.STORE_ID = REF.STORE_ID\ngroup by 1,2,3,4,5,6;\n</code></pre>"},{"location":"merch_sql/#category-report-by-week","title":"Category Report by Week","text":"<pre><code>select\nFISCAL_WEEK_ID AS week_id,\nFISCAL_PERIOD_ID as PERIOD_ID,\nFISCAL_QUARTER_ID as QUARTER_ID,\nDivision_nm,\nDISTRICT_ID,\nRETAIL_STORE_FACILITY_NBR as STORE_ID,\ngroup_nm,\ncategory_id,\ncategory_nm,\nclass_id,\nclass_nm,\nsubclass_id,\nsubclass_nm,\nMANUF_TYPE_CD AS OWN_BRANDS,\nCORP_ITEM_CD as CIC_Code,\nupc_dsc,\nupc_nbr,\nSUM(TOTAL_NET_AMT) AS TOTAL_NET_AMT_TY,\nSUM(ITEM_QTY) AS ITEM_QTY_TY,\nSUM(COST_OF_GOODS_AMT) AS COST_OF_GOODS_AMT_TY,\nSUM(MEASURED_QTY) AS MEASURED_QTY_TY,\nSUM(AGP_EXTENDED_AMT) AS AGP_EXTENDED_AMT_TY,\ncast (0.00 as decimal (19,1))  AS TOTAL_NET_AMT_LY,\ncast (0.00 as decimal (19,1)) as ITEM_QTY_LY,\ncast (0.00 as decimal (19,1)) AS COST_OF_GOODS_AMT_LY,\ncast (0.00 as decimal (19,1)) AS MEASURED_QTY_LY,\ncast (0.00 as decimal (19,1)) AS AGP_EXTENDED_AMT_LY\n\n\nfrom\nEDM_VIEWS_PRD.\"DW_VIEWS\".\"STORE_UPC_AGP\" AGP\n\njoin \"EDM_VIEWS_PRD\".\"DW_VIEWS\".\"D1_RETAIL_STORE\" LUS\non AGP.FACILITY_INTEGRATION_ID = LUS.FACILITY_INTEGRATION_ID\n--AND lus.DIVISION_ID = 5\nand CLOSE_DT &gt; current_date\nand OPEN_DT &lt; (current_date)-365\nand agp.transaction_dt BETWEEN CURRENT_DATE -181 AND CURRENT_DATE-1 --full timeframe\n--and agp.transaction_dt = '04/05/2022'\n\njoin \"EDM_VIEWS_PRD\".\"DW_EDW_VIEWS\".\"LU_UPC\" UPC\non UPC_NBR = UPC_ID\nAND (CATEGORY_ID &lt;9900 OR (CATEGORY_ID IN (9902,9931,9932,9933,9934,9935,9937,9938,9939,9959,9961,9962,9963,9964,9966,9967,9968,9969,9972,9973,9974,9975,9976,9977,9978,9979,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,9995,9996,9997,9998,9999)))\nAND upc.DEPARTMENT_ID in (315,329)\nAND UPC.CORPORATION_ID = 1\n\njoin \"EDM_VIEWS_PRD\".\"DW_VIEWS\".\"D0_FISCAL_DAY\" LDAY\non TRANSACTION_DT = CALENDAR_DT\n\ngroup by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17\n\nunion all\n\nselect\nFISCAL_WEEK_ID + 100 AS week_id,\nFISCAL_PERIOD_ID + 100 as PERIOD_ID,\nFISCAL_QUARTER_ID + 100 as QUARTER_ID,\nDivision_nm,\nDISTRICT_ID,\nRETAIL_STORE_FACILITY_NBR as STORE_ID,\ngroup_nm,\ncategory_id,\ncategory_nm,\nclass_id,\nclass_nm,\nsubclass_id,\nsubclass_nm,\nmanuf_type_cd as OWN_BRANDS,\nCORP_ITEM_CD as CIC_Code,\nupc_dsc,\nupc_nbr,\ncast (0.00 as decimal (19,1))  AS TOTAL_NET_AMT_TY,\ncast (0.00 as decimal (19,1)) as ITEM_QTY_TY,\ncast (0.00 as decimal (19,1)) AS COST_OF_GOODS_AMT_TY,\ncast (0.00 as decimal (19,1)) AS MEASURED_QTY_TY,\ncast (0.00 as decimal (19,1)) AS AGP_EXTENDED_AMT_TY,\nSUM(TOTAL_NET_AMT) AS TOTAL_NET_AMT_LY,\nSUM(ITEM_QTY) AS ITEM_QTY_LY,\nSUM(COST_OF_GOODS_AMT) AS COST_OF_GOODS_AMT_LY,\nSUM(MEASURED_QTY) AS MEASURED_QTY_LY,\nSUM(AGP_EXTENDED_AMT) AS AGP_EXTENDED_AMT_LY\n\n\nfrom\nEDM_VIEWS_PRD.\"DW_VIEWS\".\"STORE_UPC_AGP\" AGP\n\njoin \"EDM_VIEWS_PRD\".\"DW_VIEWS\".\"D1_RETAIL_STORE\" LUS\non AGP.FACILITY_INTEGRATION_ID = LUS.FACILITY_INTEGRATION_ID\n\nand CLOSE_DT &gt; current_date\nand OPEN_DT &lt; (current_date)-365\nand agp.transaction_dt BETWEEN TO_DATE(CURRENT_DATE)-545 AND TO_DATE(CURRENT_DATE)-365 --full timeframe\n--and agp.transaction_dt = to_date('2022-04-05')-364\n\njoin \"EDM_VIEWS_PRD\".\"DW_EDW_VIEWS\".\"LU_UPC\" UPC\non UPC_NBR = UPC_ID\nAND (CATEGORY_ID &lt;9900 OR (CATEGORY_ID IN (9902,9931,9932,9933,9934,9935,9937,9938,9939,9959,9961,9962,9963,9964,9966,9967,9968,9969,9972,9973,9974,9975,9976,9977,9978,9979,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,9995,9996,9997,9998,9999)))\nAND upc.DEPARTMENT_ID in (315,329)\nAND UPC.CORPORATION_ID = 1\n\njoin \"EDM_VIEWS_PRD\".\"DW_VIEWS\".\"D0_FISCAL_DAY\" LDAY\non TRANSACTION_DT = CALENDAR_DT\n\ngroup by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17\n</code></pre>"},{"location":"merch_sql/#store-sales-by-quarter-period-department-item","title":"Store Sales by Quarter Period Department Item","text":"<pre><code>SELECT\nPD.FISCAL_PERIOD_NBR AS PERIOD,         --LU.PERIOD_ID as PERIOD,\nPD.FISCAL_QUARTER_NBR AS QUARTER,                  --LU.QUARTER_ID as QUARTER,\nSTR.DISTRICT_CD AS DISTRICT,            --STR.DISTRICT_CD AS DISTRICT,\nSTR.RETAIL_STORE_FACILITY_NBR AS STORE,            --STR.STORE_ID AS STORE,\nROG.DEPARTMENT_ID ||' '||ROG.SMIC_GROUP_DSC AS DEPARTMENT,         --ITM.DEPARTMENT_ID ||' '||ITM.DEPARTMENT_NM AS DEPARTMENT,\nROG.CATEGORY_ID||' '||ROG.SMIC_CATEGORY_DSC AS CATEGORY,            --ITM.CATEGORY_ID ||' '|| ITM.CATEGORY_NM AS CATEGORY,\nROG.CLASS_ID||' '||ROG.SMIC_CLASS_DSC AS CLASS,            --ITM.CLASS_ID ||' '|| ITM.CLASS_NM AS CLASS,\nTXN.UPC_ID||' '||CI.ITEM_DSC||' - CIC '||CI.CORPORATE_ITEM_CD AS DESCRIPTION,            --ITM.UPC_ID ||' '|| ITM.UPC_DSC ||' - CIC '||ITM.CORP_ITEM_CD AS DESCRIPTION,\nSUM(TXN.NET_AMT) AS SALES_TY            --SUM(TXN.NET_AMT) AS SALES_TY\n\nFROM DW_EDW_VIEWS.TXN_FACTS TXN             --FROM DW_DSS.TXN_FACTS TXN\nJOIN DW_VIEWS.RETAIL_ORDER_GROUP_UPC_EXTENDED ROG            --JOIN DW_DSS.LU_UPC ITM\nON TXN.UPC_ID = ROG.UPC_NBR            --ON TXN.UPC_ID = ITM.UPC_ID\n\nJOIN DW_VIEWS.CORPORATE_ITEM CI\nON  TXN.CORPORATION_ID = CI.CORPORATION_ID\nAND ROG.COMMON_RETAIL_CD = CI.COMMON_RETAIL_CD\nAND CI.CORPORATE_ITEM_CD = ROG.PREFERRED_CORPORATE_ITEM_CD\n\nJOIN DW_VIEWS.D1_RETAIL_STORE STR            --JOIN DW_DSS.LU_STORE_FINANCE_OM STR\nON TXN.STORE_ID = STR.RETAIL_STORE_FACILITY_NBR            --ON TXN.STORE_ID = STR.STORE_ID\nAND ROG.ROG_ID = STR.ROG_ID                     -- had to join ROG_ID to prevent overstated numbers\n\nJOIN DW_VIEWS.CALENDAR CAL            --JOIN DW_DSS.LU_DAY_MERGE LU\nON TXN.TXN_DTE = CAL.CALENDAR_DT            --ON TXN.txn_dte = LU.D_DATE\n\nJOIN DW_VIEWS.FISCAL_PERIOD PD\nON CAL.FISCAL_PERIOD_NBR = PD.FISCAL_PERIOD_NBR\nAND CAL.FISCAL_YEAR_NBR = PD.FISCAL_YEAR_NBR -- ADDING THIS JOIN IN EDM REDUCES THE OVERSTATEMENT BY HALF VS NOT INCLUDING\n\nWHERE CAL.CALENDAR_DT BETWEEN '04/01/2022' and CURRENT_DATE-1            --WHERE TXN.TXN_DTE BETWEEN '02/28/2021' and CURRENT_DATE-1\nAND STR.DIVISION_ID = '32'            --AND STR.OP_AREA_FINANCE_CD = 32 --DIVISION\nAND STR.CORPORATION_ID = '001'\nAND STR.DIVISION_NM LIKE '%JEWEL%'\nAND ROG.DEPARTMENT_ID IN (306,309)            --AND ITM.DEPARTMENT_ID IN (306,309) --DEPARTMENT\n\nAND ROG.DW_CURRENT_VERSION_IND = TRUE\nAND STR.DW_LOGICAL_DELETE_IND = FALSE\nAND PD.DW_CURRENT_VERSION_IND = TRUE\nAND PD.DW_LOGICAL_DELETE_IND = FALSE\nAND CAL.DW_CURRENT_VERSION_IND = TRUE\nAND CAL.DW_LOGICAL_DELETE_IND = FALSE\nAND CI.DW_CURRENT_VERSION_IND = TRUE\nAND CI.DW_LOGICAL_DELETE_IND = FALSE\nGROUP BY 1,2,3,4,5,6,7,8;\n</code></pre>"},{"location":"merch_sql/#store-upc-agp","title":"Store UPC Agp","text":"<pre><code>SELECT\n'SUA EDW' AS SRC\n,STORE_ID\n,UPC_ID\n,DAY_DT\n,SUM_ITEM_QTY\n,SUM_NET_AMT\n, AGP_EXT_AMT\nFROM EDM_VIEWS_PRD.DW_EDW_VIEWS.store_upc_agp\nWHERE STORE_ID = 1467\nAND UPC_ID     = 954201519\nAND DAY_DT BETWEEN '2021-12-01'::DATE AND '2021-12-28'::DATE\nUNION\n-- EDM Query:\nSELECT\n'EDM SUA'           AS SRC\n,FACILITY_NBR       AS STORE_ID\n,UPC_NBR            AS UPC_ID\n,TRANSACTION_DT     AS DAY_DT\n,ITEM_QTY           AS SUM_ITEM_QTY\n,NET_AMT            AS SUM_NET_AMT\n,AGP_EXTENDED_AMT   AS AGP_EXT_AMT\nFROM EDM_VIEWS_prd.DW_VIEWS.store_upc_agp agp\nINNER JOIN EDM_VIEWS_prd.DW_VIEWS.retail_store str\nON str.FACILITY_INTEGRATION_ID = agp.FACILITY_INTEGRATION_ID\nAND str.DW_CURRENT_VERSION_IND = TRUE\nWHERE TRANSACTION_DT &gt; '2022-09-08'::DATE - 1000\nAND FACILITY_NBR     = 1467\nAND UPC_NBR          = 954201519\nAND TRANSACTION_DT BETWEEN '2021-12-01'::DATE AND '2021-12-28'::DATE;\n</code></pre>"},{"location":"merch_sql/#get-unieq-fiscal-periods","title":"Get Unieq Fiscal Periods","text":"<pre><code>WITH lu_day_merge as\n(\nSELECT DISTINCT\ncal.calendar_dt                                 AS d_date,\nfw.fiscal_period_id                             AS period_id\nFROM        edm_views_prd.dw_views.calendar                 AS cal\nINNER JOIN  edm_views_prd.dw_views.d0_fiscal_week           AS fw\nON  cal.fiscal_year_nbr                             =  fw.fiscal_year_nbr\nAND  cal.fiscal_week_nbr                             =  fw.fiscal_week_nbr\nWHERE       cal.dw_logical_delete_ind                       =  False\nAND       cal.dw_current_version_ind                      =  True\n),\nlu_period_merge as\n(\nSELECT DISTINCT fiscal_period_id as period_id\n,fiscal_period_end_dt        AS end_dt\nFROM EDM_VIEWS_PRD.DW_VIEWS.D0_FISCAL_PERIOD\n)\nselect period_id from lu_period_merge where period_id between\n(select period_id\nfrom lu_day_merge d where d_date = (select max(d_date) as end_date from lu_day_merge where\nperiod_id = (select max(period_id) as end_period from lu_period_merge\nwhere end_dt &lt; current_date and end_dt &gt; current_date - 60)) - 500 group by 1)\nand\n(select period_id from lu_day_merge where\nperiod_id = (select max(period_id) as end_period from lu_period_merge\nwhere end_dt &lt; current_date and end_dt &gt; current_date - 60) group by 1)\norder by 1 desc\n</code></pre>"},{"location":"merch_sql/#get-active-items-by-vendor","title":"Get Active Items by Vendor","text":"<pre><code>with cat_id as (5701) , vendor_id as (1026)\nSELECT luc.Item_Status_Cd AS corp_status_cd\n, SCAT.SMIC_Group_Cd*100+SCAT.SMIC_Category_Cd AS cat_id\n, CASE WHEN VITEM.Vendor_UPC_Id &gt; 0   AND (luc.Display_Item_Ind = 'Y'\nOR (SCI.ship_unit_pack_type_cd &lt;&gt; '' AND SCI.ship_unit_pack_type_cd IS NOT NULL))\nTHEN luc.Vendor_UPC_Id\nELSE cur.UPC_NBR\nEND AS  upc_id\n, luc.item_dsc AS  cic_desc          , luc.CORPORATE_ITEM_CD AS  corp_item_cd\n, luc.Ship_Unit_Pack_Qty AS  pack_qty\n, cur.SHELF_UNIT_SIZE_DSC AS item_size\n, SLS.SMIC_Group_Cd*10000+ SLS.SMIC_Category_Cd*100+SLS.SMIC_Class_Cd AS class_id\n, SLS.SMIC_Class_Dsc AS class_name\n, wco.VENDOR_UNIT_COST_AMT  AS vend_unit_cost\n, vit.Vendor_Id AS vendor_nbr     , CIGI.common_item_group_cd AS cig\n, SCAT.SMIC_Category_Dsc AS cat_name\n, luc.Ship_Unit_Pack_Qty AS min_order_qty\n, luc.Buyer_Nbr AS buyer_nbr\n, CASE WHEN luc.Ship_Unit_Pack_Qty = 1\nTHEN 2 -- eaches\nELSE 1 -- cases\nEND AS retail_order\n\nFROM EDM_VIEWS_PRD.DW_VIEWS.Retail_Order_Group_Corporate_item wir\nJOIN EDM_VIEWS_PRD.DW_VIEWS.WAREHOUSE luw ON luw.WAREHOUSE_ID = wir.WAREHOUSE_ID\nAND wir.corporation_id = 1    AND luw.DW_CURRENT_VERSION_IND = TRUE\nAND luw.DW_LOGICAL_DELETE_IND = FALSE\nAND WIR.DW_CURRENT_VERSION_IND = TRUE\nAND WIR.DW_LOGICAL_DELETE_IND = FALSE\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM_UPC_ROG_REFERENCE cur ON cur.Corporate_Item_Integration_Id = wir.Corporate_Item_Integration_id\nAND cur.ROG_ID = wir.Rog_Id\nAND current_date BETWEEN to_date(cur.DW_FIRST_EFFECTIVE_DT) AND to_date(cur.DW_LAST_EFFECTIVE_DT)\nAND cur.DW_CURRENT_VERSION_IND = TRUE\nAND cur.DW_LOGICAL_DELETE_IND = FALSE INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.Common_Item_Group_Item CIGI\nON CIGI.CORPORATE_ITEM_INTEGRATION_ID = cur.CORPORATE_ITEM_INTEGRATION_ID\nAND CIGI.DW_CURRENT_VERSION_IND = TRUE\nAND CIGI.DW_LOGICAL_DELETE_IND = FALSE\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.Corporate_Item luc ON luc.Corporate_Item_Integration_Id   = wir.Corporate_Item_Integration_id\nAND luc.corporation_id = 1\nAND luc.DW_CURRENT_VERSION_IND = TRUE\nAND luc.DW_LOGICAL_DELETE_IND = FALSE\n\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SMIC_Category SCAT\nON SCAT.SMIC_Group_Cd = luc.SMIC_Group_Cd\nAND SCAT.DW_CURRENT_VERSION_IND = TRUE\nAND SCAT.DW_LOGICAL_DELETE_IND = FALSE\nAND (SCAT.SMIC_Group_Cd*100+SCAT.SMIC_Category_Cd)= 5705 -- category id\n\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.Supply_Chain_Item SCI\nON SCI.CORPORATE_ITEM_INTEGRATION_ID = luc.CORPORATE_ITEM_INTEGRATION_ID\nAND SCI.DW_CURRENT_VERSION_IND = TRUE\nAND SCI.DW_LOGICAL_DELETE_IND = FALSE\n\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.Vendor_item VITEM\nON VITEM.CORPORATE_ITEM_INTEGRATION_ID = luc.CORPORATE_ITEM_INTEGRATION_ID\nAND VITEM.WAREHOUSE_ID=SCI.WAREHOUSE_ID\nAND VITEM.DW_CURRENT_VERSION_IND = TRUE\nAND VITEM.DW_LOGICAL_DELETE_IND = FALSE\n\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SMIC_Class SLS\nON SLS.SMIC_Group_Cd = luc.SMIC_Group_Cd\nAND SLS.SMIC_CATEGORY_CD= LUC.SMIC_CATEGORY_CD\nAND SLS.SMIC_CLASS_CD= LUC.SMIC_CLASS_CD\nAND SLS.DW_CURRENT_VERSION_IND = TRUE\nAND SLS.DW_LOGICAL_DELETE_IND = FALSE\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.Supply_Chain_Item scm\nON scm.Warehouse_Id = wir.WAREHOUSE_ID\nAND scm.DW_CURRENT_VERSION_IND = TRUE\nAND scm.DW_LOGICAL_DELETE_IND = FALSE\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.Vendor_Item vit on vit.CORPORATE_ITEM_INTEGRATION_ID = scm.CORPORATE_ITEM_INTEGRATION_ID\nAND vit.DW_CURRENT_VERSION_IND = TRUE\nAND vit.DW_LOGICAL_DELETE_IND = FALSE\n\njoin EDM_VIEWS_PRD.DW_VIEWS.Corporate_Item ci\non ci.CORPORATE_ITEM_INTEGRATION_ID = vit.CORPORATE_ITEM_INTEGRATION_ID\nAND ci.DW_CURRENT_VERSION_IND = TRUE\nAND ci.DW_LOGICAL_DELETE_IND = FALSE\n\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.WAREHOUSE_COST  wco ON wco.WAREHOUSE_ID = wir.WAREHOUSE_ID\nAND wco.CORPORATE_ITEM_INTEGRATION_ID = wir.Corporate_Item_Integration_id\nAND wco.VENDOR_ID = vit.Vendor_Id\nAND try_to_number(vit.Vendor_Id) = 1026 -- vendor id\nAND wco.ACTIVE_VENDOR_IND = 'A'\nAND wco.VENDOR_UNIT_COST_AMT  &gt; 0\nAND wco.DW_CURRENT_VERSION_IND = TRUE\n\nWHERE  luc.Display_Item_Ind    = 'N' OR luc.Display_Item_Ind    = ''\nOR (luc.Display_Item_Ind = 'Y' -- displayer item\nAND VITEM.Vendor_UPC_Id &gt; 0)\nOR (luc.Display_Item_Ind = 'Y' -- displayer item\nAND VITEM.Vendor_UPC_Id = 0)\nAND scm.SELECTED_ITEM_CD  in ('S', ' ')\n\nGROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16 ORDER BY 12 DESC\n</code></pre>"},{"location":"merch_sql/#periscope-forecast-by-item","title":"Periscope Forecast By Item","text":"<pre><code>SELECT WEEK_ID,\nCORPORATE_ITEM_CD,\nCORPORATE_ITEM_CODE_DSC,\nDIVISION_ID, ROG_ID,\nCASE_SIZE_NBR,\nprimary_tactic_nm, PRIMARY_TACTIC_DSC,\nCOMMON_ITEM_GROUP_ID, substr(VENDOR_PARENT_NM,6) as vend_nm, vehicle_type_txt, round(sum(forecast_unit_nbr),0) as units, round(sum(TOTAL_MARKDOWN_FORECAST_AMT),0) as mkdn, round(sum(TOTAL_MARGIN_FORECAST_EXPENSE_AMT),0) as agp,\nround(sum(total_sale_forecast_amt),0) as sales\nFrom EDM_VIEWS_PRD.DW_VIEWS.PROMO_ROLLUP_RPT rpt\nWhere promotion_week_start_dt between current_date - 10 and current_date + 100\nAND CORPORATE_ITEM_CD IN (57500015) and CASE_SIZE_NBR &gt; 0\nGROUP BY 1,2,3,4,5,6,7,8,9,10,11\n</code></pre>"},{"location":"merch_sql/#periscope-actuals-by-item-div","title":"Periscope Actuals By Item / Div","text":"<pre><code>WITH DIV AS (SELECT CASE WHEN DIVISION_NM = 'DENVER' THEN '05'\nWHEN DIVISION_NM ='INTERMOUNTAIN' THEN'30'\nWHEN DIVISION_NM ='JEWEL' THEN '32'\nWHEN DIVISION_NM ='MID-ATLANTIC' THEN '34'\nWHEN DIVISION_NM ='NOR CALIFORNIA' THEN '25'\nWHEN DIVISION_NM ='PORTLAND' THEN '19'\nWHEN DIVISION_NM ='SEATTLE' THEN '27'\nWHEN DIVISION_NM ='SHAWS' THEN '33'\nWHEN DIVISION_NM ='SO CALIFORNIA' THEN '29'\nWHEN DIVISION_NM ='SOUTHERN' THEN '20'\nWHEN DIVISION_NM ='SOUTHWEST' THEN '17' ELSE '0' END AS DIVISION_ID, DIVISION_NM FROM EDM_VIEWS_PRD.DW_VIEWS.PROMO_PERF_RPT\nGROUP BY 1,2)\n\nSELECT  QUARTER_ID\n,   FISCAL_QUARTER_ID\n,   FISCAL_PERIOD_ID\n,   WEEK_ID\n,   PROMOTION_WEEK_ID\n,   YEAR_ID\n,   FISCAL_YEAR_ID\n,   BRAND_NM\n,   DEPARTMENT_NM\n,   DEPARTMENT_ID\n,   SUB_DEPARTMENT_ID\n,   CATEGORY_NM\n,   CATEGORY_ID\n,   CLASS_NM\n,   CLASS_ID\n,   DIV.DIVISION_ID\n,   PERF.DIVISION_NM\n,   VENDOR_PARENT_NM\n,   CORPORATE_ITEM_CD\n,   CORPORATE_ITEM_CODE_DSC\n,   COMMON_ITEM_GRP_ID\n,   OWN_BRAND_STATUS_IND\n,   SUM(REG_SALE_AMT) AS GROSS_SALES\n,   SUM(TOTAL_NET_SALE_AMT) AS NET_SALES\n,   SUM(TOTAL_COST_AMT) AS TOTAL_COST\n,   SUM(TOTAL_UNIT_SOLD_AMT) AS TOTAL_UNITS\n,   SUM(TOTAL_VENDOR_FUNDING_AMT)AS TOTAL_ALLOWANCES\n,   SUM(TOTAL_VENDOR_FUNDING_AMT-NEW_ITEM_ALLOWANCES_AMT) AS TOTAL_ALLOWANCES_EX_NEW_ITEMS\n,   SUM(COGS_SALE_AMT) AS COGS\n,   SUM(TOTAL_DISCOUNT_AMT) AS MARKDOWN\n,   SUM(RETAIL_ALLOW_AMT) AS RETAIL_ALLOWANCES\n,   SUM(SHIPPING_ALLOWANCES_AMT) AS SHIPPING_ALLOW_AMT\n,   SUM(TRANSACTION_ALLOWANCES_AMT) AS TRANSACTION_ALLOW_AMT\n,   SUM(SCAN_ALLOWANCES_AMT) AS SCAN_ALLOW_AMT\n,   SUM(DSD_CASE_BILLBACK_AMT) AS DSD_BB_ALLOW_AMT\n,   SUM(NEW_ITEM_ALLOWANCES_AMT) AS NI_ALLOW_AMT\n,   SUM(FLAT_ALLOWANCES_AMT) AS FLAT_ALLOW_AMT\n,   SUM(ALTERNATE_SOURCE_BUYING_ALLOWANCE_AMT) AS ASB_ALLOW_AMT\n,   SUM(BUYING_ALLOWANCES_AMT) AS BUYING_ALLOW_AMT\n,   SUM(FREIGHT_ALLOWANCES_AMT) AS FREIGHT_ALLOW_AMT\n,   SUM(TRADE_DISCOUNT_ALLOWANCE_AMT) AS TRADE_DISC_ALLOW_AMT\n,   SUM(OTHER_ALLOWANCE_AMT) OTHER_ALLOW_AMT\n,   SUM(SWELL_ALLOWANCE_AMT) AS SWELL_ALLOW_AMT\n,   SUM(UNBILLABLE_PRC_AT_COST_AMT) AS UNBILLABLE_PRC_CST\n,   SUM(DISTRESS_AT_COST_AMT) AS DISTRESS_CST\n,   SUM(AGP_SALE_AMT) AS AGP\n\nFROM EDM_VIEWS_PRD.DW_VIEWS.PROMO_PERF_RPT PERF JOIN DIV AS DIV ON DIV.DIVISION_NM = PERF.DIVISION_NM\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_PROMOTION_CALENDAR_WEEK PWK\nON PWK.PROMOTION_WEEK_ID = PERF.WEEK_ID AND PWK.DIVISION_ID = DIV.DIVISION_ID WHERE WEEK_ID IN (202152)--,20212,20203,20204)--(20203,20204)\n--where week_ID BETWEEN 202149 AND 202208\n\nGROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22\n</code></pre>"},{"location":"merch_sql/#store-upc-agp-sales-profit-vendor-funds","title":"Store UPC Agp Sales Profit Vendor Funds","text":"<pre><code>WITH CIC AS ( SELECT CIURR.CORPORATE_ITEM_INTEGRATION_ID ,   CIURR.UPC_NBR ,   CIURR.ROG_ID ,   CIC.CORPORATE_ITEM_CD ,   CIURR.SHELF_UNIT_SIZE_DSC\n\nFROM    EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM_UPC_ROG_REFERENCE CIURR INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM_UPC_REFERENCE CIUR ON  CIUR.UPC_NBR = CIURR.UPC_NBR AND CIUR.CORPORATE_ITEM_INTEGRATION_ID= CIURR.CORPORATE_ITEM_INTEGRATION_ID AND CIUR.DW_CURRENT_VERSION_IND = TRUE LEFT JOIN EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM CIC ON CIC.CORPORATE_ITEM_INTEGRATION_ID = CIURR.CORPORATE_ITEM_INTEGRATION_ID WHERE   1=1 AND     CIURR.DW_LOGICAL_DELETE_IND = FALSE  AND     CIURR.DW_CURRENT_VERSION_IND = TRUE AND     CIC.DW_CURRENT_VERSION_IND = 1 AND     CIC.DW_LOGICAL_DELETE_IND = 0 QUALIFY ROW_NUMBER() OVER (PARTITION BY CIURR.ROG_ID, CIURR.UPC_NBR ORDER BY CIUR.PREFERED_CORPORATE_ITEM_SEQ_NBR ASC) = 1) SELECT   PDAY.PROMOTION_WEEK_ID\n,   PWK.FISCAL_PERIOD_ID ,   PWK.FISCAL_QUARTER_ID ,   RST.DIVISION_ID\n,   RST.DIVISION_NM\n--, RST.RETAIL_STORE_FACILITY_NBR\n,   UPC.RETAIL_DEPARTMENT_ID\n,   UPC.DEPARTMENT_NM\n,   UPC.SMIC_CATEGORY_ID\n,   UPC.SMIC_CATEGORY_DSC\n--, RST.FACILITY_NBR\n--, cig.COMMON_ITEM_GROUP_CD\n,   CIC.CORPORATE_ITEM_CD\n,   CIC.SHELF_UNIT_SIZE_DSC\n,   AGP.UPC_NBR\n,   UPC.ITEM_DSC\n\n,   SUM(AGP.GROSS_AMT - AGP.MARKDOWN_SHORT_TERM_SPECIAL_AMT) AS GROSS_SALES\n,   SUM(TOTAL_NET_AMT) AS NET_SALES --GROSS AMT - MARKDOWN AMT - TOTAL WODS - TOTAL PODS\n,   SUM(AGP.AVERAGE_COST_EXTENDED_AMT) AS AVERAGE_COST_EXTENDED_AMT  --VENDOR LIST COST\n,   SUM(CASE WHEN UPC.SMIC_CATEGORY_ID IN (8843,8643,9996,9902,9931,9932,9933,  9934,9935,9937,9938,9939,9952,9956,9970) THEN 0 ELSE ITEM_QTY END) AS UNITS_SOLD    --KPI EXCLUSION CATEGORIES TO REMOVE FROM ITEM COUNT\n,   SUM(CASE WHEN UPC.RETAIL_DEPARTMENT_ID IN ('301','303','304','307','314','317','311','328','315','316','336','0','347','339') THEN 0 ELSE MEASURED_QTY END) AS MEASURED_QTY\n\n--Retail Allowances\n,   SUM(AGP.SHIPPING_ALLOWANCE_EXTENDED_AMT) AS SHIPPING_ALLOWANCE_EXTENDED_AMT\n,   SUM(AGP.SCAN_ALLOWANCE_EXTENDED_AMT+AGP.REDEMPTION_ALLOWANCE_EXTENDED_AMT) AS SCAN_ALLOWANCE_PERF\n,   SUM(AGP.RETAIL_DSD_CASE_BILLBACK_ALLOWANCE_AMT) AS RETAIL_DSD_CASE_BILLBACK_ALLOWANCE_AMT   --GENERALLY NO VALUES RETURNED\n,   SUM(AGP.RETAIL_NEW_ITEM_ALLOWANCE_AMT) AS RETAIL_NEW_ITEM_ALLOWANCE_AMT\n,   SUM(AGP.TOTAL_FLAT_ALLOWANCE_EXTENDED_AMT) AS TOTAL_FLAT_ALLOWANCE_EXTENDED_AMT\n,   SUM(AGP.TOTAL_BUYING_ALLOWANCE_EXTENDED_AMT) AS TOTAL_BUYING_ALLOWANCE_EXTENDED_AMT\n,   SUM(AGP.TOTAL_FREIGHT_ALLOWANCE_EXTENDED_AMT) AS TOTAL_FREIGHT_ALLOWANCE_EXTENDED_AMT ,   SUM(TOTAL_OTHER_ALLOWANCE_EXTENDED_AMT) AS TOTAL_OTHER_ALLOWANCE_EXTENDED_AMT ,   SUM(AVERAGE_TRADE_DISCOUNT_ALLOWANCE_EXTENDED_AMT) AS TRADE_DISCOUNT_ALLOWANCE_EXTENDED_AMT ,   SUM(AVERAGE_SWELL_LEAKER_ALLOWANCE_EXTENDED_AMT) AS SWELL_LEAKER_ALLOWANCE_EXTENDED_AMT ,   SUM(UNBILLABLE_PRODUCT_RECOVERY_CENTER_COST_AMT) AS UNBILLABLE_PRODUCT_RECOVERY_CENTER_COST_AMT ,   SUM(COST_OF_GOODS_AMT) AS COST_OF_GOODS_AMT --Computed Cost of Goods.\n,   SUM(AGP_EXTENDED_AMT) AS AGP_EXTENDED_AMT\n\nFROM EDM_VIEWS_PRD.DW_VIEWS.STORE_UPC_AGP AGP\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE RST\nON AGP.FACILITY_INTEGRATION_ID = RST.FACILITY_INTEGRATION_ID\n--AND CLOSE_DT &gt; CURRENT_DATE\n--AND OPEN_DT &lt; (CURRENT_DATE)-365\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC UPC\nON  UPC.UPC_NBR = AGP.UPC_NBR\n--AND (UPC.SMIC_CATEGORY_ID &lt;9900 OR (UPC.SMIC_CATEGORY_ID IN (9902,9931,9932,9933,9934,9935,9937,9938,9939,9959,9961,9962,9963,9964,9966,9967,9968,9969,\n--9972,9973,9974,9975,9976,9977,9978,9979,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,9995,9996,9997,9998,9999)))\n--AND UPC.RETAIL_DEPARTMENT_ID NOT IN ('339','304')\n--AND UPC.CORPORATION_ID = '001'\n--AND UPC.DW_LOGICAL_DELETE_IND = FALSE\n--AND UPC.RETAIL_STATUS_IND ='D'\n--AND 1=1\nAND UPC.CORPORATION_ID = '001'\nAND UPC.SAFEWAY_UPC_IND = 'Y'\n\nLEFT JOIN CIC  CIC ON CIC.UPC_NBR = AGP.UPC_NBR\nAND CIC.ROG_ID = RST.ROG_ID\n\n--JOIN EDM_VIEWS_PRD.DW_VIEWS.D0_FISCAL_DAY LDAY\n--on TRANSACTION_DT = CALENDAR_DT\n--AND LDAY.FISCAL_QUARTER_ID = 202104\n\n--JOIN EDM_VIEWS_PRD.DW_VIEWS.LU_PROMO_DAY_MERGE_V PDAY  --UPDATE WHEN EDM D1-PROMOTION_CALENDAR_DAY is fixed\n--ON AGP.TRANSACTION_DT = PDAY.D_DATE\n--AND lpad(PDAY.DIVISION_ID,2,0)= RST.DIVISION_ID\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_PROMOTION_CALENDAR_DAY PDAY ON AGP.TRANSACTION_DT = PDAY. CALENDAR_DT\nAND PDAY.DIVISION_ID = RST.DIVISION_ID\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_PROMOTION_CALENDAR_WEEK PWK ON PWK.PROMOTION_WEEK_ID = PDAY.PROMOTION_WEEK_ID AND PWK.DIVISION_ID = RST.DIVISION_ID\n\nWHERE RST.DIVISION_ID IN ('05','17','19','20','25','27','29','30','32','33','34')\nAND RST.RETAIL_STORE_FACILITY_NBR  NOT IN (1509,1708,339,3197)\nAND RST.ROG_ID  NOT IN ('AKBA')\nAND PWK.PROMOTION_WEEK_ID = 202152\nAND AGP.UPC_NBR &lt;&gt;0\n--AND  (UPC.SMIC_CATEGORY_ID &lt;9900 OR (UPC.SMIC_CATEGORY_ID IN (9902,9931,9932,9933,9934,9935,9937,9938,9939,9959,9961,9962,9963,9964,9966,9967,9968,9969,\n--9972,9973,9974,9975,9976,9977,9978,9979,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,9995,9996,9997,9998,9999)))\n--AND UPC.RETAIL_DEPARTMENT_ID NOT IN ('339','304')\nGROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13\n</code></pre>"},{"location":"merch_sql/#get-category-name-by-vendor","title":"Get Category Name by Vendor","text":"<pre><code>select (cat.smic_group_cd * 100 + cat.smic_category_cd)::NUMBER AS CATEGORY_ID, cat.SMIC_CATEGORY_DSC AS CATEGORY_NM\nfrom EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.UPCFINWK_DEPT_DATA dim\njoin EDM_VIEWS_PRD.DW_VIEWS.SMIC_CATEGORY cat on right(dim.CATEGORY_ID, 4) = (cat.smic_group_cd * 100 + cat.smic_category_cd)::VARCHAR\nAND CAT.DW_LOGICAL_DELETE_IND = FALSE AND CAT.DW_CURRENT_VERSION_IND = TRUE\njoin EDM_VIEWS_PRD.DW_VIEWS.SMIC_GROUP grp on cat.SMIC_GROUP_CD = grp.SMIC_GROUP_CD\nAND GRP.DW_LOGICAL_DELETE_IND = FALSE AND GRP.DW_CURRENT_VERSION_IND = TRUE\njoin EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.finwk_brandcd mfg ON TRIM(MFG.L0) = TRIM(DIM.BRAND_CD)                                and grp.SMIC_GROUP_CD = 31 and TRIM(MFG.L3) = 'L3 - PROCTER &amp; GAMBLE'\ngroup by 1,2 order by 1\n</code></pre>"},{"location":"merch_sql/#store-upc-agp-by-category","title":"Store UPC AGP by Category","text":"<pre><code>WITH yr AS (\nSELECT start_swy_year_dt AS start_dt FROM OB_MAIN.lu_day_merge AS dte  INNER JOIN OB_MAIN.lu_year_merge AS yr ON yr.year_id = dte.year_id WHERE d_date = Current_Date - 7\n),\ndtes AS (\nSELECT d_date FROM OB_MAIN.lu_day_merge\ncross join yr\nWHERE ( d_date  BETWEEN yr.start_dt\nAND ( SELECT wk.week_end_dt  FROM OB_MAIN.lu_day_merge AS dte INNER JOIN OB_MAIN.lu_week_merge AS wk ON dte.week_id = wk.week_id WHERE d_date = Current_Date - 7)\n-- Year to end of last week\nOR d_date   BETWEEN yr.start_dt - 364\nAND ( SELECT wk.week_end_dt  -364 FROM OB_MAIN.lu_day_merge AS dte INNER JOIN OB_MAIN.lu_week_merge AS wk ON dte.week_id = wk.week_id WHERE d_date = Current_Date - 7)\n)\n)\nSELECT\nstore_id,\ncategory_id,\nday_dt,\nmanuf_type_cd,\nbrand_cd,\nSum(TY_sales)   AS TY_sales,\nSum(LY_sales)   AS LY_sales,\nSum(TY_qty)     AS TY_qty,\nSum(LY_qty)     AS LY_qty,\nSum(TY_lbs)     AS TY_lbs,\nSum(LY_lbs)     AS LY_lbs,\nSum(TY_agp)     AS TY_agp,\nSum(LY_agp)     AS LY_agp\nFROM (\nSELECT ret.facility_nbr AS store_id,\nupc.category_id, CASE WHEN sua.transaction_dt &gt;= yr.start_dt  THEN sua.transaction_dt   ELSE sua.transaction_dt + 364 END  AS day_dt, CASE WHEN upc.manuf_type_cd = 'H' THEN 'H' ELSE 'N' END AS manuf_type_cd,\nCASE WHEN upc.manuf_type_cd = 'H' THEN upc.brand_cd ELSE NULL END AS brand_cd,\nSum( CASE WHEN sua.transaction_dt &gt;= yr.start_dt    THEN sua.TOTAL_NET_AMT  ELSE 0.0 END ) AS TY_sales,\nSum( CASE WHEN sua.transaction_dt &lt;  yr.start_dt    THEN sua.TOTAL_NET_AMT  ELSE 0.0 END ) AS LY_sales,\nSum( CASE WHEN sua.transaction_dt &gt;= yr.start_dt    THEN sua.ITEM_QTY       ELSE 0.0 END ) AS TY_qty,\nSum( CASE WHEN sua.transaction_dt &lt;  yr.start_dt    THEN sua.ITEM_QTY       ELSE 0.0 END ) AS LY_qty,\nSum( CASE WHEN sua.transaction_dt &gt;= yr.start_dt    THEN sua.MEASURED_QTY   ELSE 0.0 END ) AS TY_lbs,\nSum( CASE WHEN sua.transaction_dt &lt;  yr.start_dt    THEN sua.MEASURED_QTY   ELSE 0.0 END ) AS LY_lbs,\nSum( CASE WHEN sua.transaction_dt &gt;= yr.start_dt    THEN sua.AGP_EXTENDED_AMT    ELSE 0.0 END ) AS TY_agp,\nSum( CASE WHEN sua.transaction_dt &lt;  yr.start_dt    THEN sua.AGP_EXTENDED_AMT    ELSE 0.0 END ) AS LY_agp\nFROM EDM_VIEWS_PRD.DW_VIEWS.store_upc_agp AS sua\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.retail_store AS ret ON ret.FACILITY_INTEGRATION_ID = sua.FACILITY_INTEGRATION_ID\nAND ret.DW_CURRENT_VERSION_IND = TRUE AND ret.DW_LOGICAL_DELETE_IND  = FALSE\nAND ret.CORPORATION_ID = 1\nINNER JOIN OB_MAIN.lu_upc AS upc\nON upc.upc_id = sua.upc_nbr\nCROSS JOIN  yr\nWHERE  sua.transaction_dt IN ( SELECT d_date FROM dtes )\nAND upc.group_id &lt;&gt; 99\nAND RET.FACILITY_NBR &lt; 9999\nGROUP BY 1,2,3,4,5\n\nUNION ALL\n\nSELECT   -- Haggen Last Year\nagp.store_id,\nCoalesce(upc1.category_id, -1) AS category_id,\nagp.day_dt + 364 AS day_dt,\nCASE WHEN  ob.upc_id IS NOT NULL    OR  ( upc.upc_id IS NOT NULL AND UPC.GROUP_ID &lt;&gt; 99 AND UPC.MANUF_TYPE_CD = 'H' ) THEN 'H' ELSE 'N'\nEND AS manuf_type_cd,\nCASE WHEN upc.manuf_type_cd = 'H' THEN upc.brand_cd ELSE NULL END AS brand_cd,\n0::NUMBER(18,4)                                 AS TY_sales,\nSum ( agp.sum_net_amt )                         AS LY_sales,\n0::NUMBER(18,4)                                 AS TY_Units,\nSum ( agp.sum_item_qty )                        AS LY_Units,\n0::NUMBER(18,4)                                 AS TY_lbs,\nSum ( agp.sum_meas_qty )                        AS LY_lbs,\n0::NUMBER(18,4)                                 AS TY_GP,\nSum ( agp.sum_net_amt - agp.cost_of_goods_amt ) AS LY_GP\nFROM EDM_VIEWS_PRD.DW_VIEWS.hgn_store_upc_agp AS agp INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.hgn_upc_swy_hier_full AS upc1     ON upc1.hgn_upc_id = agp.hgn_upc_id     LEFT JOIN OB_MAIN.haggen_ob_upcs AS ob              ON ob.upc_id = agp.upc_id\nLEFT JOIN OB_MAIN.lu_upc AS upc                     ON upc.upc_id = agp.upc_id\nCROSS JOIN  yr\nWHERE agp.day_dt IN ( SELECT d_date FROM dtes )\nGROUP BY 1,2,3,4,5\n) AS Q\nGROUP BY 1,2,3,4,5;\n</code></pre>"},{"location":"merch_sql/#random-weight-meat-cost","title":"Random weight meat cost","text":"<pre><code>WITH YPC AS (\nSELECT\nDISTINCT\nPRM.DIVISION_ID\n,   PRM.WAREHOUSE_ID\n,   PRM.CORPORATE_ITEM_CD AS PRIMAL_CIC\n,   DIV0 ( SUM ( CASE WHEN BASE_CORPORATE_ITEM_CD IN ( 88290059 , 88290061 , 88100217 , 88290060 , 880200497 , 880200259 , 88100109 )\nTHEN 0 - YIELD_PCT ELSE YIELD_PCT END ) , 100 ) AS PRIMAL_YIELD_ADJUSTMENT_PCT // when the driver is a non primary code or direct loss (ground beef, stew meat, cube steak, bone, fat, or yield loss)\n// that driver's yield % is subtracted from the yield of the true driver\n    FROM EDM_VIEWS_PRD.DW_VIEWS.PRIMAL_MEAT_ITEM_YIELD PRM\n    JOIN EDM_VIEWS_PRD.DW_VIEWS.BASE_MEAT_ITEM_YIELD DRV\n      ON PRM.DIVISION_ID = DRV.DIVISION_ID\n     AND PRM.WAREHOUSE_ID = DRV.WAREHOUSE_ID\n     AND PRM.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID = DRV.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID\n     AND PRM.YIELD_CHART_NBR = DRV.YIELD_CHART_NBR\n     AND PRM.DIVISION_ID = 27\n     AND PRM.YIELD_CHART_NBR = 1\n     AND PRM.DW_CURRENT_VERSION_IND = TRUE\n     AND PRM.DW_LOGICAL_DELETE_IND = FALSE\n     AND DRV.DW_CURRENT_VERSION_IND = TRUE\n     AND DRV.DW_LOGICAL_DELETE_IND = FALSE \n    GROUP BY 1 , 2 , 3 \n) , YDO AS (\n    SELECT \n    DISTINCT\n        YPD.DIVISION_ID\n    ,   OPT.ROG_ID\n    ,   YPD.DRIVER_CIC\n    ,   YPD.DRIVER_DSC\n    ,   OPT.OPTIONAL_CORPORATE_ITEM_CD\n    ,   OPT.OPTIONAL_ITEM_DSC\n    ,   CASE WHEN YPD.DRIVER_CIC IN ( 88290059 , 88290061 , 88100217 , 88290060 , 880200497 , 880200259 , 88100109 ) \n             THEN DIV0 ( SUM ( YPD.DRIVER_TOTAL_SHIPPED_COST ) , SUM ( YPD.DRIVER_POUNDS_SHIPPED ) )\n             ELSE DIV0 ( SUM ( YPD.DRIVER_TOTAL_SHIPPED_COST ) , SUM ( YPD.DRIVER_POUNDS_SHIPPED ) ) * AVG ( 2 - YPD.PRIMAL_YIELD_ADJUSTMENT_PCT )\n             END AS YIELD_ADJUSTED_COST\n     FROM (\n        SELECT \n        DISTINCT \n            YCH.DIVISION_ID\n        ,   YCH.WAREHOUSE_ID\n        ,   YCH.PRIMAL_CIC\n        ,   YCH.PRIMAL_ITEM_DSC\n        ,   YCH.DRIVER_CIC\n        ,   YCH.DRIVER_DSC\n        ,   YPC.PRIMAL_YIELD_ADJUSTMENT_PCT\n        ,   YCH.YIELD_PCT\n        ,   SUM ( SID.SHIPPED_QTY * SID.DETAIL_CHARGES_CHARGE2_AMT ) * YCH.YIELD_PCT AS DRIVER_TOTAL_SHIPPED_COST\n        ,   SUM ( SID.CASE_WGT ) * YCH.YIELD_PCT AS DRIVER_POUNDS_SHIPPED\n        FROM ( \n            SELECT\n            DISTINCT\n                PRM.DIVISION_ID\n            ,   PRM.WAREHOUSE_ID\n            ,   PRM.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID\n            ,   PRM.CORPORATE_ITEM_CD AS PRIMAL_CIC\n            ,   PRM.PRIMAL_ITEM_DSC\n            ,   DRV.BASE_CORPORATE_ITEM_INTEGRATION_ID\n            ,   CASE WHEN DRV.BASE_CORPORATE_ITEM_CD = 88100109 THEN 88100217 ELSE DRV.BASE_CORPORATE_ITEM_CD END AS DRIVER_CIC\n            ,   DRV.BASE_ITEM_DSC AS DRIVER_DSC\n            ,   DIV0 ( CASE WHEN PRM.CORPORATE_ITEM_CD NOT  IN ( 88290059 , 88290061 , 88100217 , 88290060 , 880200497 , 880200259 , 88100109 ) \n                            THEN CASE WHEN DRV.YIELD_PCT = 0 THEN 1 ELSE DRV.YIELD_PCT END END , 100 ) AS YIELD_PCT // the raw yield percent for all drivers is kept to provide driver costs for ground beef etc\n            FROM EDM_VIEWS_PRD.DW_VIEWS.PRIMAL_MEAT_ITEM_YIELD PRM\n            JOIN EDM_VIEWS_PRD.DW_VIEWS.BASE_MEAT_ITEM_YIELD DRV\n              ON PRM.DIVISION_ID = DRV.DIVISION_ID\n             AND PRM.WAREHOUSE_ID = DRV.WAREHOUSE_ID\n             AND PRM.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID = DRV.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID\n             AND PRM.YIELD_CHART_NBR = DRV.YIELD_CHART_NBR\n             AND PRM.YIELD_CHART_NBR = 1\n             AND PRM.DIVISION_ID = 27\n             AND PRM.DW_CURRENT_VERSION_IND = TRUE\n             AND PRM.DW_LOGICAL_DELETE_IND = FALSE\n             AND DRV.DW_CURRENT_VERSION_IND = TRUE\n             AND DRV.DW_LOGICAL_DELETE_IND = FALSE \n        ) YCH\n        JOIN EDM_VIEWS_PRD.DW_VIEWS.SUPPLY_CHAIN_INVOICE_HEADER SIH\n          ON YCH.WAREHOUSE_ID = SIH.WAREHOUSE_ID\n         AND YCH.DIVISION_ID = SIH.DIVISION_ID\n        INNER\n        JOIN EDM_VIEWS_PRD.DW_VIEWS.SUPPLY_CHAIN_INVOICE_DETAIL SID\n          ON SIH.SUPPLY_CHAIN_INVOICE_INTEGRATION_ID = SID.SUPPLY_CHAIN_INVOICE_INTEGRATION_ID\n         AND YCH.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID = SID.CORPORATE_ITEM_INTEGRATION_ID\n         AND SIH.DW_FIRST_EFFECTIVE_DT = SID.DW_FIRST_EFFECTIVE_DT\n         AND SIH.DW_LAST_EFFECTIVE_DT = SID.DW_LAST_EFFECTIVE_DT\n         AND SIH.DW_LOGICAL_DELETE_IND = FALSE\n         AND SIH.DW_CURRENT_VERSION_IND = TRUE\n         AND SID.DW_LOGICAL_DELETE_IND = FALSE\n         AND SID.DW_CURRENT_VERSION_IND = TRUE\n         AND SIH.CORPORATION_ID = 1\n         AND SIH.REQUESTED_DELIVERY_DT BETWEEN CURRENT_DATE - 28 AND CURRENT_DATE\n        JOIN YPC\n          ON YCH.DIVISION_ID = YPC.DIVISION_ID\n         AND YCH.WAREHOUSE_ID = YPC.WAREHOUSE_ID\n         AND YCH.PRIMAL_CIC = YPC.PRIMAL_CIC\n         AND SIH.WAREHOUSE_ID = YPC.WAREHOUSE_ID\n         AND SIH.DIVISION_ID = YPC.DIVISION_ID\n        GROUP BY 1 , 2 , 3 , 4 , 5 , 6 , 7 , 8 \n    ) YPD\n    JOIN EDM_VIEWS_PRD.DW_VIEWS.OPTIONAL_MEAT_ITEM_YIELD OPT\n      ON YPD.DIVISION_ID = OPT.DIVISION_ID\n     AND YPD.WAREHOUSE_ID = OPT.WAREHOUSE_ID\n     AND YPD.PRIMAL_CIC = OPT.CORPORATE_ITEM_CD\n     AND YPD.DRIVER_CIC = OPT.BASE_CORPORATE_ITEM_CD\n     AND OPT.DW_CURRENT_VERSION_IND = TRUE\n     AND OPT.DW_LOGICAL_DELETE_IND = FALSE\n    WHERE ROG_ID NOT IN ( 'SHGN' )\nGROUP BY 1 , 2 , 3 , 4 , 5 , 6 )\nSELECT DISTINCT\nAGG.DIVISION_ID\n,   AGG.ROG_ID\n,   AGG.CORPORATE_ITEM_CD\n,   AGG.ITEM_DSC\n,   AGG.YIELD_ADJUSTED_COST\nFROM ( SELECT DISTINCT YDO.DIVISION_ID\n,   YDO.ROG_ID\n,   YDO.DRIVER_CIC AS CORPORATE_ITEM_CD\n,   YDO.DRIVER_DSC AS ITEM_DSC\n,   MAX ( YDO.YIELD_ADJUSTED_COST ) AS YIELD_ADJUSTED_COST\nFROM YDO\nGROUP BY 1 , 2 , 3 , 4\nUNION ALL\nSELECT DISTINCT YDO.DIVISION_ID\n,   YDO.ROG_ID\n,   YDO.OPTIONAL_CORPORATE_ITEM_CD AS CORPORATE_ITEM_CD\n,   YDO.OPTIONAL_ITEM_DSC AS ITEM_DSC\n,   MAX ( YDO.YIELD_ADJUSTED_COST ) AS YIELD_ADJUSTED_COST\nFROM YDO\nGROUP BY 1 , 2 , 3 , 4\n) AGG\nORDER BY 1 , 2 , 3\n</code></pre>"},{"location":"merch_sql/#planogram-schematic-fixture","title":"Planogram Schematic Fixture","text":"<pre><code>SELECT POG.Planogram_Nm,\nUPC.SMIC_CATEGORY_ID,\nUPC.SMIC_CATEGORY_DSC,\nFXTR.SHELF_SURFACE_CD\n\nFROM EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_SLOT_ITEM ITEM\njoin EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM POG\non ITEM.PLANOGRAM_ID = POG.PLANOGRAM_ID\njoin EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_STORE_FIXTURE STORE\non ITEM.PLANOGRAM_ID = STORE.PLANOGRAM_ID\njoin EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_FIXTURE_SHELF FXTR\non  POG.PLANOGRAM_ID = FXTR.PLANOGRAM_ID\njoin EDM_VIEWS_PRD.DW_VIEWS.D1_UPC UPC\non  UPC.UPC_NBR = ITEM.UPC_NBR\njoin EDM_VIEWS_PRD.DW_VIEWS.FACILITY STR\non STR.FACILITY_INTEGRATION_ID = STORE.FACILITY_INTEGRATION_ID\nWHERE\nSTR.CLOSE_DT &gt; CURRENT_DATE AND STORE.STORE_SCHEMATIC_EFFECTIVE_END_DT  &gt; CURRENT_DATE\nAND ITEM.DW_CURRENT_VERSION_IND = TRUE  AND POG.DW_CURRENT_VERSION_IND = TRUE\nAND STORE.DW_CURRENT_VERSION_IND = TRUE\nAND FXTR.DW_CURRENT_VERSION_IND = TRUE\nAND ITEM.DW_LOGICAL_DELETE_IND = FALSE\nAND POG.DW_LOGICAL_DELETE_IND = FALSE\nAND STORE.DW_LOGICAL_DELETE_IND = FALSE\nAND FXTR.DW_LOGICAL_DELETE_IND = FALSE\nAND STR.DW_CURRENT_VERSION_IND = TRUE\nAND STR.DW_LOGICAL_DELETE_IND = FALSE\nAND STR.CORPORATION_ID ='001'\nAND FACILITY_TYPE_CD ='RT'\nAND FXTR. SHELF_SURFACE_CD LIKE 'Pegboard'\nAND UPC.UPC_NBR = ITEM.UPC_NBR\nAND UPC.CORPORATION_ID = 1\nAND UPC.SMIC_CATEGORY_ID IN ('3001','3004','3002')\n\nGROUP BY 1,2,3,4;\n</code></pre>"},{"location":"merch_sql/#distribution-voids","title":"Distribution voids","text":"<pre><code>SELECT\nDIVISION_NM,\nBANNER_NM,\nTB.UPC_NBR,\nTB.DESCRIPTION,\nCATEGORY_NM,\nTB.STORE_ID,\nSum(DISTRIBUTION) AS DISTRIBUTION,\nSum(SALES) AS SALES,\nSum(SHIPPED) AS SHIPPED,\nSum(TAG_QTY) AS TAG_QTY\n\nFROM\n\n(SELECT DIVISION_NM,\nTB3.BANNER_NM, TB3.UPC_NBR,\nDESCRIPTION,\nCATEGORY_NM,\nTB3.STORE_ID,\nSum(DISTRIBUTION) AS DISTRIBUTION,\nSum(SALES) AS SALES,\nSum(SHIPPED) AS SHIPPED,\nSum(TAG.TAG_NBR) AS TAG_QTY\n\nFROM (SELECT DIVISION_NM,\nBANNER_NM, UPC_NBR,\nDESCRIPTION,\nCATEGORY_NM,\nSTORE_ID,\nFACILITY_INTEGRATION_ID,\nSum(DISTRIBUTION) AS DISTRIBUTION,\nSum(SALES) AS SALES,\nSum(SHIPPED) AS SHIPPED\n\nFROM (\nSELECT TB.DIVISION_NM,\nTB.BANNER_nm,\nTB.UPC_nbr,\nTB.DESCRIPTION,\nTB.CATEGORY_NM,\nTB.STORE_ID,\nTB.FACILITY_INTEGRATION_ID,\nSum(TB.DIST) AS DISTRIBUTION,\nSum(TB.SALES_QTY) AS SALES,\nSum(SHIPPED) AS SHIPPED\nFROM (\nSELECT STR.DIVISION_NM, STR.BANNER_NM, ITEM.UPC_NBR, DEPT.DESCRIPTION,\nDEPT.CATEGORY_NM,\nSTR.RETAIL_STORE_FACILITY_NBR AS STORE_ID,\nSTR.FACILITY_INTEGRATION_ID,\nCast(1 AS DECIMAL (19,1)) AS DIST,\nCast(0.00 AS DECIMAL (19,1)) AS SALES_QTY,\nCast(0.00 AS DECIMAL (19,1)) AS SHIPPED\nFROM EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_SLOT_ITEM ITEM, EDM_VIEWS_PRD.DW_VIEWS.Planogram POG, EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_STORE_FIXTURE STORE,\nEDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE STR,\nEDM_VIEWS_PRD.DW_BIZOPS_VIEWS.UPCFINWK_DEPT_DATA DEPT\nWHERE\nITEM.PLANOGRAM_ID = POG.PLANOGRAM_ID\nand item.DW_CURRENT_VERSION_IND =TRUE\nAND POG.DW_CURRENT_VERSION_IND =TRUE\nand item.DW_LOGICAL_DELETE_IND =TRUE\nAND POG.DW_LOGICAL_DELETE_IND =TRUE\nAND ITEM.PLANOGRAM_ID = STORE.PLANOGRAM_ID AND STR.FACILITY_INTEGRATION_ID = STORE.FACILITY_INTEGRATION_ID AND STORE.DW_CURRENT_VERSION_IND =TRUE\nAND STORE.DW_LOGICAL_DELETE_IND =TRUE\n--AND STR.DIVISION_ID = 29\nAND STR.CLOSE_DT &gt; Current_Date AND STORE.STORE_SCHEMATIC_EFFECTIVE_END_DT  &gt; Current_Date\nAND ITEM.UPC_NBR = DEPT.UPC_NBR\nAND DEPT.CATEGORY_ID NOT LIKE 'OC%' AND Substr(UPC_NM,1,1)&lt;&gt; 'O'\nAND  DEPT.UPC_NBR IN (19067900008,\n19067900002,\n19067900018,\n19067900001,\n19067900012,\n19067900011) GROUP BY 1,2,3,4,5,6,7\n\nUNION ALL SELECT  STR.DIVISION_NM,\nSTR.BANNER_nm,\nAbs(SALES.UPC_NBR) AS UPC_NBR,\nDEPT.DESCRIPTION,\nDEPT.CATEGORY_NM,\nSTR.RETAIL_STORE_FACILITY_NBR AS STORE_ID,\nSTR.FACILITY_INTEGRATION_ID,\nCast(0.00 AS DECIMAL (19,1)) AS DIST,\nSum(ITEM_QTY) AS SALES_QTY,\nSUM(SALES.WHSE_SHIPPED_UNIT_QTY) + SUM(SALES.BDR_SHIPPED_UNIT_QTY) AS SHIPPED\nFROM EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.STRFINWK_DATA_COMBINED SALES\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE STR\nON  SALES.Facility_nbr = STR.RETAIL_STORE_FACILITY_NBR AND STR.CLOSE_DT &gt; Current_Date\n--AND   STR.DIVESTED_FLAG IN ('N')\n--AND STR.DIVISION_ID = 29\nAND FISCAL_WEEK_ID IN (SELECT (FISCAL_YEAR_NBR||LPAD(FISCAL_WEEK_NBR,2,0)) AS WEEK_ID FROM EDM_VIEWS_PRD.DW_VIEWS.Calendar\nWHERE calendar_dt between Current_Date - 180 and Current_Date  AND DW_LOGICAL_DELETE_IND =FALSE AND DW_CURRENT_VERSION_IND =TRUE group by 1)\nJOIN EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.UPCFINWK_DEPT_DATA DEPT\nON SALES.UPC_NBR = DEPT.UPC_NBR\nAND DEPT.CATEGORY_ID NOT LIKE 'OC%' WHERE Substr(UPC_NM,1,1)&lt;&gt; 'O'\nAND  DEPT.UPC_NBR IN (19067900008,\n19067900002,\n19067900018,\n19067900001,\n19067900012,\n19067900011) GROUP BY 1,2,3,4,5,6,7)TB GROUP BY 1,2,3,4,5,6,7)TB2\n\nGROUP BY 1,2,3,4,5,6,7)TB3\n\n\nJOIN EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE_ITEM_LOCATION TAG\nON TAG.UPC_NBR = TB3.UPC_NBR AND TAG.FACILITY_INTEGRATION_ID=TB3.FACILITY_INTEGRATION_ID\nAND TAG.DW_LOGICAL_DELETE_IND =FALSE AND TAG.DW_CURRENT_VERSION_IND =TRUE\n\n\nGROUP BY 1,2,3,4,5,6)TB\n--WHERE TB.DIVISION_NM = 'ACME' \n\nGROUP BY 1,2,3,4,5,6;\n</code></pre>"},{"location":"merch_sql/#sales-with-household-and-customer-data-penetration","title":"Sales with Household and customer data penetration","text":"<p>```sql   SELECT TB.UPC_ID as upc ,TB.ITEM_DSC as upc_dsc ,TB.SMIC_CATEGORY_ID as category_id ,TB.DIVISION_NM as div ,TB.WEEK_ID as week_id ,SUM(TB.TOTAL_NET_SALES_TY) AS total_sales_ty ,SUM(TB.TOTAL_NET_SALES_LY) AS total_sales_ly ,SUM(TB.ITEM_QTY_TY) AS total_qty_ty ,SUM(TB.ITEM_QTY_LY) AS total_qty_ly ,SUM(TB.BASKETS_TY) AS total_baskets_ty ,SUM(TB.BASKETS_LY) AS total_baskets_ly ,SUM(TB.HOUSEHOLDS_TY) AS total_households_ty ,SUM(TB.HOUSEHOLDS_LY) AS total_households_ly ,SUM(TB.EBG_NET_SALES_TY) AS ebg_net_sales_ty ,SUM(TB.EBG_NET_SALES_LY) AS ebg_net_sales_ly ,SUM(TB.EBG_ITEM_QTY_TY) AS ebg_qty_ty ,SUM(TB.EBG_ITEM_QTY_LY) AS ebg_qty_ly ,SUM(TB.EBG_BASKETS_TY) AS ebg_baskets_ty ,SUM(TB.EBG_BASKETS_LY) AS ebg_baskets_ly ,SUM(TB.EBG_HOUSEHOLDS_TY) AS ebg_households_ty ,SUM(TB.EBG_HOUSEHOLDS_LY) AS ebg_households_ly</p> <p>FROM( (SELECT         T1.UPC_ID       ,T1.ITEM_DSC       ,T1.SMIC_CATEGORY_ID       ,T1.DIVISION_NM       ,T1.WEEK_ID       ,T1.TOTAL_NET_SALES AS TOTAL_NET_SALES_TY       ,CAST(0.00 AS DECIMAL (19,1))  AS TOTAL_NET_SALES_LY       ,T1.ITEM_QTY AS ITEM_QTY_TY       ,CAST(0.00 AS DECIMAL (19,1))  AS ITEM_QTY_LY       ,T1.BASKETS AS BASKETS_TY       ,CAST(0.00 AS DECIMAL (19,1))  AS BASKETS_LY       ,T1.HOUSEHOLDS AS HOUSEHOLDS_TY       ,CAST(0.00 AS DECIMAL (19,1))  AS HOUSEHOLDS_LY       ,T2.EBG_NET_SALES AS EBG_NET_SALES_TY       ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_NET_SALES_LY       ,T2.EBG_ITEM_QTY AS EBG_ITEM_QTY_TY       ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_ITEM_QTY_LY       ,T2.EBG_BASKETS AS EBG_BASKETS_TY       ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_BASKETS_LY       ,T2.EBG_HOUSEHOLDS AS EBG_HOUSEHOLDS_TY       ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_HOUSEHOLDS_LY FROM (SELECT A.UPC_ID             ,E.ITEM_DSC             ,E.SMIC_CATEGORY_ID             ,D.DIVISION_NM             ,WEEK.WEEK_ID             ,CAST(SUM(A.NET_AMT + A.MKDN_WOD_ALLOC_AMT + A.MKDN_POD_ALLOC_AMT) AS DECIMAL(18, 4)) AS TOTAL_NET_SALES             ,CAST(SUM(ITEM_QTY) AS DECIMAL(18, 4)) AS ITEM_QTY             ,COUNT(DISTINCT TXN_ID) AS BASKETS             ,COUNT(DISTINCT CARD_NBR) AS HOUSEHOLDS       FROM  (select * from EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_FACTS where txn_dte &gt; '2022-01-01') A             ,EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE C            ,EDM_VIEWS_PRD.DW_VIEWS.DIVISION D              ,EDM_VIEWS_PRD.DW_VIEWS.D1_UPC E             ,EDM_VIEWS_PRD.DW_EDW_VIEWS.LIFESTYLE_SAME_STR_DAY same             ,EDM_SANDBOX_PRD.CORE_TECH.ZHU_COMP_WEEK week             ,EDM_VIEWS_PRD.DW_VIEWS.Calendar merge       WHERE  E.UPC_NBR = A.UPC_ID         AND  A.UPC_ID IN  (7940046281,7940046279,7940046273,7940046272,7940046271,2279691752,2279691751,2279691671,2279691670,2279691612,2279691611,2279691602,2279691601,2279691432,2279691431,2279691015,2279691014,2279691006,2279691005,2279690092,2279690090,8087817207,8087804238,8087817205,8087817206,8087804219,8087804235,8087804222,8087804225,8087800899,8087800406,8087804216,8087800218,8087817125,8087817126)         AND  merge.CALENDAR_DT = A.txn_dte          AND A.STORE_ID = C.FACILITY_NBR           AND c.DW_CURRENT_VERSION_IND =TRUE AND c.DW_LOGICAL_DELETE_IND =FALSE          AND c.CORPORATION_ID='001'          AND  D.DIVISION_ID=C.DIVISION_ID            AND D.DW_CURRENT_VERSION_IND =TRUE AND D.DW_LOGICAL_DELETE_IND =FALSE         AND  same.store_id = A.store_id         AND  same.txn_dt = A.txn_dte and same_store_ind = 'Y'         AND  week.current_week_id = (merge.FISCAL_YEAR_NBR ||LPAD(merge.Fiscal_Week_Nbr,2,0))          and merge.DW_CURRENT_VERSION_IND =TRUE and MERGE.DW_LOGICAL_DELETE_IND =FALSE          and current_week_id &gt;= 202001 and data_refresh_dt &lt; current_date</p> <pre><code>    AND  E.CORPORATION_ID = 1\n    AND  A.MISC_ITEM_QTY = 0\n    AND  A.DEPOSIT_ITEM_QTY = 0\n    AND  C.DIVISION_ID IN (5,15,17,19,20,23,29,30,32,33,34,35,25,27)\n    AND  A.REV_DTL_SUBTYPE_ID IN (0, 7)\n  GROUP BY 1,2,3,4,5\n  ) AS T1\n\n  LEFT JOIN\n  (SELECT A.UPC_ID\n         ,E.ITEM_DSC\n         ,E.SMIC_CATEGORY_ID\n         ,D.DIVISION_NM\n         ,week.WEEK_ID\n         ,CAST(SUM(A.NET_AMT + A.MKDN_WOD_ALLOC_AMT + A.MKDN_POD_ALLOC_AMT) AS DECIMAL(18, 4)) AS EBG_NET_SALES\n         ,CAST(SUM(ITEM_QTY) AS DECIMAL(18, 4)) AS EBG_ITEM_QTY\n         ,COUNT(DISTINCT TXN_ID) AS EBG_BASKETS\n         ,COUNT(DISTINCT A.CARD_NBR) AS EBG_HOUSEHOLDS\n   FROM   (select * from EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_FACTS where txn_dte &gt; '2022-01-01') A\n   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE C  ON A.STORE_ID = C.FACILITY_NBR \n   AND c.DW_CURRENT_VERSION_IND =TRUE AND c.DW_LOGICAL_DELETE_IND =FALSE\n    AND c.CORPORATION_ID='001'\n   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.DIVISION D \n      ON D.DIVISION_ID=C.DIVISION_ID\n    AND D.DW_CURRENT_VERSION_IND =TRUE AND D.DW_LOGICAL_DELETE_IND =FALSE\n   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC E ON E.UPC_NBR = A.UPC_ID AND E.CORPORATION_ID = 1\n   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SMV_LOYALTY_PROGRAM_RETAIL_CUSTOMER_HOUSEHOLD F ON A.CARD_NBR = F.LOYALTY_PROGRAM_CARD_NBR\n\n      AND A.MISC_ITEM_QTY = 0\n      AND A.DEPOSIT_ITEM_QTY = 0\n   AND  A.UPC_ID IN  (7940046281,7940046279,7940046273,7940046272,7940046271,2279691752,2279691751,2279691671,2279691670,2279691612,2279691611,2279691602,2279691601,2279691432,2279691431,2279691015,2279691014,2279691006,2279691005,2279690092,2279690090,8087817207,8087804238,8087817205,8087817206,8087804219,8087804235,8087804222,8087804225,8087800899,8087800406,8087804216,8087800218,8087817125,8087817126)\n   JOIN EDM_VIEWS_PRD.DW_VIEWS.Calendar merge on merge.CALENDAR_DT = A.txn_dte JOIN EDM_SANDBOX_PRD.CORE_TECH.ZHU_COMP_WEEK week on week.current_week_id =   (merge.FISCAL_YEAR_NBR ||LPAD(merge.Fiscal_Week_Nbr,2,0)) and merge.DW_CURRENT_VERSION_IND =TRUE and MERGE.DW_LOGICAL_DELETE_IND =FALSE   and current_week_id &gt;= 202001 and data_refresh_dt &lt; current_date\n   JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.LIFESTYLE_SAME_STR_DAY same on same.store_id = A.store_id AND  same.txn_dt = A.txn_dte and same_store_ind = 'Y'\n   LEFT JOIN (SELECT HOUSEHOLD_ID\n                    ,ANNUAL_LEVEL2_SEGMENT_ID\n                    ,WEEK_ID\n                    ,CASE WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (1) THEN 'ELITE'\n                          WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (2) THEN 'BEST'\n                          WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (3, 4) THEN 'GOOD'\n                          WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (5, 6) THEN 'OCCASIONAL'\n                          ELSE 'UNKNOWN'\n                          END AS FACTS_SEG_DESC\n              FROM EDM_VIEWS_PRD.DW_EDW_VIEWS.FACTS_SEGMENT_WEEK\n              GROUP BY 1, 2, 3, 4\n    ) AS FACTS ON FACTS.HOUSEHOLD_ID = F.HOUSEHOLD_ID AND FACTS.WEEK_ID = current_week_id\n\n      AND A.REV_DTL_SUBTYPE_ID IN (0, 7)\n      AND FACTS.ANNUAL_LEVEL2_SEGMENT_ID IN (1,2,3,4)\n    GROUP BY 1,2,3,4,5\n    ) AS T2\n</code></pre> <p>ON T1.UPC_ID = T2.UPC_ID AND T1.DIVISION_NM = T2.DIVISION_NM AND T1.WEEK_ID = T2.WEEK_ID)</p> <p>UNION ALL</p> <p>(SELECT T1.UPC_ID       ,T1.ITEM_DSC       ,T1.SMIC_CATEGORY_ID       ,T1.DIVISION_NM       ,T1.WEEK_ID       ,CAST(0.00 AS DECIMAL (19,1))  AS TOTAL_NET_SALES_TY       ,T1.TOTAL_NET_SALES AS TOTAL_NET_SALES_LY       ,CAST(0.00 AS DECIMAL (19,1))  AS ITEM_QTY_TY       ,T1.ITEM_QTY AS ITEM_QTY_LY       ,CAST(0.00 AS DECIMAL (19,1))  AS BASKETS_TY       ,T1.BASKETS AS BASKETS_LY       ,CAST(0.00 AS DECIMAL (19,1))  AS HOUSEHOLDS_TY       ,T1.HOUSEHOLDS AS HOUSEHOLDS_LY       ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_NET_SALES_TY       ,T2.EBG_NET_SALES AS EBG_NET_SALES_LY       ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_ITEM_QTY_TY       ,T2.EBG_ITEM_QTY AS EBG_ITEM_QTY_LY       ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_BASKETS_TY       ,T2.EBG_BASKETS AS EBG_BASKETS_LY       ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_HOUSEHOLDS_TY       ,T2.EBG_HOUSEHOLDS AS EBG_HOUSEHOLDS_LY FROM (SELECT A.UPC_ID             ,E.ITEM_DSC             ,E.SMIC_CATEGORY_ID             ,D.DIVISION_NM             ,WEEK.WEEK_ID             ,CAST(SUM(A.NET_AMT + A.MKDN_WOD_ALLOC_AMT + A.MKDN_POD_ALLOC_AMT) AS DECIMAL(18, 4)) AS TOTAL_NET_SALES             ,CAST(SUM(ITEM_QTY) AS DECIMAL(18, 4)) AS ITEM_QTY             ,COUNT(DISTINCT TXN_ID) AS BASKETS             ,COUNT(DISTINCT CARD_NBR) AS HOUSEHOLDS       FROM   (select * from EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_FACTS where txn_dte &gt; '2022-01-01') A             , EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE C              , EDM_VIEWS_PRD.DW_VIEWS.DIVISION D              ,EDM_VIEWS_PRD.DW_VIEWS.D1_UPC E             ,EDM_VIEWS_PRD.DW_EDW_VIEWS.LIFESTYLE_SAME_STR_DAY same             ,EDM_SANDBOX_PRD.CORE_TECH.ZHU_COMP_WEEK week             ,EDM_VIEWS_PRD.DW_VIEWS.Calendar merge       WHERE  E.UPC_NBR = A.UPC_ID         AND  A.UPC_ID IN  (7940046281,7940046279,7940046273,7940046272,7940046271,2279691752,2279691751,2279691671,2279691670,2279691612,2279691611,2279691602,2279691601,2279691432,2279691431,2279691015,2279691014,2279691006,2279691005,2279690092,2279690090,8087817207,8087804238,8087817205,8087817206,8087804219,8087804235,8087804222,8087804225,8087800899,8087800406,8087804216,8087800218,8087817125,8087817126)         AND  merge.CALENDAR_DT = A.txn_dte         AND   A.STORE_ID = C.FACILITY_NBR         AND c.DW_CURRENT_VERSION_IND =TRUE AND c.DW_LOGICAL_DELETE_IND =FALSE         AND c.CORPORATION_ID='001'         AND D.DIVISION_ID=C.DIVISION_ID         AND D.DW_CURRENT_VERSION_IND =TRUE AND D.DW_LOGICAL_DELETE_IND =FALSE          AND  same.store_id = A.store_id         AND  same.txn_dt = A.txn_dte and same_store_ind = 'Y'         AND  week.comp_week_id = (merge.FISCAL_YEAR_NBR ||LPAD(merge.Fiscal_Week_Nbr,2,0)) and merge.DW_CURRENT_VERSION_IND =TRUE and MERGE.DW_LOGICAL_DELETE_IND =FALSE  and current_week_id &gt;= 202001 and data_refresh_dt &lt; current_date</p> <pre><code>    AND  E.CORPORATION_ID = 1\n    AND  A.MISC_ITEM_QTY = 0\n    AND  A.DEPOSIT_ITEM_QTY = 0\n    AND  C.DIVISION_ID IN (5,15,17,19,20,23,29,30,32,33,34,35,25,27)\n    AND  A.REV_DTL_SUBTYPE_ID IN (0, 7)\n  GROUP BY 1,2,3,4,5\n  ) AS T1\n\n  LEFT JOIN\n  (SELECT A.UPC_ID\n         ,E.ITEM_DSC\n         ,E.SMIC_CATEGORY_ID\n         ,D.DIVISION_NM\n         ,WEEK.WEEK_ID\n         ,CAST(SUM(A.NET_AMT + A.MKDN_WOD_ALLOC_AMT + A.MKDN_POD_ALLOC_AMT) AS DECIMAL(18, 4)) AS EBG_NET_SALES\n         ,CAST(SUM(ITEM_QTY) AS DECIMAL(18, 4)) AS EBG_ITEM_QTY\n         ,COUNT(DISTINCT TXN_ID) AS EBG_BASKETS\n         ,COUNT(DISTINCT A.CARD_NBR) AS EBG_HOUSEHOLDS\n   FROM   (select * from EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_FACTS where txn_dte &gt; '2022-01-01') A\n   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE C  ON A.STORE_ID = C.FACILITY_NBR \n   AND c.DW_CURRENT_VERSION_IND =TRUE AND c.DW_LOGICAL_DELETE_IND =FALSE\n    AND c.CORPORATION_ID='001'\n   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.DIVISION D \n      ON D.DIVISION_ID=C.DIVISION_ID\n    AND D.DW_CURRENT_VERSION_IND =TRUE AND D.DW_LOGICAL_DELETE_IND =FALSE\n   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC E ON E.UPC_NBR = A.UPC_ID AND E.CORPORATION_ID = 1\n   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SMV_LOYALTY_PROGRAM_RETAIL_CUSTOMER_HOUSEHOLD F ON A.CARD_NBR = F.LOYALTY_PROGRAM_CARD_NBR     \n      AND A.MISC_ITEM_QTY = 0\n      AND A.DEPOSIT_ITEM_QTY = 0\n   AND  A.UPC_ID IN  (7940046281,7940046279,7940046273,7940046272,7940046271,2279691752,2279691751,2279691671,2279691670,2279691612,2279691611,2279691602,2279691601,2279691432,2279691431,2279691015,2279691014,2279691006,2279691005,2279690092,2279690090,8087817207,8087804238,8087817205,8087817206,8087804219,8087804235,8087804222,8087804225,8087800899,8087800406,8087804216,8087800218,8087817125,8087817126)\n   JOIN EDM_VIEWS_PRD.DW_VIEWS.Calendar merge on merge.CALENDAR_DT = A.txn_dte JOIN EDM_SANDBOX_PRD.CORE_TECH.ZHU_COMP_WEEK week on  week.comp_week_id = (merge.FISCAL_YEAR_NBR ||LPAD(merge.Fiscal_Week_Nbr,2,0)) and merge.DW_CURRENT_VERSION_IND =TRUE and MERGE.DW_LOGICAL_DELETE_IND =FALSE  and current_week_id &gt;= 202001 and data_refresh_dt &lt; current_date\n   JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.LIFESTYLE_SAME_STR_DAY same on same.store_id = A.store_id AND  same.txn_dt = A.txn_dte and same_store_ind = 'Y'\n   LEFT JOIN (SELECT HOUSEHOLD_ID\n                    ,ANNUAL_LEVEL2_SEGMENT_ID\n                    ,WEEK_ID\n                    ,CASE WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (1) THEN 'ELITE'\n                          WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (2) THEN 'BEST'\n                          WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (3, 4) THEN 'GOOD'\n                          WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (5, 6) THEN 'OCCASIONAL'\n                          ELSE 'UNKNOWN'\n                          END AS FACTS_SEG_DESC\n              FROM EDM_VIEWS_PRD.DW_EDW_VIEWS.FACTS_SEGMENT_WEEK\n              GROUP BY 1, 2, 3, 4\n    ) AS FACTS ON FACTS.HOUSEHOLD_ID = F.HOUSEHOLD_ID AND FACTS.WEEK_ID = comp_week_id\n\n      AND A.REV_DTL_SUBTYPE_ID IN (0, 7)\n      AND FACTS.ANNUAL_LEVEL2_SEGMENT_ID IN (1,2,3,4)\n    GROUP BY 1,2,3,4,5\n    ) AS T2\n</code></pre> <p>ON T1.UPC_ID = T2.UPC_ID AND T1.DIVISION_NM = T2.DIVISION_NM AND T1.WEEK_ID = T2.WEEK_ID) ) TB</p> <p>GROUP BY 1,2,3,4,5</p> <p>```</p>"},{"location":"operation_sql/","title":"Operation SQL","text":""},{"location":"operation_sql/#store-distress-by-quarter-period-department-item","title":"Store Distress by Quarter Period Department Item","text":"<pre><code>SELECT\n// EDW VERSIONS THAT WERE CONVERTED ARE IN COMMENTS//\nPD.FISCAL_PERIOD_NBR AS PERIOD,            --LU.PERIOD_ID as PERIOD,\nPD.FISCAL_QUARTER_NBR AS QUARTER,            --LU.QUARTER_ID as QUARTER,\nSTR.DISTRICT_CD AS DISTRICT,            --district_cd AS DISTRICT,\nSTR.RETAIL_STORE_FACILITY_NBR AS STORE,            --a.store_id AS STORE,\nROG.DEPARTMENT_ID ||' '||ROG.SMIC_GROUP_DSC AS DEPARTMENT,            --b.department_id ||' '|| b.department_nm as DEPARTMENT,\nROG.CATEGORY_ID||' '||ROG.SMIC_CATEGORY_DSC AS CATEGORY,            --b.CATEGORY_ID ||' '|| B.CATEGORY_NM AS CATEGORY,\nROG.CLASS_ID||' '||ROG.SMIC_CLASS_DSC AS CLASS,            --B.CLASS_ID ||' '|| B.CLASS_NM AS CLASS,\nA.UPC_ID||' '||CI.ITEM_DSC||' - CIC '||CI.CORPORATE_ITEM_CD AS DESCRIPTION,            --B.UPC_ID ||' '|| B.UPC_DSC ||' - CIC '||B.CORP_ITEM_CD AS DESCRIPTION,\nSUM(NET_AMT) AS DISTRESS_TY            --sum(net_amt) as DISTRESS_TY\n\nFROM EDM_VIEWS_PRD.DW_EDW_VIEWS.ITEM_DISTRESS_AGG A            --from dw_dss.item_distress_agg a\nJOIN DW_VIEWS.RETAIL_ORDER_GROUP_UPC_EXTENDED ROG            --JOIN dw_dss.lu_upc b\nON A.UPC_ID = ROG.UPC_NBR            --ON a.upc_id = b.upc_id\n\nJOIN DW_VIEWS.CORPORATE_ITEM CI\nON ROG.COMMON_RETAIL_CD = CI.COMMON_RETAIL_CD\nAND CI.CORPORATE_ITEM_CD = ROG.PREFERRED_CORPORATE_ITEM_CD JOIN DW_VIEWS.D1_RETAIL_STORE STR            --JOIN dw_dss.lu_store c\nON A.STORE_ID = STR.RETAIL_STORE_FACILITY_NBR            --ON a.store_id = c.store_id\nAND ROG.ROG_ID = STR.ROG_ID             --AND b.corporation_id = c.corporation_id\n\nJOIN DW_VIEWS.CALENDAR CAL            --JOIN DW_DSS.LU_DAY_MERGE LU\nON A.DISTRESS_DT = CAL.CALENDAR_DT            --ON a.DISTRESS_DT = LU.D_DATE\n\nJOIN DW_VIEWS.FISCAL_PERIOD PD\nON CAL.FISCAL_PERIOD_NBR = PD.FISCAL_PERIOD_NBR\nAND CAL.FISCAL_YEAR_NBR = PD.FISCAL_YEAR_NBR WHERE STR.CORPORATION_ID = '001'            --where b.corporation_id =1\nAND ROG.DEPARTMENT_ID IN (306,309)            --and department_id in (306,309)\nAND STR.DIVISION_ID = '32'             --and division_id = 32\nAND STR.DIVISION_NM LIKE '%JEWEL%'\nAND CAL.CALENDAR_DT BETWEEN '04/01/2022' and CURRENT_DATE-1            --and d_date between '04/01/2022' and current_date-1\nAND ROG.DW_CURRENT_VERSION_IND = TRUE\nAND STR.DW_LOGICAL_DELETE_IND = FALSE\nAND PD.DW_CURRENT_VERSION_IND = TRUE\nAND PD.DW_LOGICAL_DELETE_IND = FALSE\nAND CAL.DW_CURRENT_VERSION_IND = TRUE\nAND CAL.DW_LOGICAL_DELETE_IND = FALSE\nAND CI.DW_CURRENT_VERSION_IND = TRUE\nAND CI.DW_LOGICAL_DELETE_IND = FALSE\ngroup by 1,2,3,4,5,6,7,8\norder by 1,3,4,8;\n</code></pre>"},{"location":"operation_sql/#far-ps-queries","title":"Far PS Queries","text":"<pre><code>STEP 1 - create or replace view EDM_BIZOPS_PRD.MERCHAPPS.STORE_PS_ITEM_STORE_PLANOGRAM as\nSELECT  z.store_upc store_upc\n,        z.store_id store_id\n,        z.rog_id\n,        z.section_CD as DEPT_SECTION_ID\n,        z.upc_nbr upc_nbr ,        z.corporate_item_cd corporate_item_cd\n,        z.item_dsc\n,        z.size_qty\n,        z.size_uom_cd\n,        z.Fixture_Id\n,        z.HORIZONTAL_CNT HORIZONTAL_CNT\n,        z.VERTICAL_CNT VERTICAL_CNT\n--                  ,        z.bay_shelf_nbr\n,        z.STORE_SCHEMATIC_EFFECTIVE_START_DT ,        z.STORE_SCHEMATIC_EFFECTIVE_END_DT ,        z.large_pet_supply_3\n,        z.large_pet_supply_20\n,        z.spice_pack_ind\n--                  ,        max(z.bay_shelf_nbr) OVER (PARTITION BY z.fxtr_cd) AS max_bay_shelf_nbr\nFROM\n(SELECT a.Retail_store_facility_nbr || '-' || u.upc_nbr AS store_upc\n,               a.Retail_store_facility_nbr as store_id\n,               a.rog_id\n,               u.section_CD\n,               u.CONSUMER_SELLING_CD\n,               u.upc_nbr\n,               u.corporate_item_cd\n,               u.item_dsc\n,               c.size_qty\n,               c.size_uom_cd\n,               psi.Fixture_Id\n--                  ,               pfs.shelf_y_coord_nbr\n,               psi.HORIZONTAL_CNT\n,               psi.VERTICAL_CNT\n,               psi.STORE_SCHEMATIC_EFFECTIVE_START_DT ,               psi.STORE_SCHEMATIC_EFFECTIVE_END_DT ,               CASE WHEN u.SMIC_category_id = 525 OR u.SMIC_class_id = 53015 OR u.SMIC_category_id = 604 THEN 'Y' ELSE 'N' END AS spice_pack_ind\n,               CASE WHEN c.Corporate_Item_Integration_Id IS NOT NULL THEN 'Y' ELSE 'N' END AS large_pet_supply_3\n,               CASE WHEN c2.Corporate_Item_Integration_Id IS NOT NULL THEN 'Y' ELSE 'N' END AS large_pet_supply_20\n--                  ,               dense_rank() OVER (PARTITION BY pfs.fxtr_cd ORDER BY pfs.shelf_y_coord_nbr) AS bay_shelf_nbr                                                                                                                                                                                               \n\nFROM\n(SELECT * FROM  (SELECT F.Facility_NBR\n,           u.upc_nbr\n,           psi.PLANOGRAM_ID\n,           psf.Fixture_Id\n,           psi.HORIZONTAL_CNT\n,           psi.VERTICAL_CNT\n,           psf.STORE_SCHEMATIC_EFFECTIVE_START_DT ,           psf.STORE_SCHEMATIC_EFFECTIVE_END_DT\nFROM EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_SLOT_ITEM psi\nJOIN EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_STORE_FIXTURE psf\nON psf.PLANOGRAM_ID = psi.PLANOGRAM_ID\nJOIN EDM_VIEWS_PRD.DW_VIEWS.FACILITY F\nON psf.Facility_Integration_id = F.Facility_Integration_id\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC u\nON u.CONSUMER_SELLING_CD = psi.CONSUMER_SELLING_CD and u.CORPORATE_ITEM_CD &gt; 0\nWHERE 1=1\nAND current_date BETWEEN psf.STORE_SCHEMATIC_EFFECTIVE_START_DT - 14 AND psf.STORE_SCHEMATIC_EFFECTIVE_END_DT - 14\nAND psi.CONSUMER_SELLING_CD &lt;&gt; 0\nAND psi.CONSUMER_SELLING_CD IS NOT NULL\nand F.dw_logical_delete_ind = FALSE\nand F.dw_current_version_ind = True\nand psi.dw_logical_delete_ind = FALSE\nand psi.dw_current_version_ind = True\nand psf.dw_logical_delete_ind = FALSE\nand psf.dw_current_version_ind = True\nand F.Facility_type_cd ='RT'\nAND F.corporation_id ='001'\n--AND u.corporation_id ='001'\nGROUP BY 1,2,3,4,5,6,7,8\nUNION ALL\nSELECT F.FACILITY_NBR\n,               psi.upc_NBR\n,               psi.PLANOGRAM_ID\n,               psf.Fixture_Id\n,               psi.HORIZONTAL_CNT\n,               psi.VERTICAL_CNT\n,              psf.STORE_SCHEMATIC_EFFECTIVE_START_DT\n,              psf.STORE_SCHEMATIC_EFFECTIVE_END_DT\nFROM EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_SLOT_ITEM psi\nJOIN EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_STORE_FIXTURE psf\nON psf.PLANOGRAM_ID = psi.PLANOGRAM_ID\nJOIN EDM_VIEWS_PRD.DW_VIEWS.FACILITY F\nON psf.Facility_Integration_id = F.Facility_Integration_id\nWHERE 1=1\nAND current_date BETWEEN psf.STORE_SCHEMATIC_EFFECTIVE_START_DT - 14 AND psf.STORE_SCHEMATIC_EFFECTIVE_END_DT - 14\nAND (psi.CONSUMER_SELLING_CD = 0 OR psi.CONSUMER_SELLING_CD IS NULL)\nand F.dw_logical_delete_ind = FALSE\nand F.dw_current_version_ind = True\nand psi.dw_logical_delete_ind = FALSE\nand psi.dw_current_version_ind = True\nand psf.dw_logical_delete_ind = FALSE\nand psf.dw_current_version_ind = True\nand F.Facility_type_cd ='RT'\nAND F.corporation_id ='001'\nGROUP BY 1,2,3,4,5,6,7,8) csc\nGROUP BY 1,2,3,4,5,6,7,8) psi\nJOIN EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM p\nON p.PLANOGRAM_ID = psi.PLANOGRAM_ID\n--AND p.Fixture_Id = psf.Fixture_Id                                                                                               \n--        JOIN (\n--        SELECT p.store_id\n--    ,          p.pog_id\n--    ,          p.pog_fxtr_start_dt\n--    ,   p.pog_fxtr_end_dt\n--       FROM EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_STORE_FIXTURE p\n--       WHERE current_date() BETWEEN p.pog_fxtr_start_dt - 14 AND p.pog_fxtr_end_dt - 14\n--      GROUP BY 1,2,3,4\n--      ) psf\n--      ON psf.PLANOGRAM_ID = psi.PLANOGRAM_ID                                                                                               \n--        JOIN EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_fxtr_shelf pfs\n--        ON pfs.fxtr_cd = p.fxtr_cd\n--        AND pfs.fxtr_shelf_nbr = psi.fxtr_shelf_nbr                                                                                              \nLEFT JOIN\n(SELECT F.FACILITY_NBR || '-' || psi.upc_NBR AS store_upc\n,               F.FACILITY_NBR\n,               psi.upc_NBR                                                                                                              FROM EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_STORE_FIXTURE psf\nJOIN EDM_VIEWS_PRD.DW_VIEWS.FACILITY F\nON psf.Facility_Integration_id = F.Facility_Integration_id  JOIN EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_SLOT_ITEM psi\nON psi.PLANOGRAM_ID = psf.PLANOGRAM_ID                                                                                    JOIN EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM pog\nON pog.PLANOGRAM_ID = psf.PLANOGRAM_ID                                                                                                               JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC u\nON u.upc_nbr = psi.upc_NBR                                                                                                             WHERE 1=1\nAND current_date BETWEEN psf.STORE_SCHEMATIC_EFFECTIVE_START_DT - 14 AND psf.STORE_SCHEMATIC_EFFECTIVE_END_DT - 14\nand u.SAFEWAY_UPC_IND &lt;&gt; FALSE and F.dw_logical_delete_ind = FALSE\nand F.dw_current_version_ind = True\nand F.Facility_type_cd ='RT'\nAND F.corporation_id ='001'\nand psi.dw_logical_delete_ind = FALSE\nand psi.dw_current_version_ind = True\nand psf.dw_logical_delete_ind = FALSE\nand psf.dw_current_version_ind = True\nAND pog.Stocking_Section_Nbr IN (101, 103, 107, 140, 141, 142, 143, 959, 962, 990, 991)\n--AND u.dept_section_id = 318                                                                                      \nGROUP BY 1,2,3\n) ss\nON ss.store_upc = psi.FACILITY_NBR || '-' || psi.upc_NBR                                                                                                                                                                               JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.lu_stock_sect st\nON st.stock_sect_nbr = p.Stocking_Section_Nbr\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC u\nON u.upc_nbr = psi.upc_NBR                     --USE FOR KEHE\n--JOIN DW_PRD.DW_DSS.BDR_PURCHASE_ITEM b                                \n--ON b.upc_id = u.upc_nbr                                                                                              \nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_Retail_store a\nON a.Retail_store_facility_nbr = psi.FACILITY_NBR                                                                                LEFT JOIN\n(SELECT c.Corporate_Item_Integration_Id\n,          c.Size_Qty\n,          c.size_uom_cd                                                                                FROM EDM_VIEWS_PRD.DW_VIEWS.Corporate_Item c                                                                                         JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC u\nON u.Corporate_Item_Integration_Id = c.Corporate_Item_Integration_Id\nWHERE c.CORPORATE_ITEM_CD &gt; 0\nand c.dw_logical_delete_ind = FALSE\nand u.SAFEWAY_UPC_IND &lt;&gt; FALSE and c.dw_current_version_ind = True\nAND (((c.size_qty &gt;= 48 AND c.size_uom_cd = 'OZ') OR (c.size_qty &gt;= 3 AND c.size_uom_cd = 'LB')) AND ((c.size_qty &lt; 320 AND c.size_uom_cd = 'OZ') OR (c.size_qty &lt; 20 AND c.size_uom_cd = 'LB')))\nAND u.smic_category_id IN (3207,3202,3210)\nAND c.corporation_id = '001'\nAND u.smic_group_id = 32\nGROUP BY 1,2,3\n) c\nON u.Corporate_Item_Integration_Id = c.Corporate_Item_Integration_Id\nLEFT JOIN\n(SELECT c.Corporate_Item_Integration_Id\nFROM EDM_VIEWS_PRD.DW_VIEWS.Corporate_Item c\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC u\nON u.Corporate_Item_Integration_Id = c.Corporate_Item_Integration_Id\nWHERE c.CORPORATE_ITEM_CD  &gt; 0\nand u.SAFEWAY_UPC_IND &lt;&gt; FALSE and c.dw_logical_delete_ind = FALSE\nand c.dw_current_version_ind = True\nAND ((c.size_qty &gt;= 320 AND c.size_uom_cd = 'OZ') OR (c.size_qty &gt;= 20 AND c.size_uom_cd = 'LB'))\nAND u.SMIC_category_id IN (3207,3202,3210)\nAND c.corporation_id = '001'\nAND u.SMIC_group_id = 32\nGROUP BY 1\n) c2\nON u.Corporate_Item_Integration_Id = c2.Corporate_Item_Integration_Id\nWHERE 1=1\nand p.dw_logical_delete_ind = FALSE\nand p.dw_current_version_ind = True\nAND psi.upc_NBR &gt; 0\n-- AND ss.store_upc IS NULL\nAND u.CORPORATE_ITEM_CD  &gt; 0\nand u.SAFEWAY_UPC_IND &lt;&gt; FALSE --AND NOT a.parent_op_area_cd IN ()\n--AND a.store_id in (0767)\n--AND a.parent_op_area_cd IN (33)\n--AND u.department_id IN (317)\n--AND U.corp_item_cd IN (65150011)\n--AND u.department_id IN (317,314,323,324,325)\n--AND u.upc_nbr IN (2113045724)\n--AND u.category_id IN (8855,8856,8857,8858,8859,8863)\n--AND a.rog_id = 23\n--USE FOR KEHE (check JOIN above)\n--AND b.vend_nbr = '006446'                                                                                          \nGROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18\n) z            GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17;\n\nSTEP 2 -\ncreate or replace view EDM_BIZOPS_PRD.MERCHAPPS.STORE_PS_SALES_BY_ITEM_STORE (\nstore_upc,\nstore_id ,\nupc_nbr ,\navg_week_item_qty) as SELECT z.store_id || '-' || z.upc_nbr AS store_upc  ,        z.store_id store_id\n,        z.upc_nbr upc_nbr\n,        div0(z.item_qty, w.weeks_dif) AS avg_week_item_qty       FROM\n(\nSELECT rs.facility_nbr as store_id\n,s.FACILITY_INTEGRATION_ID\n,        s.upc_NBR\n,        sum(s.ITEM_QTY) AS item_qty\nFROM EDM_VIEWS_PRD.DW_VIEWS.SALES_AGGREGATE_DY s\njoin EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE rs\nON rs.FACILITY_INTEGRATION_ID = s.FACILITY_INTEGRATION_ID\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE a\nON a.FACILITY_INTEGRATION_ID = s.FACILITY_INTEGRATION_ID and a.division_id &lt;&gt; 'N/A'\nAND rs.FACILITY_INTEGRATION_ID=a.FACILITY_INTEGRATION_ID JOIN EDM_VIEWS_PRD.DW_VIEWS.CALENDAR D\nON D.Calendar_dt = s.TRANSACTION_DT\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_upc u\nON u.upc_nbr = s.upc_nbr and u.CORPORATE_ITEM_CD &gt; 0\nAND u.corporation_id = '001'\nWHERE D.DW_LOGICAL_DELETE_IND = FALSE AND D.DW_CURRENT_VERSION_IND = TRUE\n--and s.DW_LOGICAL_DELETE_IND = FALSE \nAND s.DW_CURRENT_VERSION_IND = TRUE\nand u.SAFEWAY_UPC_IND &lt;&gt; FALSE and rs.DW_LOGICAL_DELETE_IND = FALSE AND rs.DW_CURRENT_VERSION_IND = TRUE\n--AND A.DW_LOGICAL_DELETE_IND = FALSE\nAND D.Calendar_dt BETWEEN current_date - 365 AND current_date - 1\n--AND NOT a.parent_op_area_cd IN ()\n--AND a.store_id in (0767)\n--AND a.parent_op_area_cd IN (33)\n--AND u.department_id IN (317)\n--AND U.corp_item_cd IN (65150011)\n--AND u.department_id IN (317,314,323,324,325)\n--AND u.upc_id IN (2113045724)\n--AND u.category_id IN (8855,8856,8857,8858,8859,8863)\n--AND a.rog_id = 23                                                   \nGROUP BY 1,2,3\n) z      JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE a\nON a.FACILITY_INTEGRATION_ID = z.FACILITY_INTEGRATION_ID\nand a.division_id &lt;&gt; 'N/A'\nLEFT JOIN\n(                SELECT rs.FACILITY_nbr as store_id\n,               s.upc_nbr\n,               round((current_date - 7 - min(s.TRANSACTION_DT)) / 7,0) AS weeks_dif\nFROM EDM_VIEWS_PRD.DW_VIEWS.SALES_AGGREGATE_DY s\njoin EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE rs\nON rs.FACILITY_INTEGRATION_ID = s.FACILITY_INTEGRATION_ID\n\nWHERE 1=1\n-- and s.DW_LOGICAL_DELETE_IND = FALSE \nAND s.DW_CURRENT_VERSION_IND = TRUE\nand rs.DW_LOGICAL_DELETE_IND = FALSE AND rs.DW_CURRENT_VERSION_IND = TRUE\nAND s.TRANSACTION_DT BETWEEN current_date - 365 and current_date - 1\nGROUP BY 1,2\n) w\nON w.store_id || '-' || w.upc_nbr = z.store_id || '-' || z.upc_nbr\nWHERE 1=1\n\n--AND z.sum_item_qty / 52 &lt; 1\nAND current_date - a.Open_Dt &gt;= 364\nGROUP BY 1,2,3,4;\n\nSTEP 3 - create or replace view EDM_BIZOPS_PRD.MERCHAPPS.STORE_PS_ITEM_SALES_COMBINED as\nSELECT zz.store_id as store_id\n,             zz.rog_id\n,             zz.DEPT_SECTION_ID as dept_section_id\n,             zz.upc_NBR as upc_NBR\n,             zz.Item_dsc\n,             zz.Fixture_Id\n,             zz.HORIZONTAL_CNT\n,             zz.VERTICAL_CNT\n--              ,             zz.bay_shelf_nbr\n,             zz.STORE_SCHEMATIC_EFFECTIVE_START_DT\n,             zz.STORE_SCHEMATIC_EFFECTIVE_END_DT\n,             zz.large_pet_supply_3\n,             zz.large_pet_supply_20\n,             zz.spice_pack_ind\n,             case when s.avg_week_item_qty is null then 0 else s.avg_week_item_qty end as avg_week_item_qty\n,             CASE WHEN     s.avg_week_item_qty is null then 'Y'\nWHEN     s.avg_week_item_qty &lt; 1 THEN 'Y' ELSE 'N' END AS slow_moving_ind\n--              ,             CASE WHEN zz.bay_shelf_nbr = 1 AND zz.max_bay_shelf_nbr &lt;&gt; 1 THEN 'Y' ELSE 'N' END AS low_shelf_ind\n--              ,             CASE WHEN zz.bay_shelf_nbr = zz.max_bay_shelf_nbr AND zz.bay_shelf_nbr &lt;&gt; 1 THEN 'Y' ELSE 'N' END AS hi_shelf_ind    \n,             CASE WHEN zz.Item_dsc LIKE 'BANQ%MEGA%' THEN 1\nWHEN zz.Item_dsc LIKE 'BANQ%' THEN 2\nWHEN zz.Item_dsc LIKE 'MICHELINA%BOWL%' THEN 3\nWHEN zz.Item_dsc LIKE 'MICHELINA%' THEN 4\nWHEN CAST(zz.corporate_item_cd AS VARCHAR(9)) LIKE '4805%' THEN 5\nWHEN (zz.Item_dsc LIKE 'DANNON%') AND (((zz.HORIZONTAL_CNT * zz.VERTICAL_CNT) + zz.HORIZONTAL_CNT)&gt;10) THEN 6\nWHEN (zz.Item_dsc LIKE 'EL MONT%') AND (zz.size_qty BETWEEN 4 AND 5) AND (zz.size_uom_cd LIKE 'OZ') THEN 7\nWHEN (zz.Item_dsc LIKE 'JOSE OLE%') AND (zz.size_qty BETWEEN 4 AND 5) AND (zz.size_uom_cd LIKE 'OZ') THEN 8\nWHEN (zz.Item_dsc LIKE 'REDS%') AND (zz.size_qty BETWEEN 4 AND 5) AND (zz.size_uom_cd LIKE 'OZ') THEN 9\nWHEN (zz.Item_dsc LIKE 'TINAS%') AND (zz.size_qty BETWEEN 4 AND 5) AND (zz.size_uom_cd LIKE 'OZ') THEN 10\nWHEN CAST(zz.corporate_item_cd AS VARCHAR(9)) LIKE '4310%'  AND (((zz.HORIZONTAL_CNT * zz.VERTICAL_CNT) + zz.HORIZONTAL_CNT) &gt; 8) THEN 11\nWHEN (CAST(zz.corporate_item_cd AS VARCHAR(9)) LIKE '47%')\nAND NOT\n(zz.Item_dsc LIKE 'GREEN GIANT%'\nOR zz.Item_dsc LIKE 'GG%'\nOR zz.Item_dsc LIKE 'BIRDS EYE%'\nOR zz.Item_dsc LIKE 'BE %'\nOR zz.Item_dsc LIKE 'BESF %'\nOR zz.Item_dsc LIKE 'PICTSWEET%'\nOR zz.Item_dsc LIKE 'PICST%'\nOR zz.Item_dsc LIKE 'PCTS%'\nOR zz.Item_dsc LIKE 'PIC %'\nOR zz.Item_dsc LIKE '%POT%'\nOR zz.Item_dsc LIKE '%TOT%'\nOR zz.Item_dsc LIKE '%HASH%'\nOR zz.Item_dsc LIKE '%FRIES%'\nOR zz.Item_dsc LIKE 'ORE IDA%')\nAND (zz.VERTICAL_CNT::integer BETWEEN 1 AND 2) THEN 12                                WHEN (try_to_number(zz.DEPT_SECTION_ID) = 325) AND (zz.size_qty BETWEEN 0.75 AND 1) AND (zz.size_uom_cd LIKE 'OZ') THEN 13\nWHEN (zz.Item_dsc LIKE '%ROLLS%') AND (((zz.HORIZONTAL_CNT * zz.VERTICAL_CNT) + zz.HORIZONTAL_CNT) &gt;= 32) THEN 14\nWHEN (zz.Item_dsc LIKE '%HUNGRY MAN%' OR zz.Item_dsc LIKE 'HM%') AND (zz.VERTICAL_CNT &gt; 1) THEN 15\nELSE NULL END AS special_item_cd\n\nFROM\n\n--######################################## \nEDM_BIZOPS_PRD.MERCHAPPS.store_ps_item_store_planogram zz\n--######################################## \n\n\n//JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE a\n//ON a.retail_store_facility_nbr = zz.store_id and a.division_id &lt;&gt; 'N/A' and zz.DEPT_SECTION_ID &lt;&gt; 'N/A' and zz.rog_id &lt;&gt; 'N/A' and zz.upc_NBR &lt;&gt; 'N/A' and zz.Item_dsc &lt;&gt; 'N/A' and  zz.store_id &lt;&gt; 'N/A'\n//JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC u\n//ON u.upc_NBR = zz.upc_NBR and u.CORPORATE_ITEM_CD &gt; 0 LEFT JOIN\n\n--########################################         \n(select * from EDM_BIZOPS_PRD.MERCHAPPS.store_ps_sales_by_item_store where AVG_WEEK_ITEM_QTY &gt; 0 and UPC_NBR &gt;0 and STORE_UPC &lt;&gt;'N/A' and STORE_ID &lt;&gt;'N/A')s\n--######################################## \n\nON zz.store_upc = s.store_upc\n\n-- where s.store_upc &lt;&gt; 'N/A' and s.store_id &lt;&gt; 'N/A' and s.avg_week_item_qty  &lt;&gt; 'N/A'\n\n\nGROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16 STEP 4 -\ncreate or replace view EDM_BIZOPS_PRD.MERCHAPPS.STORE_PS_CUSTOM_PS_BY_REQUEST as\nSELECT\na.Retail_Store_Facility_Nbr as store_id,\na.Parent_Operating_Area_Cd as parent_op_area_cd,\nu.section_cd as dept_section_id,\nu.smic_category_id as category_id,\n'2020-01-01' AS start_date,\n'2020-01-01' AS end_date,\nu.CONSUMER_SELLING_CD as csc_id,\nu.corporate_item_cd as corp_item_cd,\nu.upc_nbr as upc_id,\nu.item_dsc as upc_dsc,\nff.ps_value\nFROM\n(select * from (\nSELECT\na.Retail_Store_Facility_Nbr as Retail_Store_Facility_Nbr,\nf.upc_id,\nf.ps_value\nFROM\nEDM_BIZOPS_PRD.SUPPLY_CHAIN.FAR_PS_CUSTOM_VALUES_MERGE_FINAL f\nJOIN EDM_SANDBOX_PRD.MERCHAPPS.D1_RETAIL_STORE a ON try_to_number(a.Parent_Operating_Area_Cd) = f.parent_op_area_cd and a.division_id &gt;0 and f.parent_op_area_cd &gt;0\nWHERE f.store_id IS NULL and a.Retail_Store_Facility_Nbr &lt;&gt; 'N/A'\nAND current_date BETWEEN f.first_eff_dt AND f.last_eff_dt\nGROUP BY 1,2,3\nUNION ALL\nSELECT\nf.store_id,\nf.upc_id,\nf.ps_value\nFROM\nEDM_BIZOPS_PRD.SUPPLY_CHAIN.FAR_PS_CUSTOM_VALUES_MERGE_FINAL f\nWHERE f.store_id IS NOT NULL AND current_date BETWEEN f.first_eff_dt AND f.last_eff_dt and f.store_id &gt;0\nGROUP BY 1,2,3) where retail_store_facility_nbr &gt; 0 and upc_id &gt; 0 and (ps_value=0 or ps_value&gt;0)\n) ff\nJOIN edm_views_prd.dw_views.D1_UPC u ON u.upc_nbr = ff.upc_id and u.CORPORATE_ITEM_CD &gt; 0\nJOIN EDM_SANDBOX_PRD.MERCHAPPS.D1_RETAIL_STORE a ON try_to_number(a.Retail_Store_Facility_Nbr) = ff.Retail_Store_Facility_Nbr and a.division_id &lt;&gt; 'N/A'\nWHERE 1 = 1\n--This is the third spot for filtering\n--AND a.Retail_Store_Facility_Nbr in ('0767')\n--AND a.Parent_Operating_Area_Cd IN (33)\n--AND u.retail_department_id IN (317)\n--AND U.corporate_item_cd IN (65150011)\n--AND u.retail_department_id IN (317,314,323,324,325)\n--AND u.upc_nbr IN (2113045724)                                                                         \n-- End filter area\nGROUP BY  1,2,3,4,5,6,7,8,9,10,11\n\nSTEP 5 -\ncreate or replace view EDM_BIZOPS_PRD.MERCHAPPS.STORE_PS_CHECKSTAND_CANDY as SELECT a.Retail_Store_Facility_Nbr store_id, a.Parent_Operating_Area_Cd  as parent_op_area_cd, u.section_cd as dept_section_id, u.smic_category_id  as category_id, to_date('2020-01-01') AS start_date_dummy, to_date('2020-02-01') AS end_date_dummy, u.CONSUMER_SELLING_CD as csc_id, u.corporate_item_cd as corp_item_cd, z.upc_nbr as upc_id, u.item_dsc as upc_dsc, z.total_ps FROM (\nSELECT facility_integration_id, upc_nbr,\nsum(total_ps) as total_ps\nfrom\n\n(\n(SELECT p.facility_integration_id, p.upc_nbr, p.ps_per_checkstand, r.register_count, sum(p.ps_per_checkstand * r.register_count) AS total_ps\n\nFROM (\nSELECT zz.facility_integration_id, zz.upc_nbr, CASE WHEN round(zz.avg_day_item_qty) &gt; 12 THEN 12 WHEN round(zz.avg_day_item_qty) &lt; 3 THEN 3 ELSE round(zz.avg_day_item_qty) END AS ps_per_checkstand FROM (\nSELECT s.facility_integration_id, s.upc_nbr, sum(s.item_qty) / 364 / count(DISTINCT s.facility_integration_id) AS avg_day_item_qty FROM edm_views_prd.dw_views.sales_aggregate_dy s JOIN (\nSELECT psf.facility_integration_id, psi.UPC_NBR, c.ship_unit_pack_qty as pack_whse_qty FROM edm_views_prd.dw_views.PLANOGRAM_STORE_FIXTURE psf JOIN edm_views_prd.dw_views.Planogram pog ON pog.Planogram_Id = psf.PLANOGRAM_ID AND pog.dw_logical_delete_ind = FALSE AND pog.dw_current_version_ind = True JOIN edm_views_prd.dw_views.PLANOGRAM_SLOT_ITEM psi ON psi.PLANOGRAM_ID = pog.Planogram_Id AND psi.dw_logical_delete_ind = FALSE AND psi.dw_current_version_ind = True JOIN edm_views_prd.dw_views.d1_upc u ON u.upc_nbr = psi.UPC_NBR and u.CORPORATE_ITEM_CD &gt; 0\nJOIN edm_views_prd.dw_views.corporate_item c ON c.CORPORATE_ITEM_INTEGRATION_ID = u.CORPORATE_ITEM_INTEGRATION_ID AND c.corporation_id = 1 AND c.DW_CURRENT_VERSION_IND = TRUE AND c.DW_LOGICAL_DELETE_IND = FALSE WHERE current_date BETWEEN psf.STORE_SCHEMATIC_EFFECTIVE_START_DT - 14 AND psf.STORE_SCHEMATIC_EFFECTIVE_END_DT - 14 AND pog.Stocking_Section_Nbr in (101, 103, 107, 140, 141, 142, 143, 959, 962, 990, 991) AND psf.DW_CURRENT_VERSION_IND = TRUE AND psf.DW_LOGICAL_DELETE_IND = FALSE GROUP BY 1,2,3\n) z ON s.facility_integration_id = z.facility_integration_id AND s.upc_nbr = z.upc_nbr WHERE s.transaction_dt BETWEEN current_date - 365 AND current_date - 1 GROUP BY 1,2\n) zz\n) p JOIN (\nSELECT z.facility_integration_id, count(z.register_nbr) AS register_count FROM (\nSELECT a.facility_integration_id, th.register_nbr, sum(th.net_amt) AS sum_net_amt FROM edm_views_prd.dw_edw_views.txn_hdr th JOIN edm_views_prd.dw_views.D1_RETAIL_STORE a ON try_to_number(a.Retail_Store_Facility_Nbr) = th.store_id and a.division_id &lt;&gt; 'N/A'\nWHERE th.txn_dte &gt;= current_date - 21 AND ((th.register_nbr BETWEEN 1 AND 15) OR (th.register_nbr BETWEEN 116 AND 125)) GROUP BY 1,2\n) z WHERE z.sum_net_amt &gt; 100 GROUP BY 1\n) r ON r.facility_integration_id = p.facility_integration_id GROUP BY 1,2,3,4)\n\n\nunion all\n\n\n(SELECT p.facility_integration_id, p.upc_nbr, p.ps_per_checkstand as ps_per_checkstand_2, r.register_count as register_count_2, sum(p.ps_per_checkstand * r.register_count) AS total_ps\n\nFROM (\nSELECT zz.facility_integration_id, zz.upc_nbr, CASE WHEN round(zz.avg_day_item_qty) &gt; 12 THEN 12 WHEN round(zz.avg_day_item_qty) &lt; 3 THEN 3 ELSE round(zz.avg_day_item_qty) END AS ps_per_checkstand FROM (\nSELECT s.facility_integration_id, s.upc_nbr, sum(s.item_qty) / 364 / count(DISTINCT s.facility_integration_id) AS avg_day_item_qty FROM edm_views_prd.dw_views.sales_aggregate_dy s JOIN (\nSELECT psf.facility_integration_id, psi.UPC_NBR, c.ship_unit_pack_qty as pack_whse_qty FROM edm_views_prd.dw_views.PLANOGRAM_STORE_FIXTURE psf JOIN edm_views_prd.dw_views.Planogram pog ON pog.Planogram_Id = psf.PLANOGRAM_ID AND pog.dw_logical_delete_ind = FALSE AND pog.dw_current_version_ind = True JOIN edm_views_prd.dw_views.PLANOGRAM_SLOT_ITEM psi ON psi.PLANOGRAM_ID = pog.Planogram_Id AND psi.dw_logical_delete_ind = FALSE AND psi.dw_current_version_ind = True JOIN edm_views_prd.dw_views.d1_upc u ON u.upc_nbr = psi.UPC_NBR and u.CORPORATE_ITEM_CD &gt; 0\nJOIN edm_views_prd.dw_views.corporate_item c ON c.CORPORATE_ITEM_INTEGRATION_ID = u.CORPORATE_ITEM_INTEGRATION_ID AND c.corporation_id = 1 AND c.DW_CURRENT_VERSION_IND = TRUE AND c.DW_LOGICAL_DELETE_IND = FALSE WHERE current_date BETWEEN psf.STORE_SCHEMATIC_EFFECTIVE_START_DT - 14 AND psf.STORE_SCHEMATIC_EFFECTIVE_END_DT - 14 AND pog.Stocking_Section_Nbr in (9235,9234,9233,9232,9231,9230,9229,9228,9227,9226,9225,9224,9223,9222,9221,9220,9219,9218,9217,9216,9215,9300,9299,9298,9297,9296,9295,9294,9293,9292,9291,9290,9289,9288,9287,9286,9285,9284,9283,9282,9281,9280\n) AND psf.DW_CURRENT_VERSION_IND = TRUE AND psf.DW_LOGICAL_DELETE_IND = FALSE GROUP BY 1,2,3\n) z ON s.facility_integration_id = z.facility_integration_id AND s.upc_nbr = z.upc_nbr WHERE s.transaction_dt BETWEEN current_date - 365 AND current_date - 1 GROUP BY 1,2\n) zz\n) p JOIN (\nSELECT z.facility_integration_id, count(z.register_nbr) AS register_count FROM (\nSELECT a.facility_integration_id, th.register_nbr, sum(th.net_amt) AS sum_net_amt FROM edm_views_prd.dw_edw_views.txn_hdr th JOIN edm_views_prd.dw_views.D1_RETAIL_STORE a ON try_to_number(a.Retail_Store_Facility_Nbr) = th.store_id and a.division_id &lt;&gt; 'N/A'\nWHERE th.txn_dte &gt;= current_date - 21 AND ((th.register_nbr in (16,17,18,19,20,49,50,51,52,53,54,93,94,95,96,97,98,106,107,108,109,135,136,137,138,139,175,176,177,178,179,180,181,182))) GROUP BY 1,2\n) z WHERE z.sum_net_amt &gt; 100 GROUP BY 1\n) r ON r.facility_integration_id = p.facility_integration_id GROUP BY 1,2,3,4))\n\ngroup by 1,2)z\n\nJOIN edm_views_prd.dw_views.d1_upc u ON u.upc_nbr = z.upc_nbr JOIN EDM_SANDBOX_PRD.MERCHAPPS.D1_RETAIL_STORE a ON a.facility_integration_id = z.facility_integration_id and a.division_id &lt;&gt; 'N/A'\n\nSTEP 6 -\ncreate or replace view EDM_BIZOPS_PRD.MERCHAPPS.store_ps_final_step_2 as SELECT zzz.store_id, zzz.parent_op_area_cd, zzz.dept_section_id, zzz.category_id, zzz.class_id, to_date('2020-01-01') AS start_date_dummy, to_date('2020-02-01') AS end_date_dummy, zzz.csc_id, zzz.corp_item_cd, zzz.upc_id, zzz.upc_dsc, zzz.special_item_cd, zzz.fast_ind, CASE WHEN zzz.dept_section_id = '317' AND zzz.parent_op_area_cd IN ('17', '19', '24', '27', '34') AND min(zzz.ps_value) &lt; 4 THEN 4 WHEN zzz.dept_section_id = '317' AND zzz.class_id IN (440185, 440101, 471510, 473505, 470505, 470105, 473515, 471505, 449000, 470500, 470100, 471000, 480400, 440100, 440500, 473500, 471500, 470501, 473501, 470101, 473510, 471001) AND min(zzz.ps_value) &lt; 4 THEN 4 WHEN zzz.category_id in (2160) and zzz.parent_op_area_cd in (34) THEN CEIL (min(zzz.ps_value) * 1.5)\nELSE min(zzz.ps_value) END AS ps_value --****************************************** below is to get upc and op area\nFROM (\nSELECT ff.store_id, a.Parent_Operating_Area_Cd as parent_op_area_cd, ff.dept_section_id, u.smic_category_id as category_id, u.SMIC_CLASS_ID as class_id, ff.pog_fxtr_start_dt, ff.pog_fxtr_end_dt, u.CONSUMER_SELLING_CD as csc_id, u.corporate_item_cd as corp_item_cd, ff.upc_id, ff.upc_dsc, ff.special_item_cd, ff.fast_ind, min(ff.ps_value) AS ps_value --****************************************** above is to get upc and op area \nFROM (\nSELECT f.store_id, f.dept_section_id, f.upc_nbr as upc_id, f.item_dsc as upc_dsc, f.Fixture_Id as fxtr_cd, f.HORIZONTAL_CNT as hrzntl_face_cnt, f.VERTICAL_CNT as vrtcl_face_cnt, f.STORE_SCHEMATIC_EFFECTIVE_START_DT as pog_fxtr_start_dt, f.STORE_SCHEMATIC_EFFECTIVE_END_DT pog_fxtr_end_dt, f.large_pet_supply_3, f.large_pet_supply_20, f.spice_pack_ind, f.slow_moving_ind, f.special_item_cd, CASE WHEN (jk.upc_id IS NOT NULL AND a.Parent_Operating_Area_Cd = '32') THEN f.HORIZONTAL_CNT --jewel kehe\nWHEN f.special_item_cd IN (13) THEN 24 WHEN f.slow_moving_ind = 'Y' and f.dept_section_id IN ('311', '312') THEN f.HORIZONTAL_CNT ----------APPLY ONLY TO f.dept_section_id IN (311,312)---------\nWHEN f.large_pet_supply_20 = 'Y' THEN 2 WHEN f.large_pet_supply_3 = 'Y' THEN f.HORIZONTAL_CNT WHEN f.spice_pack_ind = 'Y' and c.size_uom_cd = 'OZ' and c.size_qty &lt;= 3 THEN f.HORIZONTAL_CNT * 12 WHEN f.spice_pack_ind = 'Y' and c.size_uom_cd = 'OZ' and c.size_qty &gt; 3 THEN (f.HORIZONTAL_CNT * f.VERTICAL_CNT) + f.HORIZONTAL_CNT\nWHEN (f.dept_section_id IN ('311', '312')) THEN f.HORIZONTAL_CNT ---****----APPLY TO a.Parent_Operating_Area_Cd IN (32), AND REMOVE SECTION 322 /changed to include all div 1/16/23 ---***--------\nWHEN f.dept_section_id IN ('317') and a.Parent_Operating_Area_Cd IN ('30') and f.store_id not in ('0339','1509','1708','3197') THEN CEIL (((f.HORIZONTAL_CNT * f.VERTICAL_CNT) + f.HORIZONTAL_CNT) * 1.5)\nWHEN f.rog_id = 'SACG' AND u.smic_category_id IN (8855, 8856, 8857, 8858, 8859, 8863) AND f.avg_week_item_qty &gt;= 7 THEN ((f.HORIZONTAL_CNT * f.VERTICAL_CNT) + f.VERTICAL_CNT) * 2 WHEN (u.SMIC_CLASS_ID = 80105 AND a.Parent_Operating_Area_Cd in (17, 32)) THEN f.HORIZONTAL_CNT --12pk can soda FOR Jewel/SW\nWHEN (u.SMIC_SUB_SUB_CLASS_ID = 34100100 AND a.Parent_Operating_Area_Cd = '32') THEN f.HORIZONTAL_CNT --Firelogs FOR Jewel\nWHEN (u.smic_category_id = 3430 AND a.Parent_Operating_Area_Cd = '32') THEN f.HORIZONTAL_CNT --bulk road salt FOR Jewel\nWHEN (u.smic_category_id = 3401 AND c.size_uom_cd = 'LB' AND a.Parent_Operating_Area_Cd in ('30', '32')) THEN f.HORIZONTAL_CNT --charcoal FOR Jewel\nWHEN (u.SMIC_CLASS_ID = 329505  AND c.size_uom_cd = 'LB' AND a.Parent_Operating_Area_Cd IN ('25', '32')) THEN f.HORIZONTAL_CNT --bird seed FOR Jewel\nWHEN (f.dept_section_id in ('327', '335') AND c.size_uom_cd = 'LB' and c.size_qty &gt; 4) THEN f.HORIZONTAL_CNT + 1 -- added on 1/16 to apply &gt; 4lbs for charcoal / pet food / bird seed\nWHEN (u.SMIC_SUB_SUB_CLASS_ID = 8152005 AND a.Parent_Operating_Area_Cd = '17') THEN f.HORIZONTAL_CNT --Seltzer FOR SW  \nELSE (f.HORIZONTAL_CNT * f.VERTICAL_CNT) + f.HORIZONTAL_CNT END AS ps_value, CASE WHEN f.rog_id = 'SACG' AND u.smic_category_id IN (8855, 8856, 8857, 8858, 8859, 8863) AND f.avg_week_item_qty &gt;= 7 THEN 'Y' ELSE NULL END AS fast_ind FROM --######################################## \nEDM_BIZOPS_PRD.MERCHAPPS.store_ps_item_sales_combined f -- this is the combination of item and sales to determine slow moving items\n--######################################## \nJOIN EDM_SANDBOX_PRD.MERCHAPPS.D1_RETAIL_STORE a ON a.Retail_Store_Facility_Nbr = f.store_id JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC u ON u.upc_nbr = f.upc_nbr  and u.CORPORATE_ITEM_CD &gt; 0\nLEFT JOIN EDM_VIEWS_PRD.DW_VIEWS.corporate_item c ON c.corporate_item_integration_id = u.corporate_item_integration_id AND c.DW_CURRENT_VERSION_IND = TRUE AND c.DW_LOGICAL_DELETE_IND = FALSE LEFT JOIN (\nSELECT DTL.UPC_NBR as upc_id FROM EDM_VIEWS_PRD.DW_VIEWS.RECEIVE_DELIVERY_INVOICE_HEADER_DSD HDR INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.RECEIVE_DELIVERY_INVOICE_DETAIL_DSD DTL ON HDR.FACILITY_INTEGRATION_ID = DTL.FACILITY_INTEGRATION_ID AND HDR.VENDOR_ID = DTL.VENDOR_ID AND HDR.BACKDOOR_VENDOR_SUB_ACCOUNT_ID = DTL.BACKDOOR_VENDOR_SUB_ACCOUNT_ID AND HDR.LOAD_DT = DTL.LOAD_DT --AND HDR.INVOICE_TYPE_CD = DTL.INVOICE_TYPE_CD \nAND HDR.VENDOR_INVOICE_NBR = DTL.VENDOR_INVOICE_NBR INNER JOIN EDM_SANDBOX_PRD.MERCHAPPS.D1_RETAIL_STORE RETAIL_STORE ON RETAIL_STORE.FACILITY_INTEGRATION_ID = HDR.FACILITY_INTEGRATION_ID AND RETAIL_STORE.DW_LOGICAL_DELETE_IND = FALSE --AND RETAIL_STORE.DW_CURRENT_VERSION_IND = TRUE \nWHERE 1 = 1 AND HDR.DW_LOGICAL_DELETE_IND = FALSE AND HDR.DW_CURRENT_VERSION_IND = TRUE AND DTL.DW_LOGICAL_DELETE_IND = FALSE AND DTL.DW_CURRENT_VERSION_IND = TRUE AND RETAIL_STORE.division_id = '32' AND HDR.RECEIVE_DT &gt; current_Date - 364 AND HDR.VENDOR_ID = '006446' GROUP BY 1) jk ON jk.upc_id = f.upc_nbr) ff --****************************************** below is to get upc and op area\nJOIN EDM_SANDBOX_PRD.MERCHAPPS.D1_RETAIL_STORE a ON a.Retail_Store_Facility_Nbr = ff.store_id and a.division_id &lt;&gt; 'N/A'\nJOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC u ON u.upc_nbr = ff.upc_id AND u.corporation_id = 1 AND u.corporate_item_cd &gt; 0 GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13) zzz GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13\n\nSTEP 7 -\ncreate or replace table EDM_BIZOPS_PRD.MERCHAPPS.store_ps_logic_new_table as SELECT CASE WHEN f.store_id IS NULL THEN p.store_id ELSE f.store_id END AS store_id, CASE WHEN f.store_id IS NULL THEN p.parent_op_area_cd ELSE f.parent_op_area_cd END AS parent_op_area_cd, CASE WHEN f.store_id IS NULL THEN p.dept_section_id ELSE f.dept_section_id END AS dept_section_id, CASE WHEN f.store_id IS NULL THEN p.category_id ELSE f.category_id END AS category_id, CASE WHEN f.store_id IS NULL THEN p.start_date_dummy ELSE f.start_date END AS start_date_dummy, CASE WHEN f.store_id IS NULL THEN p.end_date_dummy ELSE f.end_date END AS end_date_dummy, CASE WHEN f.store_id IS NULL THEN p.csc_id ELSE f.csc_id END AS csc_id, CASE WHEN f.store_id IS NULL THEN p.corp_item_cd ELSE f.corp_item_cd END AS corp_item_cd, CASE WHEN f.store_id IS NULL THEN p.upc_id ELSE f.upc_id END AS upc_id, CASE WHEN f.store_id IS NULL THEN p.upc_dsc ELSE f.upc_dsc END AS upc_dsc, CASE WHEN candy.store_id IS NOT NULL THEN candy.total_ps WHEN f.store_id IS NOT NULL THEN f.ps_value WHEN f.parent_op_area_cd IS NOT NULL THEN f.ps_value ELSE p.ps_value END AS ps_value, CASE WHEN f.store_id IS NULL THEN NULL ELSE 'Y' END AS custom_ps_ind FROM --######################################## \n(select * from EDM_BIZOPS_PRD.MERCHAPPS.store_ps_final_step_2 where parent_op_area_cd &gt;0 and store_id &lt;&gt; 'N/A' and parent_op_area_cd &lt;&gt; 'N/A') p --######################################## \n\nFULL OUTER JOIN --######################################## \n(select * from EDM_BIZOPS_PRD.MERCHAPPS.store_ps_custom_ps_by_request where (ps_value &gt;0 or ps_value=0) and store_id &gt;0 ) f --########################################\n\nON f.store_id  || '-' || f.upc_id = p.store_id || '-' || p.upc_id and f.ps_value &gt; 0 and  f.store_id &gt; 0 and  f.upc_id &gt; 0\n\nLEFT JOIN --######################################## \n(select * from EDM_BIZOPS_PRD.MERCHAPPS.store_ps_checkstand_candy where (total_ps=0 or total_ps&gt;0)) candy\n--########################################  \n\nON p.store_id  || '-' || p.upc_id = candy.store_id || '-' || candy.upc_id and total_ps &gt; 0\n\nSTEP 8 -\ncreate or replace table EDM_BIZOPS_PRD.SUPPLY_CHAIN.store_ps_logic_new_table as select * from EDM_BIZOPS_PRD.MERCHAPPS.store_ps_logic_new_table\n</code></pre>"},{"location":"supplychain_sql/","title":"Supply Chain SQL","text":""},{"location":"supplychain_sql/#store-inventory","title":"Store Inventory","text":"<pre><code>select corporate_item_cd,\nretail_item_dsc,\ndistribution_center_id,\nrog_id,\ntxn_dte,\nsum(onhand_qty) as onhand_qty,\nsum(oos_day_flg) as oos_day_flg\nfrom\n(SELECT  DISTINCT C.CORPORATE_ITEM_CD,\nC.RETAIL_ITEM_DSC, SOC.WAREHOUSE_ID,\nlpad(rs.FACILITY_NBR,4,'0') AS STORE_ID, rs.DIVISION_ID AS STORE_DIVISION,\nSOC.DISTRIBUTION_CENTER_ID,\nSOC.ROG_ID,\nii.ONHAND_QTY,\nii.TXN_DTE,\nii.WEEK_ID,\ncase when ONHAND_QTY &lt;= 0 then 1 else 0 end OOS_DAY_FLG\nFROM    (\nSELECT\nCL.CALENDAR_DT AS TXN_DTE, CL.FISCAL_YEAR_NBR||CL.FISCAL_WEEK_NBR AS WEEK_ID,\nFACILITY_INTEGRATION_ID,\nCORPORATE_ITEM_INTEGRATION_ID,\nONHAND_QTY\nFROM   (\nSELECT  FACILITY_INTEGRATION_ID\n,CORPORATE_ITEM_INTEGRATION_ID\n,TXN_DTE\n,ITEM_QTY AS ONHAND_QTY\n,lead(TXN_DTE,1,CURRENT_DATE + 1) over(PARTITION BY FACILITY_INTEGRATION_ID, CORPORATE_ITEM_INTEGRATION_ID ORDER BY TXN_DTE asc) as lead_txn_dte\nFROM    (\nSELECT  II.FACILITY_INTEGRATION_ID, II.CORPORATE_ITEM_INTEGRATION_ID, DATE(II.TRANSACTION_TS) TXN_DTE, II.ITEM_QTY\nFROM    EDM_VIEWS_PRD.DW_VIEWS.INVENTORY_ITEM II\nWHERE   DW_CURRENT_VERSION_IND = TRUE\nAND     DW_LOGICAL_DELETE_IND = FALSE\nAND     INVENTORY_TYPE_CD = 'PP'\nAND     DATE(TRANSACTION_TS) &gt;=  current_date - 7 QUALIFY ROW_NUMBER() OVER(PARTITION BY II.FACILITY_INTEGRATION_ID, II.CORPORATE_ITEM_INTEGRATION_ID, DATE(TRANSACTION_TS) ORDER BY TRANSACTION_TS DESC) = 1 )\n) inv\njoin    EDM_VIEWS_PRD.DW_VIEWS.CALENDAR cl on    cl.CALENDAR_DT &gt;= inv.txn_dte AND    cl.CALENDAR_DT &lt; lead_txn_dte WHERE   CL.CALENDAR_DT =  current_date - 1\nAND     CL.DW_CURRENT_VERSION_IND = TRUE\n) II\nJOIN   (\nselect *\nfrom EDM_VIEWS_PRD.DW_VIEWS.STORE_ORDER_CATALOG soc WHERE   SOC.DW_CURRENT_VERSION_IND = TRUE\nAND     SOC.DW_LOGICAL_DELETE_IND = FALSE\nAND     SOC.PERPETUAL_INVENTORY_IND = 'Y'\nQUALIFY row_number() over (partition by store_facility_integration_id, corporate_item_integration_id order by dw_first_effective_dt desc) = 1\n) SOC   ON SOC.store_facility_integration_id = II.FACILITY_INTEGRATION_ID AND SOC.corporate_item_integration_id = II.corporate_item_integration_id\nAND II.TXN_DTE between AUTHORIZATION_FIRST_EFFECTIVE_TS AND AUTHORIZATION_LAST_EFFECTIVE_TS\nJOIN    EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM C ON C.CORPORATE_ITEM_INTEGRATION_ID = SOC.CORPORATE_ITEM_INTEGRATION_ID\nJOIN EDM_VIEWS_PRD.DW_VIEWS.SMIC_GROUP SG ON C.SMIC_GROUP_CD = SG.SMIC_GROUP_CD\nJOIN EDM_VIEWS_PRD.DW_VIEWS.SMIC_CATEGORY SC ON C.SMIC_GROUP_CD = SC.SMIC_GROUP_CD  and C.SMIC_CATEGORY_CD = SC.SMIC_CATEGORY_CD\nJOIN EDM_VIEWS_PRD.DW_VIEWS.SMIC_CLASS SCL ON C.SMIC_GROUP_CD = SCL.SMIC_GROUP_CD and C.SMIC_CATEGORY_CD = SCL.SMIC_CATEGORY_CD\nand C.SMIC_CLASS_CD=SCL.SMIC_CLASS_CD\nJOIN    EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE RS ON RS.FACILITY_INTEGRATION_ID = SOC.STORE_FACILITY_INTEGRATION_ID\nJOIN    EDM_VIEWS_PRD.DW_VIEWS.FACILITY_ADDRESS FA ON RS.FACILITY_INTEGRATION_ID = FA.FACILITY_INTEGRATION_ID\nWHERE   C.DW_CURRENT_VERSION_IND = TRUE\nAND     SG.DW_CURRENT_VERSION_IND = TRUE\nAND     SC.DW_CURRENT_VERSION_IND = TRUE\nAND     SCL.DW_CURRENT_VERSION_IND = TRUE\nAND     RS.DW_CURRENT_VERSION_IND = TRUE\nAND     RS.DW_LOGICAL_DELETE_IND = FALSE\nAND     FA.DW_CURRENT_VERSION_IND = TRUE\nAND     FA.DW_LOGICAL_DELETE_IND = FALSE) group by 1,2,3,4,5\n</code></pre>"},{"location":"supplychain_sql/#warehouse-inventory-activities","title":"Warehouse Inventory Activities","text":"<pre><code>select\ncic.corporate_item_cd\n, cic.ship_unit_pack_qty\n, winv.warehouse_id\n, wh.distribution_center_id as warehouse_nm\n, sum(transaction_qty) as sum_transaction_qty\n, sum(available_qty) as sum_available_qty\n, sum(allocated_qty) as sum_allocated_qty\n, sum(blocked_qty) as sum_blocked_qty\n, sum(inbound_transit_qty) as sum_inbound_transit_qty\n, sum(day_inbound_transit_qty) as sum_day_inbound_transit_qty\n, sum(sum_order_qty) as sum_on_order_qty\n, sum(total_onhand_qty) as sum_total_onhand_qty\nfrom edm_views_prd.dw_views.inventory_balance winv\njoin edm_views_prd.dw_views.corporate_item cic\non cic.corporate_item_integration_id = winv.corporate_item_integration_id and current_date between cic.dw_first_effective_dt and cic.dw_last_effective_dt and cic.corporation_id = 1\n-- join edm_views_prd.dw_views.supply_chain_item sci\n-- on sci.corporate_item_integration_id = winv.corporate_item_integration_id\n-- and current_date between sci.dw_first_effective_dt and sci.dw_last_effective_dt\njoin edm_views_prd.dw_views.warehouse wh\non wh.warehouse_id = winv.warehouse_id and wh.corporation_id=1 and current_date between wh.dw_first_effective_dt and wh.dw_last_effective_dt\njoin\n( select\nwarehouse_id\n, corporate_item_integration_id\n, max(transaction_ts) as max_ts\n\nfrom edm_views_prd.dw_views.inventory_balance\nwhere\ndw_current_version_ind = true\nand dw_logical_delete_ind = false\ngroup by\nwarehouse_id\n, corporate_item_integration_id\n) mxts\non mxts.warehouse_id = winv.warehouse_id\nand mxts.corporate_item_integration_id = winv.corporate_item_integration_id\nand mxts.max_ts = winv.transaction_ts  and cic.corporate_item_cd in (11101812)\nand winv.dw_current_version_ind = true and winv.dw_logical_delete_ind = false left join (select distribution_center_id, corporate_item_cd, max(sum_order_qty)  as sum_order_qty from \"EDM_BIZOPS_PRD\".\"MERCHAPPS\".\"zhu_warehouse_future_po\" where promised_delivery_ts between current_date and current_date + 7 group by 1,2) po on po.distribution_center_id = wh.distribution_center_id and po.corporate_item_cd = cic.corporate_item_cd group by 1, 2, 3, 4\n</code></pre>"},{"location":"supplychain_sql/#store-order-delivery","title":"Store Order Delivery","text":"<pre><code>SELECT SCHEDULE_GROUP_CD         AS DPATS_GROUP_CD,     RETAIL_STORE_FACILITY_NBR AS STORE_ID,\nDATA_BATCH_ID             AS DATA_BATCH_CD,\nEFFECTIVE_DT              AS SCHED_EFF_DT,\nCASE WHEN SDET.Process_Week_Day_Nm = 'SUNDAY'    AND Process_Week_Day_Nbr &lt; 8  THEN SCHED.Effective_Dt\nWHEN SDET.Process_Week_Day_Nm = 'SUNDAY'    AND Process_Week_Day_Nbr &gt; 7  THEN DATEADD(day, 7,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'MONDAY'    AND Process_Week_Day_Nbr &lt; 9  THEN DATEADD(day, 1,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'MONDAY'    AND Process_Week_Day_Nbr &gt; 8  THEN DATEADD(day, 8,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'TUESDAY'   AND Process_Week_Day_Nbr &lt; 10 THEN DATEADD(day, 2,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'TUESDAY'   AND Process_Week_Day_Nbr &gt; 9  THEN DATEADD(day, 9,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'WEDNESDAY' AND Process_Week_Day_Nbr &lt; 11 THEN DATEADD(day, 3,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'WEDNESDAY' AND Process_Week_Day_Nbr &gt; 10 THEN DATEADD(day, 10, SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'THURSDAY'  AND Process_Week_Day_Nbr &lt; 12 THEN DATEADD(day, 4,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'THURSDAY'  AND Process_Week_Day_Nbr &gt; 11 THEN DATEADD(day, 11, SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'FRIDAY'    AND Process_Week_Day_Nbr &lt; 13 THEN DATEADD(day, 5,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'FRIDAY'    AND Process_Week_Day_Nbr &gt; 12 THEN DATEADD(day, 12, SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'SATURDAY'  AND Process_Week_Day_Nbr &lt; 14 THEN DATEADD(day, 6,  SCHED.Effective_Dt)\nWHEN SDET.Process_Week_Day_Nm = 'SATURDAY'  AND Process_Week_Day_Nbr &gt; 13 THEN DATEADD(day, 13, SCHED.Effective_Dt) END AS ORDER_DT,\nSCHEDULE_CUTOFF_TM AS POLL_TM,\nDATEADD(day, SDET.Process_Week_Day_Nbr -1, SCHED.Effective_Dt)  AS PICK_DT,\nDATEADD(day, SDET.Delivery_Week_Day_Nbr -1, SCHED.Effective_Dt) AS DELIVERY_DT,\nDATEADD(day, SDET.Process_Week_Day_Nbr + SDET.Offset_Value_Week_Day_Nbr -1, SCHED.Effective_Dt) AS AVAIL_DT\n\nFROM DW_VIEWS.SHIPMENT_SCHEDULE SCHED\n\nJOIN DW_VIEWS.SHIPMENT_SCHEDULE_DETAIL SDET\nON SCHED.SHIPMENT_SCHEDULE_INTEGRATION_ID = SDET.SHIPMENT_SCHEDULE_INTEGRATION_ID\n\nJOIN DW_VIEWS.D1_RETAIL_STORE STR\nON SCHED.DESTINATION_FACILITY_INTEGRATION_ID = STR.FACILITY_INTEGRATION_ID\n\nWHERE SCHEDULE_GROUP_CD= '25'\n--WHERE sched_eff_dt ='2022-04-17'\n\nAND RETAIL_STORE_FACILITY_NBR IN ('1953')\nAND EFFECTIVE_DT = '2022-04-24'\n\nAND DATA_BATCH_ID = '0129'\nAND DATA_BATCH_ID NOT IN ('5601','5602','5603','5604','5605','5606','5607','5608','5613',\n5614','5615','5616','5651','8811','8812','8826','8832','8834','8841')\n\nORDER BY 1,6    -- STORE_ID, order_dt;\n</code></pre>"},{"location":"supplychain_sql/#warehouse-shipment-to-store","title":"Warehouse Shipment to Store","text":"<pre><code>SELECT DISTINCT SCIH.DIVISION_ID, WHSE.WAREHOUSE_ID, --WHSE_ID\nWHSE.WAREHOUSE_NM, --whs.whse_nm, \nSCIH.ORDER_NBR,\nSTORE.RETAIL_STORE_FACILITY_NBR,\nDTE.FISCAL_YEAR_NBR || LPAD(DTE.FISCAL_PERIOD_NBR,2,0),\nTO_CHAR(SUM(SCID.SHIPPED_QTY),'999,999,999.99') AS SHIPMENTS, SCIH.INVOICE_CREATE_DT\n\nFROM DW_VIEWS.SUPPLY_CHAIN_INVOICE_HEADER SCIH\n\nJOIN DW_VIEWS.SUPPLY_CHAIN_INVOICE_DETAIL SCID\nON SCIH.SUPPLY_CHAIN_INVOICE_INTEGRATION_ID = SCID.SUPPLY_CHAIN_INVOICE_INTEGRATION_ID\nAND SCID.DW_CURRENT_VERSION_IND = TRUE\n\nJOIN DW_VIEWS.D1_RETAIL_STORE STORE\nON SCIH.RETAIL_STORE_FACILITY_INTEGRATION_ID = STORE.FACILITY_INTEGRATION_ID\n\nJOIN DW_VIEWS.D0_FISCAL_DAY DTE\nON DTE.CALENDAR_DT = SCIH.INVOICE_CREATE_DT\n\nJOIN DW_VIEWS.DATA_BATCH WDR  --DSS.whse_databatch_rog wdr\nON SCIH.WAREHOUSE_ID = WDR.WAREHOUSE_ID\n\nJOIN DW_VIEWS.WAREHOUSE WHSE\nON WHSE.WAREHOUSE_ID = WDR.WAREHOUSE_ID\n\nWHERE 1 = 1\nAND SCIH.CORPORATION_ID = 1 --wsi.ship_corp_id = 1\nAND WDR.PRIMARY_IND = 'Y'\n--AND wsi.ship_corp_id = wsi.dest_corp_id\n--AND SCIH.INVOICE_CREATE_DT BETWEEN '04/06/2022' AND '04/28/2022' --CURRENT_DATE\nAND SCIH.INVOICE_CREATE_DT BETWEEN '2022-04-06' AND '2022-04-28' --CURRENT_DATE\nand STORE.RETAIL_STORE_FACILITY_NBR = '0169' --wsi.store_id in ('0169')\nand WHSE.WAREHOUSE_ID = '5229'  --wsi.whse_cd= '5229'\nAND SCIH.DW_CURRENT_VERSION_IND = TRUE\n\nGROUP BY SCIH.DIVISION_ID,\nSCIH.ORDER_NBR, --.wsi.whse_ordER_nbr,\n\nWHSE.WAREHOUSE_ID, --WHSE_ID\nWHSE.WAREHOUSE_NM, --whs.whse_nm, \nDTE.FISCAL_YEAR_NBR,  --dte.period_id\nDTE.FISCAL_PERIOD_NBR,  --dte.period_id\nSCIH.INVOICE_CREATE_DT\n</code></pre>"},{"location":"supplychain_sql/#warehouse-order-qty-pack","title":"Warehouse Order Qty Pack","text":"<pre><code>select warehouse_id, order_pack_qty from EDM_VIEWS_PRD.DW_VIEWS.SUPPLY_CHAIN_ITEM a join EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM b on a.corporate_item_integration_id = b.corporate_item_integration_id\nand current_date between a.dw_first_effective_dt and a.dw_last_effective_dt and current_date between b.dw_first_effective_dt and b.dw_last_effective_dt and a.DW_CURRENT_VERSION_IND = 1 and b.DW_CURRENT_VERSION_IND = 1\nand corporate_item_cd = 73500114\n</code></pre>"},{"location":"supplychain_sql/#volume-plan-for-supply-chain","title":"Volume plan for supply chain.","text":"<pre><code>WITH CAL AS (SELECT PROMOTION_WEEK_ID\n,PROMOTION_WEEK_START_DT FROM (SELECT DISTINCT PROMOTION_WEEK_ID\n,DIVISION_ID\n,PROMOTION_WEEK_START_DT ,1 FROM EDM_VIEWS_PRD.DW_VIEWS.D1_PROMOTION_CALENDAR_WEEK\nWHERE PROMOTION_WEEK_END_DT &lt; CURRENT_DATE()\nAND DIVISION_ID = '19')\n\nQUALIFY ROW_NUMBER() OVER (PARTITION BY DIVISION_ID,1 ORDER BY PROMOTION_WEEK_ID DESC) &lt; 60)    SELECT WEEK_ID,\nA.CORPORATE_ITEM_CD AS CIC,\nA.DIVISION_NM, --TRY_TO_NUMBER(WEEK1.DIVISION_ID) AS DIVISION_ID,\nCASE\nWHEN A.DIVISION_NM = 'PORTLAND' THEN 19\nWHEN A.DIVISION_NM = 'SEATTLE' THEN 27\nWHEN A.DIVISION_NM = 'NOR CALIFORNIA' THEN 25\nWHEN A.DIVISION_NM = 'SO CALIFORNIA' THEN 29\nWHEN A.DIVISION_NM = 'SOUTHWEST' THEN 17\nWHEN A.DIVISION_NM = 'DENVER' THEN 5\nWHEN A.DIVISION_NM = 'MID-ATLANTIC' THEN 34\nWHEN A.DIVISION_NM = 'INTERMOUNTAIN' THEN 30\nWHEN A.DIVISION_NM = 'JEWEL' THEN 32\nWHEN A.DIVISION_NM = 'SOUTHERN' THEN 20\nWHEN A.DIVISION_NM = 'SHAWS' THEN 33\nEND AS DIVISION_ID,    A.ROG_ID AS ROG,\nC.DISTRIBUTION_CENTER_ID AS DC,\nE.UPC_NBR AS UPC,\nITM.SHIP_UNIT_PACK_QTY AS \"Case size\",\nC.VENDOR_ID||C.VENDOR_SUB_ACCOUNT_ID||C.WIMS_SUB_VENDOR_NBR AS VEND_KEY,\nWEEK2.PROMOTION_WEEK_ID AS \"Time-shifted week ID\",\nWEEK2.PROMOTION_WEEK_START_DT AS \"Calendar date\",\nWEEK2.PROMOTION_WEEK_START_DT + 364 AS CALENDAR_DT,    ROUND((D.LEAD_TIME_DYS+7)/7) AS \"Total lead time (weeks)\",\nSUM(PROMOTED_UNIT_NBR) AS \"Promoted units\",\nSUM(NON_PROMO_UNIT_NBR) AS \"Non-promoted units\",\n\"Promoted units\" + \"Non-promoted units\" AS \"Total Units\",\nDIV0((\"Promoted units\" + \"Non-promoted units\"),ITM.SHIP_UNIT_PACK_QTY) AS \"Total Cases\" FROM EDM_VIEWS_PRD.DW_VIEWS.PROMO_PERF_RPT A\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM B\nON A.CORPORATE_ITEM_CD = B.CORPORATE_ITEM_CD\nAND B.DW_CURRENT_VERSION_IND = 1\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM_UPC_REFERENCE E\nON E.CORPORATE_ITEM_INTEGRATION_ID = B.CORPORATE_ITEM_INTEGRATION_ID\nAND E.DW_CURRENT_VERSION_IND = 1\nINNER JOIN (SELECT DISTINCT\nCORPORATE_ITEM_INTEGRATION_ID\n,DISTRIBUTION_CENTER_ID\n,WAREHOUSE_ID\n,ROG_ID\n,VENDOR_ID\n,VENDOR_SUB_ACCOUNT_ID\n,WIMS_SUB_VENDOR_NBR\nFROM EDM_VIEWS_PRD.DW_VIEWS.STORE_ORDER_CATALOG WHERE DW_CURRENT_VERSION_IND = 1\nAND DISTRIBUTION_CENTER_ID IS NOT NULL\nAND WIMS_SUB_VENDOR_NBR IS NOT NULL) C\nON A.ROG_ID = C.ROG_ID\nAND B.CORPORATE_ITEM_INTEGRATION_ID = C.CORPORATE_ITEM_INTEGRATION_ID\nINNER JOIN (SELECT VENDOR_ID,VENDOR_SUB_ACCOUNT_ID,WIMS_SUB_VENDOR_NBR,LEAD_TIME_DYS,WAREHOUSE_ID,DISTRIBUTION_CENTER_ID FROM  EDM_VIEWS_PRD.DW_VIEWS.VENDOR_WAREHOUSE WHERE DISTRIBUTION_CENTER_ID &lt;&gt; ''\nQUALIFY ROW_NUMBER() OVER (PARTITION BY WAREHOUSE_ID,VENDOR_ID,VENDOR_SUB_ACCOUNT_ID,WIMS_SUB_VENDOR_NBR ORDER BY DW_LAST_EFFECTIVE_DT DESC) = 1) D\nON D.DISTRIBUTION_CENTER_ID = C.DISTRIBUTION_CENTER_ID\nAND D.VENDOR_ID = C.VENDOR_ID\nAND D.VENDOR_SUB_ACCOUNT_ID = C.VENDOR_SUB_ACCOUNT_ID\nAND D.WIMS_SUB_VENDOR_NBR = C.WIMS_SUB_VENDOR_NBR\nAND D.WAREHOUSE_ID = C.WAREHOUSE_ID /*INNER JOIN CAL WEEK1\n    ON TO_NUMBER(WEEK1.DIVISION_ID)::INTEGER = A.DIVISION_ID  \n    AND WEEK1.PROMOTION_WEEK_ID = A.WEEK_ID*/\nINNER JOIN CAL WEEK1\n--ON WEEK1.DIVISION_NM = A.DIVISION_NM\nON WEEK1.PROMOTION_WEEK_ID = A.WEEK_ID INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_PROMOTION_CALENDAR_WEEK WEEK2\n--ON WEEK2.DIVISION_ID = WEEK1.DIVISION_ID\nON WEEK2.PROMOTION_WEEK_START_DT = WEEK1.PROMOTION_WEEK_START_DT - ROUND((D.LEAD_TIME_DYS+7)/7)*7\nAND WEEK2.DIVISION_ID = '19'\nINNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SUPPLY_CHAIN_ITEM ITM\nON ITM.WAREHOUSE_ID = D.WAREHOUSE_ID\nAND ITM.WAREHOUSE_ID = C.WAREHOUSE_ID\nAND ITM.CORPORATE_ITEM_INTEGRATION_ID = B.CORPORATE_ITEM_INTEGRATION_ID\nAND ITM.DW_CURRENT_VERSION_IND = 1\n\nWHERE 1=1\n--AND CATEGORY_ID IN (2501,2505,2510,2515,2520,2525,2530,2535,3001,3002,3003,3004)\n--AND QUARTER_ID IN (20221,20222,20223,20224,20231) \nAND DEPARTMENT_ID IN (301,303,311,314,317,336)\n/*AND A.CORPORATE_ITEM_CD IN (30020337,30020334,30020425,30040167,30040160,30040207,30040199,30040213,30040128,30040162,\n                     30010374,30010376,25010054,25010057,25250643,25250644,30040053,30040087,30040089,30040083,\n                     30040077,30040064,30020183,30020326,30020327,25250643,25250644)*/\n\nGROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13);\n</code></pre>"},{"location":"supplychain_sql/#all-warehouse-items","title":"All Warehouse Items","text":"<pre><code>select\ndistinct sci.division_id DIVISION,\nsci.distribution_center_id DST_CNTR,\nsci.warehouse_id FACILITY,\nci.corporate_item_cd CORP_ITEM_CD,\nci.Item_Dsc ITEM_DESCRIPTION,\ncase\nwhen sci.warehouse_id like '20%' then sci.System_Specific_Item_Id\nelse sci.branch_item_cd\nend WHS_ITEM,\nsci.Ship_Unit_Pack_Qty PACK_WHSE,\nsci.warehouse_item_status_cd STATUS_DST,\nci.Size_Qty || ' ' || ci.Size_UOM_Cd SIZE,\nwc.ITEM_BILLING_COST_AMT IB_COST,\nwc.VENDOR_ID || '-' || vm.vendor_nm VENDOR,\ncoalesce(ifc.SINGLE_SMOOTHED_VALUE_NBR, 0) as SSV1,\ncast(\nconcat(\nlpad(ssc.smic_group_cd, 2, '0'),\nlpad(ssc.SMIC_Category_Cd, 2, '0'),\nlpad(ssc.SMIC_Class_Cd, 2, '0'),\nlpad(ssc.SMIC_Sub_Class_Cd, 2, '0')\n) as int\n) as CODE_KEY,\nm.team_mgr_cd || '-' || m.team_mgr_nm MANAGER,\nb.buyer_id || '-' || b.buyer_nm BUYER,\ncase\nwhen sci.distribution_center_id = 'WSPK' then '32'\nelse whse.OLD_DISTRIBUTION_CENTER_CD\nend as DC_ID,\ncase\nwhen sci.warehouse_id = '3345' then '04'\nelse whse.PHYSICAL_WAREHOUSE_GROUP_ID\nend as WH_ID,\nsc.Section_Cd || '-' || sc.Section_Nm RETAIL_SECTION,\ndept.department_id || '-' || dept.department_nm DEPARTMENT,\n'' as FORECAST,\ng.SMIC_GROUP_CD || '-' || g.SMIC_GROUP_DSC GROUP_CLASSIFICATION,\ncat.SMIC_Group_Cd || cat.smic_category_nm || '-' || cat.SMIC_Category_DSC SMIC_CLASSIFICATION\nfrom\nEDM_VIEWS_PRD.DW_VIEWS.Supply_Chain_Item sci\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.corporate_item ci on ci.corporate_item_integration_id = sci.corporate_item_integration_id\nand ci.dw_current_version_ind = true\nand ci.dw_logical_delete_ind = false\nand sci.dw_current_version_ind = true\nand sci.dw_logical_delete_ind = false\nleft outer join (\nselect\n*\nfrom\nEDM_VIEWS_PRD.DW_VIEWS.vendor_warehouse_item_cost\nwhere\ndw_current_version_ind = true\nand dw_logical_delete_ind = false QUALIFY row_number() over (\npartition by WAREHOUSE_ID,\nCORPORATE_ITEM_INTEGRATION_ID\norder by\nsource_creation_dt desc\n) = 1\n) wc on wc.division_id = sci.division_id\nand wc.warehouse_id = sci.warehouse_id\nand wc.corporate_item_integration_id = sci.corporate_item_integration_id\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.SMIC_Sub_Class ssc on ci.smic_group_cd = ssc.smic_group_cd\nand ci.smic_category_cd = ssc.smic_category_cd\nand ci.smic_class_cd = ssc.smic_class_cd\nand ci.smic_sub_class_cd = ssc.smic_sub_class_cd\nand ssc.dw_current_version_ind = true\nand ssc.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.smic_group g on g.SMIC_GROUP_CD = ci.SMIC_Group_Cd\nand g.dw_current_version_ind = true\nand g.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.smic_category cat on cat.SMIC_group_cd = ci.SMIC_Group_Cd\nand cat.SMIC_Category_nm = ci.SMIC_Category_Cd\nand cat.dw_current_version_ind = true\nand cat.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.warehouse whse on whse.division_id = sci.division_id\nand whse.WAREHOUSE_ID = sci.warehouse_id\nand whse.dw_current_version_ind = true\nand whse.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.buyer b on sci.buyer_id = b.buyer_id\nand b.dw_current_version_ind = true\nand b.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.WMMGROPT m ON b.BUYER_MANAGER_CD = m.TEAM_MGR_CD\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.vendor_master vm on wc.VENDOR_ID = vm.vendor_id\nand vm.dw_current_version_ind = true\nand vm.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.Retail_Section r on r.Section_Cd = cat.Section_Cd\nand r.dw_current_version_ind = true\nand r.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.department dept on dept.department_id = r.Retail_Department_Id\nand dept.dw_current_version_ind = true\nand dept.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.Section sc on sc.section_cd = r.section_cd\nand sc.dw_current_version_ind = true\nand sc.dw_logical_delete_ind = false\nleft outer join EDM_VIEWS_PRD.DW_VIEWS.Item_forecast ifc on wc.division_id = ifc.division_id\nand wc.warehouse_id = ifc.warehouse_id\nand wc.corporate_item_integration_id = ifc.corporate_item_integration_id\nand ifc.dw_current_version_ind = true\nand ifc.dw_logical_delete_ind = false\nwhere\n1 = 1\nand sci.distribution_center_id like 'W%'\nand whse.WAREHOUSE_ID is not null\nand ci.corporate_item_cd is not null\nand b.BUYER_ID is not null\nand (\nvm.vendor_status_cd = 'A'\nor vm.vendor_status_cd is null\n)\n</code></pre>"}]}