# Merch SQL

## Hourly Sales

<!-- === "Hourly Sales" -->

```sql
SELECT
TRY_TO_NUMBER(LUS.DISTRICT_CD)::INTEGER AS DISTRICT_ID
,HDR.STORE_ID
,REF.RTL_DEPT_ID
,LDAY.DAY_OF_FISCAL_WEEK_NBR AS WEEKDAY_NBR
,HDR.TXN_DTE
,EXTRACT(HOUR FROM HDR.TXN_TM) AS TXN_HOUR
,SUM(ITM.NET_AMT) AS SALES
,COUNT(DISTINCT HDR.TXN_ID) AS BASKETS

FROM EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_HDR HDR
INNER JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_ITEM ITM
    ON HDR.TXN_DTE = ITM.TXN_DT
    AND HDR.TXN_ID = ITM.TXN_ID
    AND ITM.DTL_SUBTYPE_ID NOT IN (4)
    AND HDR.TXN_DTE BETWEEN '06/20/2021' AND '09/11/2021'
INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE LUS
    ON TRY_TO_NUMBER(LUS.RETAIL_STORE_FACILITY_NBR)::INTEGER = HDR.STORE_ID
    AND LUS.DIVISION_ID = '19'
    AND LUS.RETAIL_STORE_FACILITY_NBR NOT IN ('1542','4904')
INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D0_FISCAL_DAY LDAY
    ON LDAY.CALENDAR_DT = HDR.TXN_DTE
INNER JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.DEPT_XREF REF
    ON REF.TLOG_DEPT_ID = ITM.STORE_DEPT_ID
    AND HDR.STORE_ID = REF.STORE_ID
group by 1,2,3,4,5,6;
```

## Category Report by Week

```sql
select
FISCAL_WEEK_ID AS week_id,
FISCAL_PERIOD_ID as PERIOD_ID,
FISCAL_QUARTER_ID as QUARTER_ID,
Division_nm,
DISTRICT_ID,
RETAIL_STORE_FACILITY_NBR as STORE_ID,
group_nm,
category_id,
category_nm,
class_id,
class_nm,
subclass_id,
subclass_nm,
MANUF_TYPE_CD AS OWN_BRANDS,
CORP_ITEM_CD as CIC_Code,
upc_dsc,
upc_nbr,
SUM(TOTAL_NET_AMT) AS TOTAL_NET_AMT_TY,
SUM(ITEM_QTY) AS ITEM_QTY_TY,
SUM(COST_OF_GOODS_AMT) AS COST_OF_GOODS_AMT_TY,
SUM(MEASURED_QTY) AS MEASURED_QTY_TY,
SUM(AGP_EXTENDED_AMT) AS AGP_EXTENDED_AMT_TY,
cast (0.00 as decimal (19,1))  AS TOTAL_NET_AMT_LY,
cast (0.00 as decimal (19,1)) as ITEM_QTY_LY,
cast (0.00 as decimal (19,1)) AS COST_OF_GOODS_AMT_LY,
cast (0.00 as decimal (19,1)) AS MEASURED_QTY_LY,
cast (0.00 as decimal (19,1)) AS AGP_EXTENDED_AMT_LY


from
EDM_VIEWS_PRD."DW_VIEWS"."STORE_UPC_AGP" AGP

join "EDM_VIEWS_PRD"."DW_VIEWS"."D1_RETAIL_STORE" LUS
on AGP.FACILITY_INTEGRATION_ID = LUS.FACILITY_INTEGRATION_ID
--AND lus.DIVISION_ID = 5
and CLOSE_DT > current_date
and OPEN_DT < (current_date)-365
and agp.transaction_dt BETWEEN CURRENT_DATE -181 AND CURRENT_DATE-1 --full timeframe
--and agp.transaction_dt = '04/05/2022'

join "EDM_VIEWS_PRD"."DW_EDW_VIEWS"."LU_UPC" UPC
on UPC_NBR = UPC_ID
AND (CATEGORY_ID <9900 OR (CATEGORY_ID IN (9902,9931,9932,9933,9934,9935,9937,9938,9939,9959,9961,9962,9963,9964,9966,9967,9968,9969,9972,9973,9974,9975,9976,9977,9978,9979,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,9995,9996,9997,9998,9999)))
AND upc.DEPARTMENT_ID in (315,329)
AND UPC.CORPORATION_ID = 1

join "EDM_VIEWS_PRD"."DW_VIEWS"."D0_FISCAL_DAY" LDAY
on TRANSACTION_DT = CALENDAR_DT

group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17

union all

select
FISCAL_WEEK_ID + 100 AS week_id,
FISCAL_PERIOD_ID + 100 as PERIOD_ID,
FISCAL_QUARTER_ID + 100 as QUARTER_ID,
Division_nm,
DISTRICT_ID,
RETAIL_STORE_FACILITY_NBR as STORE_ID,
group_nm,
category_id,
category_nm,
class_id,
class_nm,
subclass_id,
subclass_nm,
manuf_type_cd as OWN_BRANDS,
CORP_ITEM_CD as CIC_Code,
upc_dsc,
upc_nbr,
cast (0.00 as decimal (19,1))  AS TOTAL_NET_AMT_TY,
cast (0.00 as decimal (19,1)) as ITEM_QTY_TY,
cast (0.00 as decimal (19,1)) AS COST_OF_GOODS_AMT_TY,
cast (0.00 as decimal (19,1)) AS MEASURED_QTY_TY,
cast (0.00 as decimal (19,1)) AS AGP_EXTENDED_AMT_TY,
SUM(TOTAL_NET_AMT) AS TOTAL_NET_AMT_LY,
SUM(ITEM_QTY) AS ITEM_QTY_LY,
SUM(COST_OF_GOODS_AMT) AS COST_OF_GOODS_AMT_LY,
SUM(MEASURED_QTY) AS MEASURED_QTY_LY,
SUM(AGP_EXTENDED_AMT) AS AGP_EXTENDED_AMT_LY


from
EDM_VIEWS_PRD."DW_VIEWS"."STORE_UPC_AGP" AGP

join "EDM_VIEWS_PRD"."DW_VIEWS"."D1_RETAIL_STORE" LUS
on AGP.FACILITY_INTEGRATION_ID = LUS.FACILITY_INTEGRATION_ID

and CLOSE_DT > current_date
and OPEN_DT < (current_date)-365
and agp.transaction_dt BETWEEN TO_DATE(CURRENT_DATE)-545 AND TO_DATE(CURRENT_DATE)-365 --full timeframe
--and agp.transaction_dt = to_date('2022-04-05')-364

join "EDM_VIEWS_PRD"."DW_EDW_VIEWS"."LU_UPC" UPC
on UPC_NBR = UPC_ID
AND (CATEGORY_ID <9900 OR (CATEGORY_ID IN (9902,9931,9932,9933,9934,9935,9937,9938,9939,9959,9961,9962,9963,9964,9966,9967,9968,9969,9972,9973,9974,9975,9976,9977,9978,9979,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,9995,9996,9997,9998,9999)))
AND upc.DEPARTMENT_ID in (315,329)
AND UPC.CORPORATION_ID = 1

join "EDM_VIEWS_PRD"."DW_VIEWS"."D0_FISCAL_DAY" LDAY
on TRANSACTION_DT = CALENDAR_DT

group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
```

## Store Sales by Quarter Period Department Item

```sql
SELECT
PD.FISCAL_PERIOD_NBR AS PERIOD,         --LU.PERIOD_ID as PERIOD,
PD.FISCAL_QUARTER_NBR AS QUARTER,                  --LU.QUARTER_ID as QUARTER,
STR.DISTRICT_CD AS DISTRICT,            --STR.DISTRICT_CD AS DISTRICT,
STR.RETAIL_STORE_FACILITY_NBR AS STORE,            --STR.STORE_ID AS STORE,
ROG.DEPARTMENT_ID ||' '||ROG.SMIC_GROUP_DSC AS DEPARTMENT,         --ITM.DEPARTMENT_ID ||' '||ITM.DEPARTMENT_NM AS DEPARTMENT,
ROG.CATEGORY_ID||' '||ROG.SMIC_CATEGORY_DSC AS CATEGORY,            --ITM.CATEGORY_ID ||' '|| ITM.CATEGORY_NM AS CATEGORY,
ROG.CLASS_ID||' '||ROG.SMIC_CLASS_DSC AS CLASS,            --ITM.CLASS_ID ||' '|| ITM.CLASS_NM AS CLASS,
TXN.UPC_ID||' '||CI.ITEM_DSC||' - CIC '||CI.CORPORATE_ITEM_CD AS DESCRIPTION,            --ITM.UPC_ID ||' '|| ITM.UPC_DSC ||' - CIC '||ITM.CORP_ITEM_CD AS DESCRIPTION,
SUM(TXN.NET_AMT) AS SALES_TY            --SUM(TXN.NET_AMT) AS SALES_TY

FROM DW_EDW_VIEWS.TXN_FACTS TXN             --FROM DW_DSS.TXN_FACTS TXN
JOIN DW_VIEWS.RETAIL_ORDER_GROUP_UPC_EXTENDED ROG            --JOIN DW_DSS.LU_UPC ITM
ON TXN.UPC_ID = ROG.UPC_NBR            --ON TXN.UPC_ID = ITM.UPC_ID

    JOIN DW_VIEWS.CORPORATE_ITEM CI
    ON  TXN.CORPORATION_ID = CI.CORPORATION_ID
    AND ROG.COMMON_RETAIL_CD = CI.COMMON_RETAIL_CD
    AND CI.CORPORATE_ITEM_CD = ROG.PREFERRED_CORPORATE_ITEM_CD

JOIN DW_VIEWS.D1_RETAIL_STORE STR            --JOIN DW_DSS.LU_STORE_FINANCE_OM STR
ON TXN.STORE_ID = STR.RETAIL_STORE_FACILITY_NBR            --ON TXN.STORE_ID = STR.STORE_ID
AND ROG.ROG_ID = STR.ROG_ID                     -- had to join ROG_ID to prevent overstated numbers

JOIN DW_VIEWS.CALENDAR CAL            --JOIN DW_DSS.LU_DAY_MERGE LU
ON TXN.TXN_DTE = CAL.CALENDAR_DT            --ON TXN.txn_dte = LU.D_DATE

JOIN DW_VIEWS.FISCAL_PERIOD PD
ON CAL.FISCAL_PERIOD_NBR = PD.FISCAL_PERIOD_NBR
AND CAL.FISCAL_YEAR_NBR = PD.FISCAL_YEAR_NBR -- ADDING THIS JOIN IN EDM REDUCES THE OVERSTATEMENT BY HALF VS NOT INCLUDING

WHERE CAL.CALENDAR_DT BETWEEN '04/01/2022' and CURRENT_DATE-1            --WHERE TXN.TXN_DTE BETWEEN '02/28/2021' and CURRENT_DATE-1
AND STR.DIVISION_ID = '32'            --AND STR.OP_AREA_FINANCE_CD = 32 --DIVISION
AND STR.CORPORATION_ID = '001'
AND STR.DIVISION_NM LIKE '%JEWEL%'
AND ROG.DEPARTMENT_ID IN (306,309)            --AND ITM.DEPARTMENT_ID IN (306,309) --DEPARTMENT

AND ROG.DW_CURRENT_VERSION_IND = TRUE
AND STR.DW_LOGICAL_DELETE_IND = FALSE
AND PD.DW_CURRENT_VERSION_IND = TRUE
AND PD.DW_LOGICAL_DELETE_IND = FALSE
AND CAL.DW_CURRENT_VERSION_IND = TRUE
AND CAL.DW_LOGICAL_DELETE_IND = FALSE
AND CI.DW_CURRENT_VERSION_IND = TRUE
AND CI.DW_LOGICAL_DELETE_IND = FALSE
GROUP BY 1,2,3,4,5,6,7,8;
```

## Store UPC Agp

<!-- === "Store UPC Agp" -->

```sql
SELECT
'SUA EDW' AS SRC
,STORE_ID
,UPC_ID
,DAY_DT
,SUM_ITEM_QTY
,SUM_NET_AMT
, AGP_EXT_AMT
FROM EDM_VIEWS_PRD.DW_EDW_VIEWS.store_upc_agp
WHERE STORE_ID = 1467
AND UPC_ID     = 954201519
AND DAY_DT BETWEEN '2021-12-01'::DATE AND '2021-12-28'::DATE
UNION
-- EDM Query:
SELECT
'EDM SUA'           AS SRC
,FACILITY_NBR       AS STORE_ID
,UPC_NBR            AS UPC_ID
,TRANSACTION_DT     AS DAY_DT
,ITEM_QTY           AS SUM_ITEM_QTY
,NET_AMT            AS SUM_NET_AMT
,AGP_EXTENDED_AMT   AS AGP_EXT_AMT
FROM EDM_VIEWS_prd.DW_VIEWS.store_upc_agp agp
INNER JOIN EDM_VIEWS_prd.DW_VIEWS.retail_store str
ON str.FACILITY_INTEGRATION_ID = agp.FACILITY_INTEGRATION_ID
AND str.DW_CURRENT_VERSION_IND = TRUE
WHERE TRANSACTION_DT > '2022-09-08'::DATE - 1000
AND FACILITY_NBR     = 1467
AND UPC_NBR          = 954201519
AND TRANSACTION_DT BETWEEN '2021-12-01'::DATE AND '2021-12-28'::DATE;
```

## Get Unieq Fiscal Periods

```sql
WITH lu_day_merge as
(
  SELECT DISTINCT
  cal.calendar_dt                                 AS d_date,
  fw.fiscal_period_id                             AS period_id
  FROM        edm_views_prd.dw_views.calendar                 AS cal
INNER JOIN  edm_views_prd.dw_views.d0_fiscal_week           AS fw
        ON  cal.fiscal_year_nbr                             =  fw.fiscal_year_nbr
       AND  cal.fiscal_week_nbr                             =  fw.fiscal_week_nbr
WHERE       cal.dw_logical_delete_ind                       =  False
  AND       cal.dw_current_version_ind                      =  True
),
lu_period_merge as
(
  SELECT DISTINCT fiscal_period_id as period_id
  ,fiscal_period_end_dt        AS end_dt
  FROM EDM_VIEWS_PRD.DW_VIEWS.D0_FISCAL_PERIOD
)
select period_id from lu_period_merge where period_id between
    (select period_id
    from lu_day_merge d where d_date = (select max(d_date) as end_date from lu_day_merge where
    period_id = (select max(period_id) as end_period from lu_period_merge
    where end_dt < current_date and end_dt > current_date - 60)) - 500 group by 1)
    and
    (select period_id from lu_day_merge where
    period_id = (select max(period_id) as end_period from lu_period_merge
    where end_dt < current_date and end_dt > current_date - 60) group by 1)
    order by 1 desc
```

## Get Active Items by Vendor

```sql
with cat_id as (5701) , vendor_id as (1026)
SELECT 
  luc.Item_Status_Cd AS corp_status_cd
, SCAT.SMIC_Group_Cd*100+SCAT.SMIC_Category_Cd AS cat_id
, CASE WHEN VITEM.Vendor_UPC_Id > 0   
    AND (luc.Display_Item_Ind = 'Y'
     OR (SCI.ship_unit_pack_type_cd <> '' AND SCI.ship_unit_pack_type_cd IS NOT NULL))
    THEN luc.Vendor_UPC_Id
      ELSE cur.UPC_NBR
    END AS  upc_id
, luc.item_dsc AS  cic_desc          
, luc.CORPORATE_ITEM_CD AS  corp_item_cd
, luc.Ship_Unit_Pack_Qty AS  pack_qty
, cur.SHELF_UNIT_SIZE_DSC AS item_size
, SLS.SMIC_Group_Cd*10000+ SLS.SMIC_Category_Cd*100+SLS.SMIC_Class_Cd AS class_id
, SLS.SMIC_Class_Dsc AS class_name
, wco.VENDOR_UNIT_COST_AMT  AS vend_unit_cost
, vit.Vendor_Id AS vendor_nbr     
, CIGI.common_item_group_cd AS cig
, SCAT.SMIC_Category_Dsc AS cat_name
, luc.Ship_Unit_Pack_Qty AS min_order_qty
, luc.Buyer_Nbr AS buyer_nbr
, CASE WHEN luc.Ship_Unit_Pack_Qty = 1
   THEN 2 -- eaches
     ELSE 1 -- cases
   END AS retail_order

FROM EDM_VIEWS_PRD.DW_VIEWS.Retail_Order_Group_Corporate_item wir
JOIN EDM_VIEWS_PRD.DW_VIEWS.WAREHOUSE luw 
ON luw.WAREHOUSE_ID = wir.WAREHOUSE_ID
AND wir.corporation_id = 1    
AND luw.DW_CURRENT_VERSION_IND = TRUE
AND luw.DW_LOGICAL_DELETE_IND = FALSE
AND WIR.DW_CURRENT_VERSION_IND = TRUE
AND WIR.DW_LOGICAL_DELETE_IND = FALSE
 
JOIN EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM_UPC_ROG_REFERENCE cur 
ON cur.Corporate_Item_Integration_Id = wir.Corporate_Item_Integration_id
AND cur.ROG_ID = wir.Rog_Id
AND current_date BETWEEN to_date(cur.DW_FIRST_EFFECTIVE_DT) AND to_date(cur.DW_LAST_EFFECTIVE_DT)
AND cur.DW_CURRENT_VERSION_IND = TRUE
AND cur.DW_LOGICAL_DELETE_IND = FALSE 
 
INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.Common_Item_Group_Item CIGI
ON CIGI.CORPORATE_ITEM_INTEGRATION_ID = cur.CORPORATE_ITEM_INTEGRATION_ID
AND CIGI.DW_CURRENT_VERSION_IND = TRUE
AND CIGI.DW_LOGICAL_DELETE_IND = FALSE
 
JOIN EDM_VIEWS_PRD.DW_VIEWS.Corporate_Item luc 
ON luc.Corporate_Item_Integration_Id   = wir.Corporate_Item_Integration_id
AND luc.corporation_id = 1
AND luc.DW_CURRENT_VERSION_IND = TRUE
AND luc.DW_LOGICAL_DELETE_IND = FALSE
 
INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SMIC_Category SCAT
ON SCAT.SMIC_Group_Cd = luc.SMIC_Group_Cd
AND SCAT.DW_CURRENT_VERSION_IND = TRUE
AND SCAT.DW_LOGICAL_DELETE_IND = FALSE
AND (SCAT.SMIC_Group_Cd*100+SCAT.SMIC_Category_Cd)= 5705 -- category id

INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.Supply_Chain_Item SCI
ON SCI.CORPORATE_ITEM_INTEGRATION_ID = luc.CORPORATE_ITEM_INTEGRATION_ID
AND SCI.DW_CURRENT_VERSION_IND = TRUE
AND SCI.DW_LOGICAL_DELETE_IND = FALSE

INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.Vendor_item VITEM
ON VITEM.CORPORATE_ITEM_INTEGRATION_ID = luc.CORPORATE_ITEM_INTEGRATION_ID
AND VITEM.WAREHOUSE_ID=SCI.WAREHOUSE_ID
AND VITEM.DW_CURRENT_VERSION_IND = TRUE
AND VITEM.DW_LOGICAL_DELETE_IND = FALSE

INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SMIC_Class SLS
ON SLS.SMIC_Group_Cd = luc.SMIC_Group_Cd
AND SLS.SMIC_CATEGORY_CD= LUC.SMIC_CATEGORY_CD
AND SLS.SMIC_CLASS_CD= LUC.SMIC_CLASS_CD
AND SLS.DW_CURRENT_VERSION_IND = TRUE
AND SLS.DW_LOGICAL_DELETE_IND = FALSE

JOIN EDM_VIEWS_PRD.DW_VIEWS.Supply_Chain_Item scm
ON scm.Warehouse_Id = wir.WAREHOUSE_ID
AND scm.DW_CURRENT_VERSION_IND = TRUE
AND scm.DW_LOGICAL_DELETE_IND = FALSE

JOIN EDM_VIEWS_PRD.DW_VIEWS.Vendor_Item vit 
on vit.CORPORATE_ITEM_INTEGRATION_ID = scm.CORPORATE_ITEM_INTEGRATION_ID
AND vit.DW_CURRENT_VERSION_IND = TRUE
AND vit.DW_LOGICAL_DELETE_IND = FALSE

join EDM_VIEWS_PRD.DW_VIEWS.Corporate_Item ci
on ci.CORPORATE_ITEM_INTEGRATION_ID = vit.CORPORATE_ITEM_INTEGRATION_ID
AND ci.DW_CURRENT_VERSION_IND = TRUE
AND ci.DW_LOGICAL_DELETE_IND = FALSE


JOIN EDM_VIEWS_PRD.DW_VIEWS.WAREHOUSE_COST  wco 
ON wco.WAREHOUSE_ID = wir.WAREHOUSE_ID
 AND wco.CORPORATE_ITEM_INTEGRATION_ID = wir.Corporate_Item_Integration_id
 AND wco.VENDOR_ID = vit.Vendor_Id
 AND try_to_number(vit.Vendor_Id) = 1026 -- vendor id
 AND wco.ACTIVE_VENDOR_IND = 'A'
 AND wco.VENDOR_UNIT_COST_AMT  > 0
 AND wco.DW_CURRENT_VERSION_IND = TRUE

 WHERE  luc.Display_Item_Ind    = 'N' OR luc.Display_Item_Ind    = ''
   OR (luc.Display_Item_Ind = 'Y' -- displayer item
     AND VITEM.Vendor_UPC_Id > 0)
   OR (luc.Display_Item_Ind = 'Y' -- displayer item
     AND VITEM.Vendor_UPC_Id = 0)
     AND scm.SELECTED_ITEM_CD  in ('S', ' ')
       
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16 ORDER BY 12 DESC
```

## Periscope Forecast By Item

```sql  
SELECT WEEK_ID,
CORPORATE_ITEM_CD,
CORPORATE_ITEM_CODE_DSC,
DIVISION_ID, 
ROG_ID,
CASE_SIZE_NBR,
primary_tactic_nm, PRIMARY_TACTIC_DSC,
    COMMON_ITEM_GROUP_ID, substr(VENDOR_PARENT_NM,6) as vend_nm, vehicle_type_txt, round(sum(forecast_unit_nbr),0) as units, 
    round(sum(TOTAL_MARKDOWN_FORECAST_AMT),0) as mkdn, round(sum(TOTAL_MARGIN_FORECAST_EXPENSE_AMT),0) as agp,
    round(sum(total_sale_forecast_amt),0) as sales
From EDM_VIEWS_PRD.DW_VIEWS.PROMO_ROLLUP_RPT rpt
Where 
promotion_week_start_dt between current_date - 10 and current_date + 100
AND CORPORATE_ITEM_CD IN (57500015) and CASE_SIZE_NBR > 0
GROUP BY 1,2,3,4,5,6,7,8,9,10,11
```
## Periscope Actuals By Item / Div

```sql
WITH DIV AS (SELECT 
CASE WHEN DIVISION_NM = 'DENVER' THEN '05'
WHEN DIVISION_NM ='INTERMOUNTAIN' THEN'30'
WHEN DIVISION_NM ='JEWEL' THEN '32'
WHEN DIVISION_NM ='MID-ATLANTIC' THEN '34'
WHEN DIVISION_NM ='NOR CALIFORNIA' THEN '25'
WHEN DIVISION_NM ='PORTLAND' THEN '19'
WHEN DIVISION_NM ='SEATTLE' THEN '27'
WHEN DIVISION_NM ='SHAWS' THEN '33'
WHEN DIVISION_NM ='SO CALIFORNIA' THEN '29'
WHEN DIVISION_NM ='SOUTHERN' THEN '20'
WHEN DIVISION_NM ='SOUTHWEST' THEN '17' 
ELSE '0' END AS DIVISION_ID, 
DIVISION_NM 
FROM EDM_VIEWS_PRD.DW_VIEWS.PROMO_PERF_RPT
GROUP BY 1,2)

SELECT	
	QUARTER_ID
,	FISCAL_QUARTER_ID
,	FISCAL_PERIOD_ID
,	WEEK_ID
,	PROMOTION_WEEK_ID
,	YEAR_ID
,	FISCAL_YEAR_ID
,	BRAND_NM
,	DEPARTMENT_NM
,	DEPARTMENT_ID
,	SUB_DEPARTMENT_ID
,	CATEGORY_NM
,	CATEGORY_ID
,	CLASS_NM
,	CLASS_ID
,	DIV.DIVISION_ID
,	PERF.DIVISION_NM
,	VENDOR_PARENT_NM
,	CORPORATE_ITEM_CD
,	CORPORATE_ITEM_CODE_DSC
,	COMMON_ITEM_GRP_ID
,	OWN_BRAND_STATUS_IND
,	SUM(REG_SALE_AMT) AS GROSS_SALES
,	SUM(TOTAL_NET_SALE_AMT) AS NET_SALES
,	SUM(TOTAL_COST_AMT) AS TOTAL_COST
,	SUM(TOTAL_UNIT_SOLD_AMT) AS TOTAL_UNITS
,	SUM(TOTAL_VENDOR_FUNDING_AMT)AS TOTAL_ALLOWANCES
,	SUM(TOTAL_VENDOR_FUNDING_AMT-NEW_ITEM_ALLOWANCES_AMT) AS TOTAL_ALLOWANCES_EX_NEW_ITEMS
,	SUM(COGS_SALE_AMT) AS COGS
,	SUM(TOTAL_DISCOUNT_AMT) AS MARKDOWN
,	SUM(RETAIL_ALLOW_AMT) AS RETAIL_ALLOWANCES
,	SUM(SHIPPING_ALLOWANCES_AMT) AS SHIPPING_ALLOW_AMT
,	SUM(TRANSACTION_ALLOWANCES_AMT) AS TRANSACTION_ALLOW_AMT
,	SUM(SCAN_ALLOWANCES_AMT) AS SCAN_ALLOW_AMT
,	SUM(DSD_CASE_BILLBACK_AMT) AS DSD_BB_ALLOW_AMT
,	SUM(NEW_ITEM_ALLOWANCES_AMT) AS NI_ALLOW_AMT
,	SUM(FLAT_ALLOWANCES_AMT) AS FLAT_ALLOW_AMT
,	SUM(ALTERNATE_SOURCE_BUYING_ALLOWANCE_AMT) AS ASB_ALLOW_AMT
,	SUM(BUYING_ALLOWANCES_AMT) AS BUYING_ALLOW_AMT
,	SUM(FREIGHT_ALLOWANCES_AMT) AS FREIGHT_ALLOW_AMT
,	SUM(TRADE_DISCOUNT_ALLOWANCE_AMT) AS TRADE_DISC_ALLOW_AMT
,	SUM(OTHER_ALLOWANCE_AMT) OTHER_ALLOW_AMT
,	SUM(SWELL_ALLOWANCE_AMT) AS SWELL_ALLOW_AMT
,	SUM(UNBILLABLE_PRC_AT_COST_AMT) AS UNBILLABLE_PRC_CST
,	SUM(DISTRESS_AT_COST_AMT) AS DISTRESS_CST
,	SUM(AGP_SALE_AMT) AS AGP
	
	FROM EDM_VIEWS_PRD.DW_VIEWS.PROMO_PERF_RPT PERF 
	
	JOIN DIV AS DIV 
	ON DIV.DIVISION_NM = PERF.DIVISION_NM
	
	JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_PROMOTION_CALENDAR_WEEK PWK
	ON PWK.PROMOTION_WEEK_ID = PERF.WEEK_ID 
	AND PWK.DIVISION_ID = DIV.DIVISION_ID 
	

	WHERE WEEK_ID IN (202152)--,20212,20203,20204)--(20203,20204)
	--where week_ID BETWEEN 202149 AND 202208
	
	GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22
```

## Store UPC Agp Sales Profit Vendor Funds 

```sql
WITH CIC AS ( SELECT 
CIURR.CORPORATE_ITEM_INTEGRATION_ID 
,	CIURR.UPC_NBR 
,	CIURR.ROG_ID 
,	CIC.CORPORATE_ITEM_CD 
,	CIURR.SHELF_UNIT_SIZE_DSC

FROM    EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM_UPC_ROG_REFERENCE CIURR 

INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM_UPC_REFERENCE CIUR 
ON	CIUR.UPC_NBR = CIURR.UPC_NBR 
AND	CIUR.CORPORATE_ITEM_INTEGRATION_ID= CIURR.CORPORATE_ITEM_INTEGRATION_ID 
AND	CIUR.DW_CURRENT_VERSION_IND = TRUE 

LEFT JOIN EDM_VIEWS_PRD.DW_VIEWS.CORPORATE_ITEM CIC 
ON CIC.CORPORATE_ITEM_INTEGRATION_ID = CIURR.CORPORATE_ITEM_INTEGRATION_ID 

WHERE   1=1 
AND     CIURR.DW_LOGICAL_DELETE_IND = FALSE  
AND     CIURR.DW_CURRENT_VERSION_IND = TRUE 
AND     CIC.DW_CURRENT_VERSION_IND = 1 
AND     CIC.DW_LOGICAL_DELETE_IND = 0 
      
QUALIFY ROW_NUMBER() OVER (PARTITION BY CIURR.ROG_ID, CIURR.UPC_NBR ORDER BY CIUR.PREFERED_CORPORATE_ITEM_SEQ_NBR ASC) = 1) 

SELECT   PDAY.PROMOTION_WEEK_ID
,	PWK.FISCAL_PERIOD_ID 
,	PWK.FISCAL_QUARTER_ID 
,	RST.DIVISION_ID
,	RST.DIVISION_NM
--,	RST.RETAIL_STORE_FACILITY_NBR
,	UPC.RETAIL_DEPARTMENT_ID
,	UPC.DEPARTMENT_NM
,	UPC.SMIC_CATEGORY_ID
,	UPC.SMIC_CATEGORY_DSC
--,	RST.FACILITY_NBR
--,	cig.COMMON_ITEM_GROUP_CD
,	CIC.CORPORATE_ITEM_CD
,	CIC.SHELF_UNIT_SIZE_DSC
,	AGP.UPC_NBR
,	UPC.ITEM_DSC

,	SUM(AGP.GROSS_AMT - AGP.MARKDOWN_SHORT_TERM_SPECIAL_AMT) AS GROSS_SALES
,	SUM(TOTAL_NET_AMT) AS NET_SALES --GROSS AMT - MARKDOWN AMT - TOTAL WODS - TOTAL PODS
,	SUM(AGP.AVERAGE_COST_EXTENDED_AMT) AS AVERAGE_COST_EXTENDED_AMT  --VENDOR LIST COST
,	SUM(CASE WHEN UPC.SMIC_CATEGORY_ID IN (8843,8643,9996,9902,9931,9932,9933,	
		9934,9935,9937,9938,9939,9952,9956,9970) THEN 0 ELSE ITEM_QTY END) AS UNITS_SOLD	--KPI EXCLUSION CATEGORIES TO REMOVE FROM ITEM COUNT
,	SUM(CASE WHEN UPC.RETAIL_DEPARTMENT_ID IN ('301','303','304','307','314','317','311','328','315','316','336','0','347','339') THEN 0 ELSE MEASURED_QTY END) AS MEASURED_QTY

--Retail Allowances
,	SUM(AGP.SHIPPING_ALLOWANCE_EXTENDED_AMT) AS SHIPPING_ALLOWANCE_EXTENDED_AMT
,	SUM(AGP.SCAN_ALLOWANCE_EXTENDED_AMT+AGP.REDEMPTION_ALLOWANCE_EXTENDED_AMT) AS SCAN_ALLOWANCE_PERF
,	SUM(AGP.RETAIL_DSD_CASE_BILLBACK_ALLOWANCE_AMT) AS RETAIL_DSD_CASE_BILLBACK_ALLOWANCE_AMT	--GENERALLY NO VALUES RETURNED
,	SUM(AGP.RETAIL_NEW_ITEM_ALLOWANCE_AMT) AS RETAIL_NEW_ITEM_ALLOWANCE_AMT
,	SUM(AGP.TOTAL_FLAT_ALLOWANCE_EXTENDED_AMT) AS TOTAL_FLAT_ALLOWANCE_EXTENDED_AMT
,	SUM(AGP.TOTAL_BUYING_ALLOWANCE_EXTENDED_AMT) AS TOTAL_BUYING_ALLOWANCE_EXTENDED_AMT
,	SUM(AGP.TOTAL_FREIGHT_ALLOWANCE_EXTENDED_AMT) AS TOTAL_FREIGHT_ALLOWANCE_EXTENDED_AMT 
,	SUM(TOTAL_OTHER_ALLOWANCE_EXTENDED_AMT) AS TOTAL_OTHER_ALLOWANCE_EXTENDED_AMT 
,	SUM(AVERAGE_TRADE_DISCOUNT_ALLOWANCE_EXTENDED_AMT) AS TRADE_DISCOUNT_ALLOWANCE_EXTENDED_AMT 
,	SUM(AVERAGE_SWELL_LEAKER_ALLOWANCE_EXTENDED_AMT) AS SWELL_LEAKER_ALLOWANCE_EXTENDED_AMT 
,	SUM(UNBILLABLE_PRODUCT_RECOVERY_CENTER_COST_AMT) AS UNBILLABLE_PRODUCT_RECOVERY_CENTER_COST_AMT 
,	SUM(COST_OF_GOODS_AMT) AS COST_OF_GOODS_AMT --Computed Cost of Goods.
,	SUM(AGP_EXTENDED_AMT) AS AGP_EXTENDED_AMT

FROM EDM_VIEWS_PRD.DW_VIEWS.STORE_UPC_AGP AGP

JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE RST
ON AGP.FACILITY_INTEGRATION_ID = RST.FACILITY_INTEGRATION_ID
--AND CLOSE_DT > CURRENT_DATE
--AND OPEN_DT < (CURRENT_DATE)-365

JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC UPC
ON  UPC.UPC_NBR = AGP.UPC_NBR
--AND (UPC.SMIC_CATEGORY_ID <9900 OR (UPC.SMIC_CATEGORY_ID IN (9902,9931,9932,9933,9934,9935,9937,9938,9939,9959,9961,9962,9963,9964,9966,9967,9968,9969,
--9972,9973,9974,9975,9976,9977,9978,9979,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,9995,9996,9997,9998,9999)))
--AND UPC.RETAIL_DEPARTMENT_ID NOT IN ('339','304')
--AND UPC.CORPORATION_ID = '001'
--AND UPC.DW_LOGICAL_DELETE_IND = FALSE
--AND UPC.RETAIL_STATUS_IND ='D'
--AND 1=1
AND UPC.CORPORATION_ID = '001'
AND UPC.SAFEWAY_UPC_IND = 'Y'
    
LEFT JOIN CIC  CIC 
ON CIC.UPC_NBR = AGP.UPC_NBR
AND CIC.ROG_ID = RST.ROG_ID

--JOIN EDM_VIEWS_PRD.DW_VIEWS.D0_FISCAL_DAY LDAY
--on TRANSACTION_DT = CALENDAR_DT
--AND LDAY.FISCAL_QUARTER_ID = 202104

--JOIN EDM_VIEWS_PRD.DW_VIEWS.LU_PROMO_DAY_MERGE_V PDAY  --UPDATE WHEN EDM D1-PROMOTION_CALENDAR_DAY is fixed
--ON AGP.TRANSACTION_DT = PDAY.D_DATE
--AND lpad(PDAY.DIVISION_ID,2,0)= RST.DIVISION_ID

JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_PROMOTION_CALENDAR_DAY PDAY 
ON AGP.TRANSACTION_DT = PDAY. CALENDAR_DT
AND PDAY.DIVISION_ID = RST.DIVISION_ID

JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_PROMOTION_CALENDAR_WEEK PWK 
ON PWK.PROMOTION_WEEK_ID = PDAY.PROMOTION_WEEK_ID 
AND PWK.DIVISION_ID = RST.DIVISION_ID

WHERE RST.DIVISION_ID IN ('05','17','19','20','25','27','29','30','32','33','34')
AND RST.RETAIL_STORE_FACILITY_NBR  NOT IN (1509,1708,339,3197)
AND RST.ROG_ID  NOT IN ('AKBA')
AND PWK.PROMOTION_WEEK_ID = 202152
AND AGP.UPC_NBR <>0
--AND  (UPC.SMIC_CATEGORY_ID <9900 OR (UPC.SMIC_CATEGORY_ID IN (9902,9931,9932,9933,9934,9935,9937,9938,9939,9959,9961,9962,9963,9964,9966,9967,9968,9969,
--9972,9973,9974,9975,9976,9977,9978,9979,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,9995,9996,9997,9998,9999)))
--AND UPC.RETAIL_DEPARTMENT_ID NOT IN ('339','304')
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13
```

## Get Category Name by Vendor 

```sql
select (cat.smic_group_cd * 100 + cat.smic_category_cd)::NUMBER AS CATEGORY_ID, cat.SMIC_CATEGORY_DSC AS CATEGORY_NM
        from EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.UPCFINWK_DEPT_DATA dim
        join EDM_VIEWS_PRD.DW_VIEWS.SMIC_CATEGORY cat on right(dim.CATEGORY_ID, 4) = (cat.smic_group_cd * 100 + cat.smic_category_cd)::VARCHAR
        AND CAT.DW_LOGICAL_DELETE_IND = FALSE AND CAT.DW_CURRENT_VERSION_IND = TRUE
        join EDM_VIEWS_PRD.DW_VIEWS.SMIC_GROUP grp on cat.SMIC_GROUP_CD = grp.SMIC_GROUP_CD
        AND GRP.DW_LOGICAL_DELETE_IND = FALSE AND GRP.DW_CURRENT_VERSION_IND = TRUE
        join EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.finwk_brandcd mfg 
        ON TRIM(MFG.L0) = TRIM(DIM.BRAND_CD)                                
        and grp.SMIC_GROUP_CD = 31 and TRIM(MFG.L3) = 'L3 - PROCTER & GAMBLE'
        group by 1,2 order by 1
```

## Store UPC AGP by Category

```sql
WITH yr AS (
  SELECT start_swy_year_dt AS start_dt FROM OB_MAIN.lu_day_merge AS dte  
  INNER JOIN OB_MAIN.lu_year_merge AS yr ON yr.year_id = dte.year_id 
  WHERE d_date = Current_Date - 7
 ),
dtes AS (
  SELECT d_date FROM OB_MAIN.lu_day_merge
  cross join yr
  WHERE ( d_date  BETWEEN yr.start_dt
                  AND ( SELECT wk.week_end_dt  FROM OB_MAIN.lu_day_merge AS dte 
                        INNER JOIN OB_MAIN.lu_week_merge AS wk ON dte.week_id = wk.week_id 
                        WHERE d_date = Current_Date - 7)
                   -- Year to end of last week
      OR d_date   BETWEEN yr.start_dt - 364
                  AND ( SELECT wk.week_end_dt  -364 FROM OB_MAIN.lu_day_merge AS dte 
                        INNER JOIN OB_MAIN.lu_week_merge AS wk ON dte.week_id = wk.week_id 
                        WHERE d_date = Current_Date - 7)
       )
)
SELECT
    store_id,
    category_id,
    day_dt,
    manuf_type_cd,
    brand_cd,
    Sum(TY_sales)   AS TY_sales,
    Sum(LY_sales)   AS LY_sales,
    Sum(TY_qty)     AS TY_qty,
    Sum(LY_qty)     AS LY_qty,
    Sum(TY_lbs)     AS TY_lbs,
    Sum(LY_lbs)     AS LY_lbs,
    Sum(TY_agp)     AS TY_agp,
    Sum(LY_agp)     AS LY_agp
FROM (
    SELECT 
        ret.facility_nbr AS store_id,
        upc.category_id, 
        CASE WHEN sua.transaction_dt >= yr.start_dt  THEN sua.transaction_dt   ELSE sua.transaction_dt + 364 END  AS day_dt, 
        CASE WHEN upc.manuf_type_cd = 'H' THEN 'H' ELSE 'N' END AS manuf_type_cd,
        CASE WHEN upc.manuf_type_cd = 'H' THEN upc.brand_cd ELSE NULL END AS brand_cd,
        Sum( CASE WHEN sua.transaction_dt >= yr.start_dt    THEN sua.TOTAL_NET_AMT  ELSE 0.0 END ) AS TY_sales,
        Sum( CASE WHEN sua.transaction_dt <  yr.start_dt    THEN sua.TOTAL_NET_AMT  ELSE 0.0 END ) AS LY_sales,
        Sum( CASE WHEN sua.transaction_dt >= yr.start_dt    THEN sua.ITEM_QTY       ELSE 0.0 END ) AS TY_qty,
        Sum( CASE WHEN sua.transaction_dt <  yr.start_dt    THEN sua.ITEM_QTY       ELSE 0.0 END ) AS LY_qty,
        Sum( CASE WHEN sua.transaction_dt >= yr.start_dt    THEN sua.MEASURED_QTY   ELSE 0.0 END ) AS TY_lbs,
        Sum( CASE WHEN sua.transaction_dt <  yr.start_dt    THEN sua.MEASURED_QTY   ELSE 0.0 END ) AS LY_lbs,
        Sum( CASE WHEN sua.transaction_dt >= yr.start_dt    THEN sua.AGP_EXTENDED_AMT    ELSE 0.0 END ) AS TY_agp,
        Sum( CASE WHEN sua.transaction_dt <  yr.start_dt    THEN sua.AGP_EXTENDED_AMT    ELSE 0.0 END ) AS LY_agp
    FROM EDM_VIEWS_PRD.DW_VIEWS.store_upc_agp AS sua
    INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.retail_store AS ret 
    ON ret.FACILITY_INTEGRATION_ID = sua.FACILITY_INTEGRATION_ID
    AND ret.DW_CURRENT_VERSION_IND = TRUE 
    AND ret.DW_LOGICAL_DELETE_IND  = FALSE
    AND ret.CORPORATION_ID = 1
    INNER JOIN OB_MAIN.lu_upc AS upc
            ON upc.upc_id = sua.upc_nbr
    CROSS JOIN  yr
    WHERE  sua.transaction_dt IN ( SELECT d_date FROM dtes )
            AND upc.group_id <> 99
            AND RET.FACILITY_NBR < 9999
    GROUP BY 1,2,3,4,5

UNION ALL
	
    SELECT   -- Haggen Last Year
        agp.store_id,
        Coalesce(upc1.category_id, -1) AS category_id,
        agp.day_dt + 364 AS day_dt,
        CASE WHEN  ob.upc_id IS NOT NULL    OR	( upc.upc_id IS NOT NULL AND UPC.GROUP_ID <> 99 AND UPC.MANUF_TYPE_CD = 'H' ) 
             THEN 'H' ELSE 'N'
        END AS manuf_type_cd,
        CASE WHEN upc.manuf_type_cd = 'H' THEN upc.brand_cd ELSE NULL END AS brand_cd,
        0::NUMBER(18,4)         						AS TY_sales,
        Sum ( agp.sum_net_amt )							AS LY_sales,
        0::NUMBER(18,4)         	 					AS TY_Units,
        Sum ( agp.sum_item_qty )						AS LY_Units,
        0::NUMBER(18,4)         	                    AS TY_lbs,
        Sum ( agp.sum_meas_qty )   						AS LY_lbs,
        0::NUMBER(18,4)         						AS TY_GP,
        Sum ( agp.sum_net_amt - agp.cost_of_goods_amt )	AS LY_GP
    FROM EDM_VIEWS_PRD.DW_VIEWS.hgn_store_upc_agp AS agp 
    INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.hgn_upc_swy_hier_full AS upc1     ON upc1.hgn_upc_id = agp.hgn_upc_id     
    LEFT JOIN OB_MAIN.haggen_ob_upcs AS ob              ON ob.upc_id = agp.upc_id
    LEFT JOIN OB_MAIN.lu_upc AS upc                     ON upc.upc_id = agp.upc_id
    CROSS JOIN  yr
    WHERE agp.day_dt IN ( SELECT d_date FROM dtes )
    GROUP BY 1,2,3,4,5
) AS Q
GROUP BY 1,2,3,4,5;
```

## Random weight meat cost 

```sql
WITH YPC AS (
    SELECT
    DISTINCT
        PRM.DIVISION_ID
    ,   PRM.WAREHOUSE_ID
    ,   PRM.CORPORATE_ITEM_CD AS PRIMAL_CIC
    ,   DIV0 ( SUM ( CASE WHEN BASE_CORPORATE_ITEM_CD IN ( 88290059 , 88290061 , 88100217 , 88290060 , 880200497 , 880200259 , 88100109 )
                          THEN 0 - YIELD_PCT 
                          ELSE YIELD_PCT END ) , 100 ) AS PRIMAL_YIELD_ADJUSTMENT_PCT 
                         // when the driver is a non primary code or direct loss (ground beef, stew meat, cube steak, bone, fat, or yield loss)
                         // that driver's yield % is subtracted from the yield of the true driver
    FROM EDM_VIEWS_PRD.DW_VIEWS.PRIMAL_MEAT_ITEM_YIELD PRM
    JOIN EDM_VIEWS_PRD.DW_VIEWS.BASE_MEAT_ITEM_YIELD DRV
      ON PRM.DIVISION_ID = DRV.DIVISION_ID
     AND PRM.WAREHOUSE_ID = DRV.WAREHOUSE_ID
     AND PRM.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID = DRV.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID
     AND PRM.YIELD_CHART_NBR = DRV.YIELD_CHART_NBR
     AND PRM.DIVISION_ID = 27
     AND PRM.YIELD_CHART_NBR = 1
     AND PRM.DW_CURRENT_VERSION_IND = TRUE
     AND PRM.DW_LOGICAL_DELETE_IND = FALSE
     AND DRV.DW_CURRENT_VERSION_IND = TRUE
     AND DRV.DW_LOGICAL_DELETE_IND = FALSE 
    GROUP BY 1 , 2 , 3 
) , YDO AS (
    SELECT 
    DISTINCT
        YPD.DIVISION_ID
    ,   OPT.ROG_ID
    ,   YPD.DRIVER_CIC
    ,   YPD.DRIVER_DSC
    ,   OPT.OPTIONAL_CORPORATE_ITEM_CD
    ,   OPT.OPTIONAL_ITEM_DSC
    ,   CASE WHEN YPD.DRIVER_CIC IN ( 88290059 , 88290061 , 88100217 , 88290060 , 880200497 , 880200259 , 88100109 ) 
             THEN DIV0 ( SUM ( YPD.DRIVER_TOTAL_SHIPPED_COST ) , SUM ( YPD.DRIVER_POUNDS_SHIPPED ) )
             ELSE DIV0 ( SUM ( YPD.DRIVER_TOTAL_SHIPPED_COST ) , SUM ( YPD.DRIVER_POUNDS_SHIPPED ) ) * AVG ( 2 - YPD.PRIMAL_YIELD_ADJUSTMENT_PCT )
             END AS YIELD_ADJUSTED_COST
     FROM (
        SELECT 
        DISTINCT 
            YCH.DIVISION_ID
        ,   YCH.WAREHOUSE_ID
        ,   YCH.PRIMAL_CIC
        ,   YCH.PRIMAL_ITEM_DSC
        ,   YCH.DRIVER_CIC
        ,   YCH.DRIVER_DSC
        ,   YPC.PRIMAL_YIELD_ADJUSTMENT_PCT
        ,   YCH.YIELD_PCT
        ,   SUM ( SID.SHIPPED_QTY * SID.DETAIL_CHARGES_CHARGE2_AMT ) * YCH.YIELD_PCT AS DRIVER_TOTAL_SHIPPED_COST
        ,   SUM ( SID.CASE_WGT ) * YCH.YIELD_PCT AS DRIVER_POUNDS_SHIPPED
        FROM ( 
            SELECT
            DISTINCT
                PRM.DIVISION_ID
            ,   PRM.WAREHOUSE_ID
            ,   PRM.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID
            ,   PRM.CORPORATE_ITEM_CD AS PRIMAL_CIC
            ,   PRM.PRIMAL_ITEM_DSC
            ,   DRV.BASE_CORPORATE_ITEM_INTEGRATION_ID
            ,   CASE WHEN DRV.BASE_CORPORATE_ITEM_CD = 88100109 THEN 88100217 ELSE DRV.BASE_CORPORATE_ITEM_CD END AS DRIVER_CIC
            ,   DRV.BASE_ITEM_DSC AS DRIVER_DSC
            ,   DIV0 ( CASE WHEN PRM.CORPORATE_ITEM_CD NOT  IN ( 88290059 , 88290061 , 88100217 , 88290060 , 880200497 , 880200259 , 88100109 ) 
                            THEN CASE WHEN DRV.YIELD_PCT = 0 THEN 1 ELSE DRV.YIELD_PCT END END , 100 ) AS YIELD_PCT // the raw yield percent for all drivers is kept to provide driver costs for ground beef etc
            FROM EDM_VIEWS_PRD.DW_VIEWS.PRIMAL_MEAT_ITEM_YIELD PRM
            JOIN EDM_VIEWS_PRD.DW_VIEWS.BASE_MEAT_ITEM_YIELD DRV
              ON PRM.DIVISION_ID = DRV.DIVISION_ID
             AND PRM.WAREHOUSE_ID = DRV.WAREHOUSE_ID
             AND PRM.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID = DRV.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID
             AND PRM.YIELD_CHART_NBR = DRV.YIELD_CHART_NBR
             AND PRM.YIELD_CHART_NBR = 1
             AND PRM.DIVISION_ID = 27
             AND PRM.DW_CURRENT_VERSION_IND = TRUE
             AND PRM.DW_LOGICAL_DELETE_IND = FALSE
             AND DRV.DW_CURRENT_VERSION_IND = TRUE
             AND DRV.DW_LOGICAL_DELETE_IND = FALSE 
        ) YCH
        JOIN EDM_VIEWS_PRD.DW_VIEWS.SUPPLY_CHAIN_INVOICE_HEADER SIH
          ON YCH.WAREHOUSE_ID = SIH.WAREHOUSE_ID
         AND YCH.DIVISION_ID = SIH.DIVISION_ID
        INNER
        JOIN EDM_VIEWS_PRD.DW_VIEWS.SUPPLY_CHAIN_INVOICE_DETAIL SID
          ON SIH.SUPPLY_CHAIN_INVOICE_INTEGRATION_ID = SID.SUPPLY_CHAIN_INVOICE_INTEGRATION_ID
         AND YCH.PRIMAL_CORPORATE_ITEM_INTEGRATION_ID = SID.CORPORATE_ITEM_INTEGRATION_ID
         AND SIH.DW_FIRST_EFFECTIVE_DT = SID.DW_FIRST_EFFECTIVE_DT
         AND SIH.DW_LAST_EFFECTIVE_DT = SID.DW_LAST_EFFECTIVE_DT
         AND SIH.DW_LOGICAL_DELETE_IND = FALSE
         AND SIH.DW_CURRENT_VERSION_IND = TRUE
         AND SID.DW_LOGICAL_DELETE_IND = FALSE
         AND SID.DW_CURRENT_VERSION_IND = TRUE
         AND SIH.CORPORATION_ID = 1
         AND SIH.REQUESTED_DELIVERY_DT BETWEEN CURRENT_DATE - 28 AND CURRENT_DATE
        JOIN YPC
          ON YCH.DIVISION_ID = YPC.DIVISION_ID
         AND YCH.WAREHOUSE_ID = YPC.WAREHOUSE_ID
         AND YCH.PRIMAL_CIC = YPC.PRIMAL_CIC
         AND SIH.WAREHOUSE_ID = YPC.WAREHOUSE_ID
         AND SIH.DIVISION_ID = YPC.DIVISION_ID
        GROUP BY 1 , 2 , 3 , 4 , 5 , 6 , 7 , 8 
    ) YPD
    JOIN EDM_VIEWS_PRD.DW_VIEWS.OPTIONAL_MEAT_ITEM_YIELD OPT
      ON YPD.DIVISION_ID = OPT.DIVISION_ID
     AND YPD.WAREHOUSE_ID = OPT.WAREHOUSE_ID
     AND YPD.PRIMAL_CIC = OPT.CORPORATE_ITEM_CD
     AND YPD.DRIVER_CIC = OPT.BASE_CORPORATE_ITEM_CD
     AND OPT.DW_CURRENT_VERSION_IND = TRUE
     AND OPT.DW_LOGICAL_DELETE_IND = FALSE
    WHERE ROG_ID NOT IN ( 'SHGN' )
    GROUP BY 1 , 2 , 3 , 4 , 5 , 6 
)
SELECT 
DISTINCT
    AGG.DIVISION_ID
,   AGG.ROG_ID
,   AGG.CORPORATE_ITEM_CD
,   AGG.ITEM_DSC
,   AGG.YIELD_ADJUSTED_COST
FROM ( 
    SELECT 
    DISTINCT 
        YDO.DIVISION_ID
    ,   YDO.ROG_ID
    ,   YDO.DRIVER_CIC AS CORPORATE_ITEM_CD
    ,   YDO.DRIVER_DSC AS ITEM_DSC
    ,   MAX ( YDO.YIELD_ADJUSTED_COST ) AS YIELD_ADJUSTED_COST
    FROM YDO
    GROUP BY 1 , 2 , 3 , 4
    UNION ALL
    SELECT DISTINCT 
        YDO.DIVISION_ID
    ,   YDO.ROG_ID
    ,   YDO.OPTIONAL_CORPORATE_ITEM_CD AS CORPORATE_ITEM_CD
    ,   YDO.OPTIONAL_ITEM_DSC AS ITEM_DSC
    ,   MAX ( YDO.YIELD_ADJUSTED_COST ) AS YIELD_ADJUSTED_COST
    FROM YDO
    GROUP BY 1 , 2 , 3 , 4
) AGG
ORDER BY 1 , 2 , 3
```
## Planogram Schematic Fixture 
``` sql
SELECT 
POG.Planogram_Nm,
UPC.SMIC_CATEGORY_ID,
UPC.SMIC_CATEGORY_DSC,
FXTR.SHELF_SURFACE_CD

 FROM 
EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_SLOT_ITEM ITEM
join EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM POG
on ITEM.PLANOGRAM_ID = POG.PLANOGRAM_ID
join EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_STORE_FIXTURE STORE
on ITEM.PLANOGRAM_ID = STORE.PLANOGRAM_ID
join EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_FIXTURE_SHELF FXTR
on  POG.PLANOGRAM_ID = FXTR.PLANOGRAM_ID
join EDM_VIEWS_PRD.DW_VIEWS.D1_UPC UPC
on  UPC.UPC_NBR = ITEM.UPC_NBR
join EDM_VIEWS_PRD.DW_VIEWS.FACILITY STR
on STR.FACILITY_INTEGRATION_ID = STORE.FACILITY_INTEGRATION_ID
WHERE
 STR.CLOSE_DT > CURRENT_DATE 
 AND STORE.STORE_SCHEMATIC_EFFECTIVE_END_DT  > CURRENT_DATE
 AND ITEM.DW_CURRENT_VERSION_IND = TRUE  
 AND POG.DW_CURRENT_VERSION_IND = TRUE
 AND STORE.DW_CURRENT_VERSION_IND = TRUE
 AND FXTR.DW_CURRENT_VERSION_IND = TRUE
 AND ITEM.DW_LOGICAL_DELETE_IND = FALSE
 AND POG.DW_LOGICAL_DELETE_IND = FALSE
  AND STORE.DW_LOGICAL_DELETE_IND = FALSE
  AND FXTR.DW_LOGICAL_DELETE_IND = FALSE
 AND STR.DW_CURRENT_VERSION_IND = TRUE
 AND STR.DW_LOGICAL_DELETE_IND = FALSE
 AND STR.CORPORATION_ID ='001'
 AND FACILITY_TYPE_CD ='RT'
AND FXTR. SHELF_SURFACE_CD LIKE 'Pegboard'
AND UPC.UPC_NBR = ITEM.UPC_NBR
AND UPC.CORPORATION_ID = 1
AND UPC.SMIC_CATEGORY_ID IN ('3001','3004','3002')

GROUP BY 1,2,3,4;
```

## Distribution voids
``` sql
SELECT
DIVISION_NM,
BANNER_NM,
TB.UPC_NBR,
TB.DESCRIPTION,
CATEGORY_NM,
TB.STORE_ID,
Sum(DISTRIBUTION) AS DISTRIBUTION,
Sum(SALES) AS SALES,
Sum(SHIPPED) AS SHIPPED,
Sum(TAG_QTY) AS TAG_QTY

FROM

(SELECT 
DIVISION_NM,
TB3.BANNER_NM, 
TB3.UPC_NBR,
DESCRIPTION,
CATEGORY_NM,
TB3.STORE_ID,
Sum(DISTRIBUTION) AS DISTRIBUTION,
Sum(SALES) AS SALES,
Sum(SHIPPED) AS SHIPPED,
Sum(TAG.TAG_NBR) AS TAG_QTY

FROM 
(SELECT 
DIVISION_NM,
BANNER_NM, 
UPC_NBR,
DESCRIPTION,
CATEGORY_NM,
STORE_ID,
FACILITY_INTEGRATION_ID,
Sum(DISTRIBUTION) AS DISTRIBUTION,
Sum(SALES) AS SALES,
Sum(SHIPPED) AS SHIPPED

FROM (
SELECT 
TB.DIVISION_NM,
TB.BANNER_nm,
TB.UPC_nbr,
TB.DESCRIPTION,
TB.CATEGORY_NM,
TB.STORE_ID,
TB.FACILITY_INTEGRATION_ID,
Sum(TB.DIST) AS DISTRIBUTION,
Sum(TB.SALES_QTY) AS SALES,
Sum(SHIPPED) AS SHIPPED
FROM 
(
SELECT 
STR.DIVISION_NM, 
STR.BANNER_NM, 
ITEM.UPC_NBR, 
DEPT.DESCRIPTION,
DEPT.CATEGORY_NM,
STR.RETAIL_STORE_FACILITY_NBR AS STORE_ID,
STR.FACILITY_INTEGRATION_ID,
Cast(1 AS DECIMAL (19,1)) AS DIST,
Cast(0.00 AS DECIMAL (19,1)) AS SALES_QTY,
Cast(0.00 AS DECIMAL (19,1)) AS SHIPPED
FROM 
EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_SLOT_ITEM ITEM, 
EDM_VIEWS_PRD.DW_VIEWS.Planogram POG, 
EDM_VIEWS_PRD.DW_VIEWS.PLANOGRAM_STORE_FIXTURE STORE,
EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE STR,
EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.UPCFINWK_DEPT_DATA DEPT
WHERE
ITEM.PLANOGRAM_ID = POG.PLANOGRAM_ID
and item.DW_CURRENT_VERSION_IND =TRUE
AND POG.DW_CURRENT_VERSION_IND =TRUE
and item.DW_LOGICAL_DELETE_IND =TRUE
AND POG.DW_LOGICAL_DELETE_IND =TRUE
AND ITEM.PLANOGRAM_ID = STORE.PLANOGRAM_ID 
AND STR.FACILITY_INTEGRATION_ID = STORE.FACILITY_INTEGRATION_ID 
AND STORE.DW_CURRENT_VERSION_IND =TRUE
AND STORE.DW_LOGICAL_DELETE_IND =TRUE
--AND STR.DIVISION_ID = 29
AND STR.CLOSE_DT > Current_Date 
AND STORE.STORE_SCHEMATIC_EFFECTIVE_END_DT  > Current_Date
AND ITEM.UPC_NBR = DEPT.UPC_NBR
AND DEPT.CATEGORY_ID NOT LIKE 'OC%' 
AND Substr(UPC_NM,1,1)<> 'O'
AND  DEPT.UPC_NBR IN (19067900008,
19067900002,
19067900018,
19067900001,
19067900012,
19067900011) 
GROUP BY 1,2,3,4,5,6,7

UNION ALL 

SELECT	
STR.DIVISION_NM,
STR.BANNER_nm,
Abs(SALES.UPC_NBR) AS UPC_NBR,
DEPT.DESCRIPTION,
DEPT.CATEGORY_NM,
STR.RETAIL_STORE_FACILITY_NBR AS STORE_ID,
STR.FACILITY_INTEGRATION_ID,
Cast(0.00 AS DECIMAL (19,1)) AS DIST,
Sum(ITEM_QTY) AS SALES_QTY,
SUM(SALES.WHSE_SHIPPED_UNIT_QTY) + SUM(SALES.BDR_SHIPPED_UNIT_QTY) AS SHIPPED
FROM EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.STRFINWK_DATA_COMBINED SALES
JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_RETAIL_STORE STR
	ON	SALES.Facility_nbr = STR.RETAIL_STORE_FACILITY_NBR 
	AND	STR.CLOSE_DT > Current_Date
	--AND	STR.DIVESTED_FLAG IN ('N')
	--AND STR.DIVISION_ID = 29
	AND	FISCAL_WEEK_ID IN (SELECT (FISCAL_YEAR_NBR||LPAD(FISCAL_WEEK_NBR,2,0)) AS WEEK_ID FROM EDM_VIEWS_PRD.DW_VIEWS.Calendar
                           WHERE calendar_dt between Current_Date - 180 and Current_Date  AND DW_LOGICAL_DELETE_IND =FALSE AND DW_CURRENT_VERSION_IND =TRUE group by 1)
	JOIN EDM_VIEWS_PRD.DW_BIZOPS_VIEWS.UPCFINWK_DEPT_DATA DEPT
ON SALES.UPC_NBR = DEPT.UPC_NBR
AND DEPT.CATEGORY_ID NOT LIKE 'OC%' 
WHERE Substr(UPC_NM,1,1)<> 'O'
AND  DEPT.UPC_NBR IN (19067900008,
19067900002,
19067900018,
19067900001,
19067900012,
19067900011) 

GROUP BY 1,2,3,4,5,6,7)TB 

GROUP BY 1,2,3,4,5,6,7)TB2

GROUP BY 1,2,3,4,5,6,7)TB3


JOIN EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE_ITEM_LOCATION TAG
ON TAG.UPC_NBR = TB3.UPC_NBR AND TAG.FACILITY_INTEGRATION_ID=TB3.FACILITY_INTEGRATION_ID
 AND TAG.DW_LOGICAL_DELETE_IND =FALSE AND TAG.DW_CURRENT_VERSION_IND =TRUE


GROUP BY 1,2,3,4,5,6)TB
--WHERE TB.DIVISION_NM = 'ACME' 

GROUP BY 1,2,3,4,5,6;
```

## Sales with Household and customer data penetration
  
  ```sql
  SELECT
TB.UPC_ID as upc
,TB.ITEM_DSC as upc_dsc
,TB.SMIC_CATEGORY_ID as category_id
,TB.DIVISION_NM as div
,TB.WEEK_ID as week_id
,SUM(TB.TOTAL_NET_SALES_TY) AS total_sales_ty
,SUM(TB.TOTAL_NET_SALES_LY) AS total_sales_ly
,SUM(TB.ITEM_QTY_TY) AS total_qty_ty
,SUM(TB.ITEM_QTY_LY) AS total_qty_ly
,SUM(TB.BASKETS_TY) AS total_baskets_ty
,SUM(TB.BASKETS_LY) AS total_baskets_ly
,SUM(TB.HOUSEHOLDS_TY) AS total_households_ty
,SUM(TB.HOUSEHOLDS_LY) AS total_households_ly
,SUM(TB.EBG_NET_SALES_TY) AS ebg_net_sales_ty
,SUM(TB.EBG_NET_SALES_LY) AS ebg_net_sales_ly
,SUM(TB.EBG_ITEM_QTY_TY) AS ebg_qty_ty
,SUM(TB.EBG_ITEM_QTY_LY) AS ebg_qty_ly
,SUM(TB.EBG_BASKETS_TY) AS ebg_baskets_ty
,SUM(TB.EBG_BASKETS_LY) AS ebg_baskets_ly
,SUM(TB.EBG_HOUSEHOLDS_TY) AS ebg_households_ty
,SUM(TB.EBG_HOUSEHOLDS_LY) AS ebg_households_ly

FROM(
(SELECT 
       T1.UPC_ID
	  ,T1.ITEM_DSC
	  ,T1.SMIC_CATEGORY_ID
	  ,T1.DIVISION_NM
      ,T1.WEEK_ID
	  ,T1.TOTAL_NET_SALES AS TOTAL_NET_SALES_TY
      ,CAST(0.00 AS DECIMAL (19,1))  AS TOTAL_NET_SALES_LY
	  ,T1.ITEM_QTY AS ITEM_QTY_TY
      ,CAST(0.00 AS DECIMAL (19,1))  AS ITEM_QTY_LY
	  ,T1.BASKETS AS BASKETS_TY
      ,CAST(0.00 AS DECIMAL (19,1))  AS BASKETS_LY
	  ,T1.HOUSEHOLDS AS HOUSEHOLDS_TY
      ,CAST(0.00 AS DECIMAL (19,1))  AS HOUSEHOLDS_LY
      ,T2.EBG_NET_SALES AS EBG_NET_SALES_TY
      ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_NET_SALES_LY
      ,T2.EBG_ITEM_QTY AS EBG_ITEM_QTY_TY
      ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_ITEM_QTY_LY
      ,T2.EBG_BASKETS AS EBG_BASKETS_TY
      ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_BASKETS_LY
      ,T2.EBG_HOUSEHOLDS AS EBG_HOUSEHOLDS_TY
      ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_HOUSEHOLDS_LY
FROM (SELECT A.UPC_ID
            ,E.ITEM_DSC
            ,E.SMIC_CATEGORY_ID
            ,D.DIVISION_NM
            ,WEEK.WEEK_ID
            ,CAST(SUM(A.NET_AMT + A.MKDN_WOD_ALLOC_AMT + A.MKDN_POD_ALLOC_AMT) AS DECIMAL(18, 4)) AS TOTAL_NET_SALES
            ,CAST(SUM(ITEM_QTY) AS DECIMAL(18, 4)) AS ITEM_QTY
            ,COUNT(DISTINCT TXN_ID) AS BASKETS
            ,COUNT(DISTINCT CARD_NBR) AS HOUSEHOLDS
      FROM  (select * from EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_FACTS where txn_dte > '2022-01-01') A
            ,EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE C
	       ,EDM_VIEWS_PRD.DW_VIEWS.DIVISION D 
            ,EDM_VIEWS_PRD.DW_VIEWS.D1_UPC E
            ,EDM_VIEWS_PRD.DW_EDW_VIEWS.LIFESTYLE_SAME_STR_DAY same
            ,EDM_SANDBOX_PRD.CORE_TECH.ZHU_COMP_WEEK week
            ,EDM_VIEWS_PRD.DW_VIEWS.Calendar merge
      WHERE  E.UPC_NBR = A.UPC_ID
        AND  A.UPC_ID IN  (7940046281,7940046279,7940046273,7940046272,7940046271,2279691752,2279691751,2279691671,2279691670,2279691612,2279691611,2279691602,2279691601,2279691432,2279691431,2279691015,2279691014,2279691006,2279691005,2279690092,2279690090,8087817207,8087804238,8087817205,8087817206,8087804219,8087804235,8087804222,8087804225,8087800899,8087800406,8087804216,8087800218,8087817125,8087817126)
        AND  merge.CALENDAR_DT = A.txn_dte
         AND A.STORE_ID = C.FACILITY_NBR 
	     AND c.DW_CURRENT_VERSION_IND =TRUE AND c.DW_LOGICAL_DELETE_IND =FALSE
	     AND c.CORPORATION_ID='001'
		 AND  D.DIVISION_ID=C.DIVISION_ID
           AND D.DW_CURRENT_VERSION_IND =TRUE AND D.DW_LOGICAL_DELETE_IND =FALSE
        AND  same.store_id = A.store_id
        AND  same.txn_dt = A.txn_dte and same_store_ind = 'Y'
        AND  week.current_week_id = (merge.FISCAL_YEAR_NBR ||LPAD(merge.Fiscal_Week_Nbr,2,0)) 
		and merge.DW_CURRENT_VERSION_IND =TRUE and MERGE.DW_LOGICAL_DELETE_IND =FALSE   
		and current_week_id >= 202001 and data_refresh_dt < current_date


        AND  E.CORPORATION_ID = 1
        AND  A.MISC_ITEM_QTY = 0
        AND  A.DEPOSIT_ITEM_QTY = 0
        AND  C.DIVISION_ID IN (5,15,17,19,20,23,29,30,32,33,34,35,25,27)
        AND  A.REV_DTL_SUBTYPE_ID IN (0, 7)
      GROUP BY 1,2,3,4,5
      ) AS T1
 
      LEFT JOIN
      (SELECT A.UPC_ID
             ,E.ITEM_DSC
             ,E.SMIC_CATEGORY_ID
             ,D.DIVISION_NM
             ,week.WEEK_ID
             ,CAST(SUM(A.NET_AMT + A.MKDN_WOD_ALLOC_AMT + A.MKDN_POD_ALLOC_AMT) AS DECIMAL(18, 4)) AS EBG_NET_SALES
             ,CAST(SUM(ITEM_QTY) AS DECIMAL(18, 4)) AS EBG_ITEM_QTY
             ,COUNT(DISTINCT TXN_ID) AS EBG_BASKETS
             ,COUNT(DISTINCT A.CARD_NBR) AS EBG_HOUSEHOLDS
       FROM   (select * from EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_FACTS where txn_dte > '2022-01-01') A
       INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE C  ON A.STORE_ID = C.FACILITY_NBR 
	   AND c.DW_CURRENT_VERSION_IND =TRUE AND c.DW_LOGICAL_DELETE_IND =FALSE
	    AND c.CORPORATION_ID='001'
	   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.DIVISION D 
          ON D.DIVISION_ID=C.DIVISION_ID
        AND D.DW_CURRENT_VERSION_IND =TRUE AND D.DW_LOGICAL_DELETE_IND =FALSE
       INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC E ON E.UPC_NBR = A.UPC_ID AND E.CORPORATION_ID = 1
       INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SMV_LOYALTY_PROGRAM_RETAIL_CUSTOMER_HOUSEHOLD F ON A.CARD_NBR = F.LOYALTY_PROGRAM_CARD_NBR
                 
          AND A.MISC_ITEM_QTY = 0
          AND A.DEPOSIT_ITEM_QTY = 0
       AND  A.UPC_ID IN  (7940046281,7940046279,7940046273,7940046272,7940046271,2279691752,2279691751,2279691671,2279691670,2279691612,2279691611,2279691602,2279691601,2279691432,2279691431,2279691015,2279691014,2279691006,2279691005,2279690092,2279690090,8087817207,8087804238,8087817205,8087817206,8087804219,8087804235,8087804222,8087804225,8087800899,8087800406,8087804216,8087800218,8087817125,8087817126)
       JOIN EDM_VIEWS_PRD.DW_VIEWS.Calendar merge on merge.CALENDAR_DT = A.txn_dte JOIN EDM_SANDBOX_PRD.CORE_TECH.ZHU_COMP_WEEK week on week.current_week_id =   (merge.FISCAL_YEAR_NBR ||LPAD(merge.Fiscal_Week_Nbr,2,0)) and merge.DW_CURRENT_VERSION_IND =TRUE and MERGE.DW_LOGICAL_DELETE_IND =FALSE   and current_week_id >= 202001 and data_refresh_dt < current_date
       JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.LIFESTYLE_SAME_STR_DAY same on same.store_id = A.store_id AND  same.txn_dt = A.txn_dte and same_store_ind = 'Y'
       LEFT JOIN (SELECT HOUSEHOLD_ID
                        ,ANNUAL_LEVEL2_SEGMENT_ID
                        ,WEEK_ID
                        ,CASE WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (1) THEN 'ELITE'
                              WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (2) THEN 'BEST'
                              WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (3, 4) THEN 'GOOD'
                              WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (5, 6) THEN 'OCCASIONAL'
                              ELSE 'UNKNOWN'
                              END AS FACTS_SEG_DESC
                  FROM EDM_VIEWS_PRD.DW_EDW_VIEWS.FACTS_SEGMENT_WEEK
                  GROUP BY 1, 2, 3, 4
        ) AS FACTS ON FACTS.HOUSEHOLD_ID = F.HOUSEHOLD_ID AND FACTS.WEEK_ID = current_week_id
          
          AND A.REV_DTL_SUBTYPE_ID IN (0, 7)
          AND FACTS.ANNUAL_LEVEL2_SEGMENT_ID IN (1,2,3,4)
        GROUP BY 1,2,3,4,5
        ) AS T2

ON T1.UPC_ID = T2.UPC_ID
AND T1.DIVISION_NM = T2.DIVISION_NM AND T1.WEEK_ID = T2.WEEK_ID)

UNION ALL


(SELECT T1.UPC_ID
	  ,T1.ITEM_DSC
	  ,T1.SMIC_CATEGORY_ID
	  ,T1.DIVISION_NM
      ,T1.WEEK_ID
      ,CAST(0.00 AS DECIMAL (19,1))  AS TOTAL_NET_SALES_TY
	  ,T1.TOTAL_NET_SALES AS TOTAL_NET_SALES_LY
      ,CAST(0.00 AS DECIMAL (19,1))  AS ITEM_QTY_TY
	  ,T1.ITEM_QTY AS ITEM_QTY_LY
      ,CAST(0.00 AS DECIMAL (19,1))  AS BASKETS_TY
	  ,T1.BASKETS AS BASKETS_LY
      ,CAST(0.00 AS DECIMAL (19,1))  AS HOUSEHOLDS_TY
	  ,T1.HOUSEHOLDS AS HOUSEHOLDS_LY
      ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_NET_SALES_TY
      ,T2.EBG_NET_SALES AS EBG_NET_SALES_LY
      ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_ITEM_QTY_TY
      ,T2.EBG_ITEM_QTY AS EBG_ITEM_QTY_LY
      ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_BASKETS_TY
      ,T2.EBG_BASKETS AS EBG_BASKETS_LY
      ,CAST(0.00 AS DECIMAL (19,1))  AS EBG_HOUSEHOLDS_TY
      ,T2.EBG_HOUSEHOLDS AS EBG_HOUSEHOLDS_LY
FROM (SELECT A.UPC_ID
            ,E.ITEM_DSC
            ,E.SMIC_CATEGORY_ID
            ,D.DIVISION_NM
            ,WEEK.WEEK_ID
            ,CAST(SUM(A.NET_AMT + A.MKDN_WOD_ALLOC_AMT + A.MKDN_POD_ALLOC_AMT) AS DECIMAL(18, 4)) AS TOTAL_NET_SALES
            ,CAST(SUM(ITEM_QTY) AS DECIMAL(18, 4)) AS ITEM_QTY
            ,COUNT(DISTINCT TXN_ID) AS BASKETS
            ,COUNT(DISTINCT CARD_NBR) AS HOUSEHOLDS
      FROM   (select * from EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_FACTS where txn_dte > '2022-01-01') A
            , EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE C  
			 , EDM_VIEWS_PRD.DW_VIEWS.DIVISION D 
            ,EDM_VIEWS_PRD.DW_VIEWS.D1_UPC E
            ,EDM_VIEWS_PRD.DW_EDW_VIEWS.LIFESTYLE_SAME_STR_DAY same
            ,EDM_SANDBOX_PRD.CORE_TECH.ZHU_COMP_WEEK week
            ,EDM_VIEWS_PRD.DW_VIEWS.Calendar merge
      WHERE  E.UPC_NBR = A.UPC_ID
        AND  A.UPC_ID IN  (7940046281,7940046279,7940046273,7940046272,7940046271,2279691752,2279691751,2279691671,2279691670,2279691612,2279691611,2279691602,2279691601,2279691432,2279691431,2279691015,2279691014,2279691006,2279691005,2279690092,2279690090,8087817207,8087804238,8087817205,8087817206,8087804219,8087804235,8087804222,8087804225,8087800899,8087800406,8087804216,8087800218,8087817125,8087817126)
        AND  merge.CALENDAR_DT = A.txn_dte
        AND   A.STORE_ID = C.FACILITY_NBR 
	   AND c.DW_CURRENT_VERSION_IND =TRUE AND c.DW_LOGICAL_DELETE_IND =FALSE
	    AND c.CORPORATION_ID='001'
		AND D.DIVISION_ID=C.DIVISION_ID
        AND D.DW_CURRENT_VERSION_IND =TRUE AND D.DW_LOGICAL_DELETE_IND =FALSE 
        AND  same.store_id = A.store_id
        AND  same.txn_dt = A.txn_dte and same_store_ind = 'Y'
        AND  week.comp_week_id = (merge.FISCAL_YEAR_NBR ||LPAD(merge.Fiscal_Week_Nbr,2,0)) and merge.DW_CURRENT_VERSION_IND =TRUE and MERGE.DW_LOGICAL_DELETE_IND =FALSE  and current_week_id >= 202001 and data_refresh_dt < current_date

        AND  E.CORPORATION_ID = 1
        AND  A.MISC_ITEM_QTY = 0
        AND  A.DEPOSIT_ITEM_QTY = 0
        AND  C.DIVISION_ID IN (5,15,17,19,20,23,29,30,32,33,34,35,25,27)
        AND  A.REV_DTL_SUBTYPE_ID IN (0, 7)
      GROUP BY 1,2,3,4,5
      ) AS T1
 
      LEFT JOIN
      (SELECT A.UPC_ID
             ,E.ITEM_DSC
             ,E.SMIC_CATEGORY_ID
             ,D.DIVISION_NM
             ,WEEK.WEEK_ID
             ,CAST(SUM(A.NET_AMT + A.MKDN_WOD_ALLOC_AMT + A.MKDN_POD_ALLOC_AMT) AS DECIMAL(18, 4)) AS EBG_NET_SALES
             ,CAST(SUM(ITEM_QTY) AS DECIMAL(18, 4)) AS EBG_ITEM_QTY
             ,COUNT(DISTINCT TXN_ID) AS EBG_BASKETS
             ,COUNT(DISTINCT A.CARD_NBR) AS EBG_HOUSEHOLDS
       FROM   (select * from EDM_VIEWS_PRD.DW_EDW_VIEWS.TXN_FACTS where txn_dte > '2022-01-01') A
       INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.RETAIL_STORE C  ON A.STORE_ID = C.FACILITY_NBR 
	   AND c.DW_CURRENT_VERSION_IND =TRUE AND c.DW_LOGICAL_DELETE_IND =FALSE
	    AND c.CORPORATION_ID='001'
	   INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.DIVISION D 
          ON D.DIVISION_ID=C.DIVISION_ID
        AND D.DW_CURRENT_VERSION_IND =TRUE AND D.DW_LOGICAL_DELETE_IND =FALSE
       INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.D1_UPC E ON E.UPC_NBR = A.UPC_ID AND E.CORPORATION_ID = 1
       INNER JOIN EDM_VIEWS_PRD.DW_VIEWS.SMV_LOYALTY_PROGRAM_RETAIL_CUSTOMER_HOUSEHOLD F ON A.CARD_NBR = F.LOYALTY_PROGRAM_CARD_NBR     
          AND A.MISC_ITEM_QTY = 0
          AND A.DEPOSIT_ITEM_QTY = 0
       AND  A.UPC_ID IN  (7940046281,7940046279,7940046273,7940046272,7940046271,2279691752,2279691751,2279691671,2279691670,2279691612,2279691611,2279691602,2279691601,2279691432,2279691431,2279691015,2279691014,2279691006,2279691005,2279690092,2279690090,8087817207,8087804238,8087817205,8087817206,8087804219,8087804235,8087804222,8087804225,8087800899,8087800406,8087804216,8087800218,8087817125,8087817126)
       JOIN EDM_VIEWS_PRD.DW_VIEWS.Calendar merge on merge.CALENDAR_DT = A.txn_dte JOIN EDM_SANDBOX_PRD.CORE_TECH.ZHU_COMP_WEEK week on  week.comp_week_id = (merge.FISCAL_YEAR_NBR ||LPAD(merge.Fiscal_Week_Nbr,2,0)) and merge.DW_CURRENT_VERSION_IND =TRUE and MERGE.DW_LOGICAL_DELETE_IND =FALSE  and current_week_id >= 202001 and data_refresh_dt < current_date
       JOIN EDM_VIEWS_PRD.DW_EDW_VIEWS.LIFESTYLE_SAME_STR_DAY same on same.store_id = A.store_id AND  same.txn_dt = A.txn_dte and same_store_ind = 'Y'
       LEFT JOIN (SELECT HOUSEHOLD_ID
                        ,ANNUAL_LEVEL2_SEGMENT_ID
                        ,WEEK_ID
                        ,CASE WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (1) THEN 'ELITE'
                              WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (2) THEN 'BEST'
                              WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (3, 4) THEN 'GOOD'
                              WHEN ANNUAL_LEVEL2_SEGMENT_ID IN (5, 6) THEN 'OCCASIONAL'
                              ELSE 'UNKNOWN'
                              END AS FACTS_SEG_DESC
                  FROM EDM_VIEWS_PRD.DW_EDW_VIEWS.FACTS_SEGMENT_WEEK
                  GROUP BY 1, 2, 3, 4
        ) AS FACTS ON FACTS.HOUSEHOLD_ID = F.HOUSEHOLD_ID AND FACTS.WEEK_ID = comp_week_id
          
          AND A.REV_DTL_SUBTYPE_ID IN (0, 7)
          AND FACTS.ANNUAL_LEVEL2_SEGMENT_ID IN (1,2,3,4)
        GROUP BY 1,2,3,4,5
        ) AS T2

ON T1.UPC_ID = T2.UPC_ID
AND T1.DIVISION_NM = T2.DIVISION_NM AND T1.WEEK_ID = T2.WEEK_ID) ) TB

GROUP BY 1,2,3,4,5

```



[admonitions]: admonitions.md
